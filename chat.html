<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bravo Chat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }
    header button {
      background: #25D366;
      border: none;
      padding: 6px 12px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    #userList {
      width: 30%;
      overflow-y: auto;
      padding: 10px;
      border-right: 1px solid #ccc;
    }
    #userList input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #userList button {
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0f7fa;
    }
    #userList button.group {
      background: #dcedc8;
      font-weight: bold;
    }
    .unread-badge {
      background: red;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      float: right;
      margin-top: -15px;
    }
    #chatWindow {
      display: none;
      flex-direction: column;
      flex: 1;
      height: 100%;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease;
      opacity: 0;
      transform: translateX(100%);
    }
    #chatWindow.active {
      opacity: 1;
      transform: translateX(0);
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
    }
    .msg {
      padding: 8px;
      margin: 6px;
      border-radius: 7px;
      max-width: 70%;
      position: relative;
      word-wrap: break-word;
      animation: slideIn 0.3s ease forwards;
    }
    .you {
      background: #dcf8c6;
      align-self: flex-end;
      text-align: right;
    }
    .them {
      background: white;
      align-self: flex-start;
    }
    .msg-time {
      font-size: 10px;
      color: #999;
      margin-top: 4px;
    }
    #sendBar {
      display: flex;
      padding: 10px;
      background: white;
    }
    #sendBar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    #sendBar button {
      margin-left: 5px;
      padding: 8px 14px;
      background: #25D366;
      border: none;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
    #typingIndicator {
      padding-left: 12px;
      font-style: italic;
      font-size: 12px;
      color: gray;
      display: none;
    }
    #msgMenu {
      display: none;
      position: absolute;
      background: white;
      border: 2px solid #888;
      border-radius: 10px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      min-width: 240px;
      font-size: 17px;
      padding: 10px;
    }
    #msgMenu button {
      width: 100%;
      border: none;
      padding: 16px 20px;
      background: white;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #msgMenu button:last-child {
      border-bottom: none;
    }
    #msgMenu button:hover {
      background: #f2f2f2;
    }
    #floatingDate {
      position: sticky;
      top: 0;
      background: #f0f0f0;
      text-align: center;
      font-size: 13px;
      color: gray;
      z-index: 10;
      padding: 4px 0;
    }
    .date-label {
      text-align: center;
      color: gray;
      font-size: 12px;
      margin: 10px 0 5px;
    }
    @media (max-width: 600px) {
      #userList {
        width: 100%;
      }
      #chatWindow {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: white;
        z-index: 100;
      }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Welcome</div>
    <button onclick="goToDashboard()">Dashboard</button>
  </header>
  <div style="display: flex; height: calc(100% - 50px);">
    <div id="userList">
      <input id="searchBox" placeholder="Search users/groups..." />
      <button onclick="createGroup()">Create Group</button>
      <div id="recentChats"><h4>Recent Chats</h4></div>
      <div id="userSection"><h4>All Users</h4></div>
      <div id="groupSection"><h4>All Groups</h4></div>
    </div>
    <div id="chatWindow">
      <div style="padding: 10px; background: #128C7E; color: white; display: flex; justify-content: space-between;">
        <span id="chatWith">---</span>
        <div>
          <button onclick="closeChat()">âœ–</button>
        </div>
      </div>
      <div id="typingIndicator">Typing...</div>
      <div id="messages">
        <div id="floatingDate"></div>
      </div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type message..." />
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>
  <div id="chatTitleMenu" style="display:none; position:absolute; background:white; border:1px solid #ccc; padding:10px; border-radius:6px; z-index:99999;"></div>
  <div id="msgMenu" class="msg-menu" style="display:none;"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // ðŸ” Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ðŸ‘¤ Get current user from session
    let user = sessionStorage.getItem('username');
    if (!user) location.href = "index.html";
    document.getElementById("currentUser").textContent = "Welcome, " + user;

    // App State
    let currentChat = "", convoRef = null, typingRef = null;
    let lastRenderedDate = "";
    let allUsers = {}, allGroups = {}, unreadCount = {}, replyingTo = null;
    let recentChats = {};

    const msgBox = document.getElementById("msgInput");
    const messagesDiv = document.getElementById("messages");

    // Get recent chats from DB
    db.ref("recentChats/" + user).once("value", snap => {
      recentChats = snap.val() || {};
      refreshList();
    });

    // Load all users
    db.ref("users").on("value", snap => {
      allUsers = snap.val() || {};
      refreshList();
    });

    // Load all groups
    db.ref("groups").on("value", snap => {
      allGroups = snap.val() || {};
      refreshList();
    });

    // ðŸ”„ Refresh chat list (users, groups, recent)
    function refreshList() {
      const term = document.getElementById("searchBox").value.toLowerCase();
      const recent = document.getElementById("recentChats");
      const users = document.getElementById("userSection");
      const groups = document.getElementById("groupSection");

      recent.innerHTML = "<h4>Recent Chats</h4>";
      users.innerHTML = "<h4>All Users</h4>";
      groups.innerHTML = "<h4>All Groups</h4>";

      // Recent chats
      const sortedRecent = Object.entries(recentChats).sort((a, b) => b[1] - a[1]);
      sortedRecent.forEach(([id]) => {
        const isGroup = id.startsWith("group_");
        const label = isGroup ? allGroups[id.slice(6)]?.name || "Group" : id;
        if (!label.toLowerCase().includes(term)) return;
        const btn = document.createElement("button");
        btn.innerHTML = `${label} ${unreadCount[id] ? '<span class="unread-badge">' + unreadCount[id] + '</span>' : ''}`;
        btn.onclick = () => {
          closeChat();
          setTimeout(() => {
            isGroup ? openGroup(id.slice(6), label) : openChat(id);
          }, 300);
        };
        recent.appendChild(btn);
      });

      // All users
      Object.entries(allUsers).forEach(([u, info]) => {
        const match = [u, info?.email, info?.phone].some(field => (field || "").toLowerCase().includes(term));
        if (u !== user && match) {
          const btn = document.createElement("button");
          btn.innerHTML = `${u} <small style='color:gray'>${formatLastSeen(info.lastSeen)}</small>`;
          btn.onclick = () => {
            closeChat();
            setTimeout(() => openChat(u), 300);
          };
          users.appendChild(btn);
        }
      });

      // All groups
      Object.entries(allGroups).forEach(([id, g]) => {
        if (!g?.name?.toLowerCase().includes(term)) return;
        const btn = document.createElement("button");
        btn.className = "group";
        btn.innerHTML = `${g.public ? "# " : "ðŸ”’ "}${g.name}`;
        btn.onclick = () => {
          closeChat();
          setTimeout(() => attemptJoinGroup(id, g.name, g.public), 300);
        };
        groups.appendChild(btn);
      });
    }

    document.getElementById("searchBox").addEventListener("input", refreshList);

    // Create group (prompt for name and type)
    function createGroup() {
      const name = prompt("Enter group name:");
      if (!name) return;
      const isPublic = confirm("Make group public?");
      let password = null;
      if (!isPublic) password = prompt("Set group password:");

      const id = db.ref("groups").push().key;
      db.ref("groups/" + id).set({
        name,
        public: isPublic,
        password: isPublic ? null : password,
        createdBy: user,
        members: { [user]: true }
      });
    }

    function attemptJoinGroup(id, name, isPublic) {
      if (!isPublic) {
        const pwd = prompt("Enter group password:");
        if (pwd !== allGroups[id]?.password) {
          alert("Wrong password");
          return;
        }
      }
      db.ref("groups/" + id + "/members/" + user).set(true);
      openGroup(id, name);
    }

    function goToDashboard() {
      location.href = "app.html";
    }

    function chatId(a, b) {
      return [a, b].sort().join("_");
    }

    function formatLastSeen(ts) {
      if (!ts || isNaN(ts)) return 'Offline';
      const d = new Date(ts);
      if (isNaN(d.getTime())) return "Unknown";
      const today = new Date();
      const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      return d.toDateString() === today.toDateString() ? `Today at ${time}` : `${d.toLocaleDateString()} at ${time}`;
    }

    function formatDateLabel(date) {
      const today = new Date();
      const yesterday = new Date(Date.now() - 86400000);
      if (date.toDateString() === today.toDateString()) return "Today";
      if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
      return date.toLocaleDateString();
    }

    function closeChat() {
      const chatWindow = document.getElementById("chatWindow");
      chatWindow.classList.remove("active");
      setTimeout(() => {
        chatWindow.style.display = "none";
        messagesDiv.innerHTML = "";
        currentChat = "";
        if (convoRef) convoRef.off();
        if (typingRef) typingRef.off();
      }, 300);
    }
    function openChat(toUser) {
      currentChat = toUser;
      const seen = formatLastSeen(allUsers[toUser]?.lastSeen);
      document.getElementById("chatWith").innerHTML =
        `${toUser} <small style='font-size:11px;'>(${seen})</small>`;

      const chatWindow = document.getElementById("chatWindow");
      chatWindow.classList.add("active");
      chatWindow.style.display = "flex";
      messagesDiv.innerHTML = "";
      lastRenderedDate = "";

      if (convoRef) convoRef.off();
      if (typingRef) typingRef.off();

      const id = chatId(user, toUser);
      convoRef = db.ref("chats/" + id);
      convoRef.on("child_added", snap => renderMessage(snap.key, snap.val(), false, id));
      convoRef.on("child_changed", snap => updateMessageUI(snap.key, snap.val(), false, id));

      typingRef = db.ref(`typing/${id}/${toUser}`);
      typingRef.on("value", snap => {
        document.getElementById("typingIndicator").style.display = snap.val() ? "block" : "none";
      });

      recentChats[currentChat] = Date.now();
      db.ref("recentChats/" + user).set(recentChats);
      unreadCount[toUser] = 0;

      db.ref("seen/" + id + "/" + user).set(firebase.database.ServerValue.TIMESTAMP);
    }

    function openGroup(id, name) {
      currentChat = "group_" + id;
      document.getElementById("chatWith").textContent = name;

      const chatWindow = document.getElementById("chatWindow");
      chatWindow.classList.add("active");
      chatWindow.style.display = "flex";
      messagesDiv.innerHTML = "";
      lastRenderedDate = "";

      if (convoRef) convoRef.off();

      convoRef = db.ref("groupChats/" + id);
      convoRef.on("child_added", snap => renderMessage(snap.key, snap.val(), true, id));
      convoRef.on("child_changed", snap => updateMessageUI(snap.key, snap.val(), true, id));

      recentChats[currentChat] = Date.now();
      db.ref("recentChats/" + user).set(recentChats);
      unreadCount["group_" + id] = 0;
    }

    msgBox.addEventListener("input", () => {
      if (!currentChat || currentChat.startsWith("group_")) return;
      const id = chatId(user, currentChat);
      db.ref("typing/" + id + "/" + user).set(true);
      setTimeout(() => db.ref("typing/" + id + "/" + user).set(false), 1500);
    });

    function sendMsg() {
      const text = msgBox.value.trim();
      if (!text) return;
      const ts = Date.now();

      const msg = {
        from: user,
        text,
        ts
      };

      if (replyingTo) {
        msg.replyTo = replyingTo;
        replyingTo = null;
      }

      if (currentChat.startsWith("group_")) {
        const groupId = currentChat.slice(6);
        db.ref("groupChats/" + groupId).push(msg);
      } else {
        const id = chatId(user, currentChat);
        db.ref("chats/" + id).push(msg).then(snap => {
          const msgKey = snap.key;
          db.ref("chats/" + id + "/" + msgKey + "/deliveredTo/" + currentChat).set(true);
        });
      }

      msgBox.value = "";
    }

    function renderMessage(id, msg, isGroup = false, groupId = "") {
      if (!msg || msg.deletedFor?.[user]) return;
      const msgDate = new Date(msg.ts);
      const msgDateStr = msgDate.toDateString();

      if (msgDateStr !== lastRenderedDate) {
        const label = document.createElement("div");
        label.className = "date-label";
        label.textContent = formatDateLabel(msgDate);
        messagesDiv.appendChild(label);
        lastRenderedDate = msgDateStr;
      }

      const div = document.createElement("div");
      div.className = "msg " + (msg.from === user ? "you" : "them");

      let inner = "";
      if (msg.deleted) {
        inner = "<i>This message was deleted</i>";
      } else {
        if (msg.replyTo) {
          inner += `<div style="font-size:12px;color:gray;border-left:3px solid #ccc;padding-left:5px">
            <b>${msg.replyTo.from}</b>: ${msg.replyTo.text}</div>`;
        }
        if (isGroup && msg.from !== user) inner += `<b>${msg.from}:</b> `;
        inner += msg.text;
      }

      const ts = new Date(msg.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const status = msg.from === user
        ? (msg.readBy?.[currentChat] ? "âœ“âœ“âœ“" : msg.deliveredTo?.[currentChat] ? "âœ“âœ“" : "âœ“")
        : "";

      inner += `<div class="msg-time">${ts}<span class="msg-status">${status}</span></div>`;
      div.innerHTML = inner;

      div.dataset.id = id;
      div.dataset.ts = msg.ts;
      div.dataset.from = msg.from;
      div.dataset.text = msg.text;

      // Right-click menu
      div.addEventListener("contextmenu", e => {
        e.preventDefault();
        showMsgOptions(id, msg, isGroup, groupId, div, e.pageX, e.pageY);
      });

      // Swipe to reply
      let swipeTarget = null;
      div.addEventListener("touchstart", e => {
        swipeTarget = e.target.closest(".msg");
        if (swipeTarget) swipeTarget.startX = e.touches[0].clientX;
      });

      div.addEventListener("touchend", e => {
        if (!swipeTarget) return;
        const endX = e.changedTouches[0].clientX;
        if (endX - swipeTarget.startX > 80) {
          swipeTarget.style.borderLeft = "4px solid #25D366";
          replyingTo = {
            from: swipeTarget.dataset.from,
            text: swipeTarget.dataset.text,
            ts: swipeTarget.dataset.ts
          };
        }
        swipeTarget = null;
      });

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      // Mark as read
      if (msg.from !== user && !msg.readBy?.[user]) {
        const ref = isGroup
          ? db.ref("groupChats/" + groupId + "/" + id + "/readBy/" + user)
          : db.ref("chats/" + chatId(user, currentChat) + "/" + id + "/readBy/" + user);
        ref.set(true);
      }
    }
    function showMsgOptions(id, msg, isGroup, groupId, div, x, y) {
      const menu = document.getElementById("msgMenu");
      menu.innerHTML = "";

      const canEditOrDelete = msg.from === user && Date.now() - msg.ts <= 60000;

      if (canEditOrDelete) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit Message";
        editBtn.onclick = () => {
          const newText = prompt("Edit message:", msg.text);
          if (newText && newText.trim()) {
            const path = isGroup
              ? `groupChats/${groupId}/${id}/text`
              : `chats/${chatId(user, currentChat)}/${id}/text`;
            db.ref(path).set(newText.trim());
          }
          menu.style.display = "none";
        };
        menu.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete for Everyone";
        delBtn.onclick = () => {
          const path = isGroup
            ? `groupChats/${groupId}/${id}/deleted`
            : `chats/${chatId(user, currentChat)}/${id}/deleted`;
          db.ref(path).set(true);
          menu.style.display = "none";
        };
        menu.appendChild(delBtn);
      } else {
        const delSelfBtn = document.createElement("button");
        delSelfBtn.textContent = "Delete for Me";
        delSelfBtn.onclick = () => {
          const path = isGroup
            ? `groupChats/${groupId}/${id}/deletedFor/${user}`
            : `chats/${chatId(user, currentChat)}/${id}/deletedFor/${user}`;
          db.ref(path).set(true);
          menu.style.display = "none";
        };
        menu.appendChild(delSelfBtn);
      }

      const replyBtn = document.createElement("button");
      replyBtn.textContent = "Reply";
      replyBtn.onclick = () => {
        replyingTo = {
          from: msg.from,
          text: msg.text,
          ts: msg.ts
        };
        menu.style.display = "none";
      };
      menu.appendChild(replyBtn);

      menu.style.left = x + "px";
      menu.style.top = y + "px";
      menu.style.display = "block";
    }

    function updateMessageUI(id, msg, isGroup, groupId) {
      const msgEl = [...messagesDiv.querySelectorAll(".msg")]
        .find(el => el.dataset.id === id);
      if (!msgEl) return;

      if (msg.deleted || msg.deletedFor?.[user]) {
        msgEl.innerHTML = "<i>This message was deleted</i>";
        return;
      }

      let inner = "";
      if (msg.replyTo) {
        inner += `<div style="font-size:12px;color:gray;border-left:3px solid #ccc;padding-left:5px">
          <b>${msg.replyTo.from}</b>: ${msg.replyTo.text}</div>`;
      }
      if (isGroup && msg.from !== user) inner += `<b>${msg.from}:</b> `;
      inner += msg.text;

      const ts = new Date(msg.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const status = msg.from === user
        ? (msg.readBy?.[currentChat] ? "âœ“âœ“âœ“" : msg.deliveredTo?.[currentChat] ? "âœ“âœ“" : "âœ“")
        : "";

      inner += `<div class="msg-time">${ts}<span class="msg-status">${status}</span></div>`;
      msgEl.innerHTML = inner;
    }

    function formatDateLabel(date) {
      const today = new Date();
      const yesterday = new Date(Date.now() - 86400000);
      if (date.toDateString() === today.toDateString()) return "Today";
      if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
      return date.toLocaleDateString();
    }

    document.addEventListener("click", e => {
      const menu = document.getElementById("msgMenu");
      const chatTitleMenu = document.getElementById("chatTitleMenu");
      if (!e.target.closest("#msgMenu")) menu.style.display = "none";
      if (!e.target.closest("#chatTitleMenu")) chatTitleMenu.style.display = "none";
    });

    document.getElementById("chatWith").onclick = e => {
      const menu = document.getElementById("chatTitleMenu");
      menu.innerHTML = "";
      const isGroup = currentChat.startsWith("group_");

      if (isGroup) {
        const leaveBtn = document.createElement("button");
        leaveBtn.textContent = "Leave Group";
        leaveBtn.onclick = () => {
          const id = currentChat.slice(6);
          db.ref("groups/" + id + "/members/" + user).remove();
          closeChat();
        };
        const membersBtn = document.createElement("button");
        membersBtn.textContent = "View Members";
        membersBtn.onclick = () => {
          const id = currentChat.slice(6);
          db.ref("groups/" + id + "/members").once("value", snap => {
            const members = Object.keys(snap.val() || {}).join("\n");
            alert("Group Members:\n" + members);
          });
        };
        menu.appendChild(leaveBtn);
        menu.appendChild(membersBtn);
      } else {
        const blockBtn = document.createElement("button");
        blockBtn.textContent = "Block User";
        blockBtn.onclick = () => {
          alert("Coming soon: Block functionality.");
        };
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete Chat";
        deleteBtn.onclick = () => {
          const id = chatId(user, currentChat);
          db.ref("chats/" + id).remove();
          closeChat();
        };
        menu.appendChild(deleteBtn);
        menu.appendChild(blockBtn);
      }

      menu.style.left = e.pageX + "px";
      menu.style.top = e.pageY + "px";
      menu.style.display = "block";
    }
  </script>
  <script>
    // ðŸ§¹ Clean up Firebase listeners on unload
    window.addEventListener("beforeunload", () => {
      if (convoRef) convoRef.off();
      if (typingRef) typingRef.off();
    });

    // ðŸ” Search filter (case-insensitive and by username/email/phone/group name)
    document.getElementById("searchBox").addEventListener("input", refreshList);

    function matchesSearch(obj, term) {
      if (!obj) return false;
      const values = Object.values(obj).map(v => (v || "").toString().toLowerCase());
      return values.some(val => val.includes(term));
    }

    function refreshList() {
      const term = document.getElementById("searchBox").value.toLowerCase();
      const recent = document.getElementById("recentChats");
      const users = document.getElementById("userSection");
      const groups = document.getElementById("groupSection");

      recent.innerHTML = "<h4>Recent Chats</h4>";
      users.innerHTML = "<h4>All Users</h4>";
      groups.innerHTML = "<h4>All Groups</h4>";

      // Recent
      const sortedRecent = Object.entries(recentChats).sort((a, b) => b[1] - a[1]);
      sortedRecent.forEach(([id]) => {
        const isGroup = id.startsWith("group_");
        const label = isGroup ? allGroups[id.slice(6)]?.name || "Group" : id;
        const userObj = allUsers[id];
        const match = term === "" || (isGroup ? label.toLowerCase().includes(term) : matchesSearch(userObj, term));

        if (!match) return;

        const btn = document.createElement("button");
        const status = isGroup ? "" : `<small style='color:gray'>${formatLastSeen(allUsers[id]?.lastSeen)}</small>`;
        btn.innerHTML = `${label} ${status} ${unreadCount[id] ? '<span class="unread-badge">' + unreadCount[id] + '</span>' : ''}`;
        btn.onclick = () => {
          closeChat();
          setTimeout(() => {
            isGroup ? openGroup(id.slice(6), label) : openChat(id);
          }, 310);
        };
        recent.appendChild(btn);
      });

      // Users
      Object.entries(allUsers)
        .filter(([u, data]) => u !== user && matchesSearch({ username: u, ...data }, term))
        .sort()
        .forEach(([u, data]) => {
          const btn = document.createElement("button");
          const lastSeen = formatLastSeen(data.lastSeen);
          btn.innerHTML = `${u} <small style='color:gray'>${lastSeen}</small>`;
          btn.onclick = () => {
            closeChat();
            setTimeout(() => openChat(u), 310);
          };
          users.appendChild(btn);
        });

      // Groups
      Object.entries(allGroups)
        .filter(([id, g]) => g?.name?.toLowerCase().includes(term))
        .sort((a, b) => a[1].name.localeCompare(b[1].name))
        .forEach(([id, g]) => {
          const btn = document.createElement("button");
          btn.className = "group";
          btn.innerHTML = `${g.public ? "# " : "ðŸ”’ "}${g.name}`;
          btn.onclick = () => {
            closeChat();
            if (!g.members?.[user]) {
              if (g.public) {
                attemptJoinGroup(id, g.name);
              } else {
                const pwd = prompt("This group is private. Enter password:");
                if (pwd === g.password) attemptJoinGroup(id, g.name);
                else alert("Incorrect password.");
              }
            } else {
              setTimeout(() => openGroup(id, g.name), 310);
            }
          };
          groups.appendChild(btn);
        });
    }

    // ðŸ•’ Track unread messages
    function trackUnreadMessages() {
      db.ref("chats").on("child_added", snap => {
        if (!snap.key.includes(user)) return;
        db.ref("chats/" + snap.key).on("child_added", msgSnap => {
          const msg = msgSnap.val();
          const otherUser = snap.key.replace(user + "_", "").replace("_" + user, "");
          if (msg.from !== user && !msg.readBy?.[user]) {
            unreadCount[otherUser] = (unreadCount[otherUser] || 0) + 1;
            refreshList();
          }
        });
      });

      db.ref("groupChats").on("child_added", snap => {
        db.ref("groupChats/" + snap.key).on("child_added", msgSnap => {
          const msg = msgSnap.val();
          const groupKey = "group_" + snap.key;
          if (msg.from !== user && !msg.readBy?.[user]) {
            unreadCount[groupKey] = (unreadCount[groupKey] || 0) + 1;
            refreshList();
          }
        });
      });
    }

    // ðŸŸ¢ Initial last seen update
    function updateLastSeen() {
      db.ref("users/" + user + "/lastSeen").set(firebase.database.ServerValue.TIMESTAMP);
    }
    updateLastSeen();
    setInterval(updateLastSeen, 15000);
  </script>
</body>
</html>
