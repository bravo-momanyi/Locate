<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bravo Chat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }
    header button {
      background: #25D366;
      border: none;
      padding: 6px 12px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    #userList {
      width: 30%;
      overflow-y: auto;
      padding: 10px;
      border-right: 1px solid #ccc;
    }
    #userList input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #userList button {
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0f7fa;
    }
    #userList button.group {
      background: #dcedc8;
      font-weight: bold;
    }
    .unread-badge {
      background: red;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      float: right;
      margin-top: -15px;
    }
    #chatWindow {
      display: none;
      flex-direction: column;
      flex: 1;
      height: 100%;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease;
      opacity: 0;
      transform: translateX(100%);
    }
    #chatWindow.active {
      opacity: 1;
      transform: translateX(0);
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
    }
    .msg {
      padding: 8px;
      margin: 6px;
      border-radius: 7px;
      max-width: 70%;
      position: relative;
      word-wrap: break-word;
      animation: slideIn 0.3s ease forwards;
    }
    .you {
      background: #dcf8c6;
      align-self: flex-end;
      text-align: right;
    }
    .them {
      background: white;
      align-self: flex-start;
    }
    .msg-time {
      font-size: 10px;
      color: #999;
      margin-top: 4px;
    }
    #sendBar {
      display: flex;
      padding: 10px;
      background: white;
    }
    #sendBar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    #sendBar button {
      margin-left: 5px;
      padding: 8px 14px;
      background: #25D366;
      border: none;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
    #typingIndicator {
      padding-left: 12px;
      font-style: italic;
      font-size: 12px;
      color: gray;
      display: none;
    }
    #msgMenu {
      display: none;
      position: absolute;
      background: white;
      border: 2px solid #888;
      border-radius: 10px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      min-width: 240px;
      font-size: 17px;
      padding: 10px;
    }
    #msgMenu button {
      width: 100%;
      border: none;
      padding: 16px 20px;
      background: white;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #msgMenu button:last-child { border-bottom: none; }
    #msgMenu button:hover { background: #f2f2f2; }
    #floatingDate {
      position: sticky;
      top: 0;
      background: #f0f0f0;
      text-align: center;
      font-size: 13px;
      color: gray;
      z-index: 10;
      padding: 4px 0;
    }
    .date-label {
      text-align: center;
      color: gray;
      font-size: 12px;
      margin: 10px 0 5px;
    }
    @media (max-width: 600px) {
      #userList { width: 100%; }
      #chatWindow {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: white;
        z-index: 100;
      }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Welcome</div>
    <button onclick="goToDashboard()">Dashboard</button>
  </header>
  <div style="display: flex; height: calc(100% - 50px);">
    <div id="userList">
      <input id="searchBox" placeholder="Search users/groups..." />
      <button onclick="createGroup()">Create Group</button>
      <div id="recentChats"><h4>Recent Chats</h4></div>
      <div id="userSection"><h4>All Users</h4></div>
      <div id="groupSection"><h4>All Groups</h4></div>
    </div>
    <div id="chatWindow">
      <div style="padding: 10px; background: #128C7E; color: white; display: flex; justify-content: space-between;">
        <span id="chatWith">---</span>
        <div>
          <button onclick="closeChat()">‚úñ</button>
        </div>
      </div>
      <div id="typingIndicator">Typing...</div>
      <div id="messages">
        <div id="floatingDate"></div>
      </div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type message..." />
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <!-- Context menu for chat title -->
  <div id="chatTitleMenu" style="display:none; position:absolute; background:white; border:1px solid #ccc; padding:10px; border-radius:6px; z-index:99999;">
    <button onclick="leaveGroup()">Leave Group</button><br>
    <button onclick="blockUser()">Block User</button><br>
    <button onclick="alert('Coming soon: View members')">View Members</button>
  </div>

  <!-- Firebase setup -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
  <script>
  // üë§ Get current user from session
  let user = sessionStorage.getItem('username');
  if (!user) location.href = "index.html";
  document.getElementById("currentUser").textContent = "Welcome, " + user;

  // Global state
  let currentChat = "", convoRef = null, typingRef = null;
  let lastRenderedDate = "", replyingTo = null;
  let allUsers = {}, allGroups = {}, unreadCount = {}, recentChats = {};

  // üß† Helper: generate consistent chat ID
  function chatId(a, b) {
    return [a, b].sort().join("_");
  }

  // üì¶ Go to dashboard
  function goToDashboard() {
    location.href = "app.html";
  }

  // ‚ûï Group Creation
  function createGroup() {
    const name = prompt("Enter group name:");
    if (!name) return;
    const isPrivate = confirm("Make this a private group?");
    let password = "";
    if (isPrivate) {
      password = prompt("Enter a password for the group:");
      if (!password) return alert("Password required for private group.");
    }
    const id = db.ref("groups").push().key;
    db.ref("groups/" + id).set({
      name,
      public: !isPrivate,
      password: password || "",
      createdBy: user,
      members: { [user]: true }
    });
  }

  // üîÑ Load users
  db.ref("users").on("value", snap => {
    allUsers = snap.val() || {};
    refreshList();
    trackUnreadMessages();
  });

  // üîÑ Load groups
  db.ref("groups").on("value", snap => {
    allGroups = snap.val() || {};
    refreshList();
  });

  // üïí Load recent chats from DB
  db.ref("recentChats/" + user).once("value", snap => {
    recentChats = snap.val() || {};
    refreshList();
  });

  // üîç Refresh user/group list
  function refreshList() {
    const term = document.getElementById("searchBox").value.toLowerCase();
    const recent = document.getElementById("recentChats");
    const users = document.getElementById("userSection");
    const groups = document.getElementById("groupSection");

    recent.innerHTML = "<h4>Recent Chats</h4>";
    users.innerHTML = "<h4>All Users</h4>";
    groups.innerHTML = "<h4>All Groups</h4>";

    const sortedRecent = Object.entries(recentChats).sort((a, b) => b[1] - a[1]);
    sortedRecent.forEach(([id]) => {
      const isGroup = id.startsWith("group_");
      const label = isGroup ? allGroups[id.slice(6)]?.name || "Group" : id;
      if (label.toLowerCase().includes(term)) {
        const btn = document.createElement("button");
        const status = isGroup ? "" : `<small style='color:gray'>${formatLastSeen(allUsers[id]?.lastSeen)}</small>`;
        btn.innerHTML = `${label} ${status} ${unreadCount[id] ? '<span class="unread-badge">' + unreadCount[id] + '</span>' : ''}`;
        btn.onclick = () => {
          closeChat();
          setTimeout(() => {
            isGroup ? openGroup(id.slice(6), label) : openChat(id);
          }, 310);
        };
        recent.appendChild(btn);
      }
    });

    Object.keys(allUsers)
      .filter(u =>
        u !== user &&
        (u.toLowerCase().includes(term) ||
         allUsers[u].email?.toLowerCase().includes(term) ||
         allUsers[u].phone?.toLowerCase().includes(term))
      )
      .sort()
      .forEach(u => {
        const btn = document.createElement("button");
        const lastSeen = formatLastSeen(allUsers[u]?.lastSeen);
        btn.innerHTML = `${u} <small style='color:gray'>${lastSeen}</small>`;
        btn.onclick = () => {
          closeChat();
          setTimeout(() => openChat(u), 310);
        };
        users.appendChild(btn);
      });

    Object.keys(allGroups)
      .filter(id =>
        allGroups[id]?.name &&
        allGroups[id].name.toLowerCase().includes(term)
      )
      .sort((a, b) => allGroups[a].name.localeCompare(allGroups[b].name))
      .forEach(id => {
        const g = allGroups[id];
        const btn = document.createElement("button");
        btn.className = "group";
        btn.innerHTML = `${g.public ? "# " : "üîí "}${g.name}`;
        btn.onclick = () => {
          closeChat();
          setTimeout(() => attemptJoinGroup(id, g.name, g.public, g.password), 310);
        };
        groups.appendChild(btn);
      });
  }

  // üìÖ Format helper
  function formatLastSeen(ts) {
    if (!ts || isNaN(ts)) return 'Offline';
    const date = new Date(ts);
    const now = new Date();
    const isToday = date.toDateString() === now.toDateString();
    const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const fullDate = date.toLocaleDateString();
    return isToday ? `Today at ${time}` : `${fullDate} at ${time}`;
  }

  // üîê Join Group
  function attemptJoinGroup(id, name, isPublic, pass) {
    if (!isPublic) {
      const given = prompt("Enter password to join:");
      if (given !== pass) return alert("Incorrect password.");
    }
    db.ref("groups/" + id + "/members/" + user).set(true);
    openGroup(id, name);
  }

  // üí¨ Open private chat
  function openChat(toUser) {
    currentChat = toUser;
    const seen = formatLastSeen(allUsers[toUser]?.lastSeen);
    document.getElementById("chatWith").innerHTML =
      `${toUser} <small style='font-size:11px;'>(${seen})</small>`;
    document.getElementById("chatTitleMenu").style.display = "none";
    const chatWindow = document.getElementById("chatWindow");
    chatWindow.classList.add("active");
    chatWindow.style.display = "flex";
    messages.innerHTML = "";
    lastRenderedDate = "";

    if (convoRef) convoRef.off();
    if (typingRef) typingRef.off();

    const id = chatId(user, toUser);
    convoRef = db.ref("chats/" + id);
    convoRef.on("child_added", snap => renderMessage(snap.key, snap.val(), false, id));
    convoRef.on("child_changed", snap => updateMessageUI(snap.key, snap.val(), false, id));

    typingRef = db.ref(`typing/${id}/${toUser}`);
    typingRef.on("value", snap => {
      document.getElementById("typingIndicator").style.display = snap.val() ? "block" : "none";
    });

    recentChats[currentChat] = Date.now();
    db.ref("recentChats/" + user).set(recentChats);
    unreadCount[toUser] = 0;

    db.ref("seen/" + id + "/" + user).set(firebase.database.ServerValue.TIMESTAMP);
  }

  // üí¨ Open group chat
  function openGroup(id, name) {
    currentChat = "group_" + id;
    document.getElementById("chatWith").textContent = name;
    document.getElementById("chatTitleMenu").style.display = "none";

    const chatWindow = document.getElementById("chatWindow");
    chatWindow.classList.add("active");
    chatWindow.style.display = "flex";
    messages.innerHTML = "";
    lastRenderedDate = "";

    if (convoRef) convoRef.off();
    convoRef = db.ref("groupChats/" + id);
    convoRef.on("child_added", snap => renderMessage(snap.key, snap.val(), true, id));
    convoRef.on("child_changed", snap => updateMessageUI(snap.key, snap.val(), true, id));

    recentChats[currentChat] = Date.now();
    db.ref("recentChats/" + user).set(recentChats);
    unreadCount["group_" + id] = 0;
  }

  document.getElementById("searchBox").addEventListener("input", refreshList);
  </script>
  <script>
  const msgInput = document.getElementById("msgInput");
  const messagesDiv = document.getElementById("messages");

  // ‚úçÔ∏è Typing indicator (1-on-1 only)
  msgInput.addEventListener("input", () => {
    if (!currentChat || currentChat.startsWith("group_")) return;
    const id = chatId(user, currentChat);
    db.ref("typing/" + id + "/" + user).set(true);
    setTimeout(() => db.ref("typing/" + id + "/" + user).set(false), 1500);
  });

  // üì§ Send a message
  function sendMsg() {
    const text = msgInput.value.trim();
    if (!text) return;
    const now = Date.now();
    const msgData = {
      from: user,
      text,
      ts: now,
      readBy: { [user]: true },
      deliveredTo: { [user]: true }
    };
    if (replyingTo) {
      msgData.replyTo = replyingTo;
      replyingTo = null;
    }

    if (currentChat.startsWith("group_")) {
      const groupId = currentChat.slice(6);
      db.ref("groupChats/" + groupId).push(msgData);
    } else {
      const id = chatId(user, currentChat);
      db.ref("chats/" + id).push(msgData);
    }
    msgInput.value = "";
  }

  // üßæ Render messages
  function renderMessage(id, msg, isGroup = false, groupId = "") {
    if (!msg || msg.deletedFor?.[user]) return;

    const msgDate = new Date(msg.ts);
    const msgDateStr = msgDate.toDateString();

    if (msgDateStr !== lastRenderedDate) {
      const label = document.createElement("div");
      label.className = "date-label";
      label.textContent = formatDateLabel(msgDate);
      messagesDiv.appendChild(label);
      lastRenderedDate = msgDateStr;
    }

    const div = document.createElement("div");
    div.className = "msg " + (msg.from === user ? "you" : "them");
    div.dataset.id = id;
    div.dataset.ts = msg.ts;
    div.dataset.from = msg.from;
    div.dataset.text = msg.text;

    let inner = "";
    if (msg.deleted) {
      inner = "<i>This message was deleted</i>";
    } else {
      if (msg.replyTo) {
        inner += `<div style="font-size:12px;color:gray;border-left:3px solid #ccc;padding-left:5px">
        <b>${msg.replyTo.from}</b>: ${msg.replyTo.text}</div>`;
      }
      if (isGroup && msg.from !== user) inner += `<b>${msg.from}:</b> `;
      inner += msg.text;
    }

    const status = msg.from === user
      ? (msg.readBy?.[currentChat] ? "‚úì‚úì‚úì" : msg.deliveredTo?.[currentChat] ? "‚úì‚úì" : "‚úì")
      : "";

    const ts = new Date(msg.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    inner += `<div class="msg-time">${ts}<span class="msg-status">${status}</span></div>`;

    div.innerHTML = inner;

    // üìã Right-click context menu
    div.addEventListener("contextmenu", e => {
      e.preventDefault();
      showMsgOptions(id, msg, isGroup, groupId, div, e.pageX, e.pageY);
    });

    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // ‚úÖ Mark as read
    if (msg.from !== user && !msg.readBy?.[user]) {
      const ref = isGroup
        ? db.ref("groupChats/" + groupId + "/" + id + "/readBy/" + user)
        : db.ref("chats/" + chatId(user, currentChat) + "/" + id + "/readBy/" + user);
      ref.set(firebase.database.ServerValue.TIMESTAMP);
    }
  }

  // üßæ Update edited message
  function updateMessageUI(id, msg, isGroup = false, groupId = "") {
    const el = document.querySelector(`.msg[data-id="${id}"]`);
    if (!el || msg.deletedFor?.[user]) return;
    el.querySelector(".msg-time")?.remove();

    let inner = "";
    if (msg.deleted) {
      inner = "<i>This message was deleted</i>";
    } else {
      if (msg.replyTo) {
        inner += `<div style="font-size:12px;color:gray;border-left:3px solid #ccc;padding-left:5px">
        <b>${msg.replyTo.from}</b>: ${msg.replyTo.text}</div>`;
      }
      if (isGroup && msg.from !== user) inner += `<b>${msg.from}:</b> `;
      inner += msg.text;
    }

    const ts = new Date(msg.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const status = msg.from === user
      ? (msg.readBy?.[currentChat] ? "‚úì‚úì‚úì" : msg.deliveredTo?.[currentChat] ? "‚úì‚úì" : "‚úì")
      : "";
    inner += `<div class="msg-time">${ts}<span class="msg-status">${status}</span></div>`;

    el.innerHTML = inner;
  }

  // ‚å®Ô∏è Right-click options
  function showMsgOptions(id, msg, isGroup, groupId, div, x, y) {
    const menu = document.getElementById("msgMenu");
    menu.innerHTML = "";

    const canEdit = msg.from === user && Date.now() - msg.ts < 60000;

    if (canEdit) {
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit Message";
      editBtn.onclick = () => {
        const newText = prompt("Edit your message:", msg.text);
        if (newText) {
          const ref = isGroup
            ? db.ref("groupChats/" + groupId + "/" + id)
            : db.ref("chats/" + chatId(user, currentChat) + "/" + id);
          ref.update({ text: newText });
        }
        menu.style.display = "none";
      };
      menu.appendChild(editBtn);
    }

    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete for Everyone";
    delBtn.onclick = () => {
      const ref = isGroup
        ? db.ref("groupChats/" + groupId + "/" + id)
        : db.ref("chats/" + chatId(user, currentChat) + "/" + id);
      ref.update({ deleted: true });
      menu.style.display = "none";
    };
    menu.appendChild(delBtn);

    menu.style.left = x + "px";
    menu.style.top = y + "px";
    menu.style.display = "block";
  }

  // üìÖ Floating date label
  function formatDateLabel(date) {
    const today = new Date();
    const yesterday = new Date(Date.now() - 86400000);
    if (date.toDateString() === today.toDateString()) return "Today";
    if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
    return date.toLocaleDateString();
  }

  // üì≤ Swipe to reply (mobile)
  let swipeTarget = null;
  document.addEventListener("touchstart", e => {
    swipeTarget = e.target.closest(".msg");
    if (swipeTarget) swipeTarget.startX = e.touches[0].clientX;
  });

  document.addEventListener("touchend", e => {
    if (!swipeTarget) return;
    const endX = e.changedTouches[0].clientX;
    if (endX - swipeTarget.startX > 80) {
      swipeTarget.style.borderLeft = "4px solid #25D366";
      replyingTo = {
        from: swipeTarget.dataset.from,
        text: swipeTarget.dataset.text,
        ts: swipeTarget.dataset.ts
      };
    }
    swipeTarget = null;
  });
  </script>
  <script>
  // üëÜ Tap chat header for options
  document.getElementById("chatWith").onclick = e => {
    e.stopPropagation();
    const menu = document.getElementById("chatTitleMenu");
    const isGroup = currentChat.startsWith("group_");
    menu.innerHTML = "";

    if (isGroup) {
      const groupId = currentChat.slice(6);

      const leaveBtn = document.createElement("button");
      leaveBtn.textContent = "Leave Group";
      leaveBtn.onclick = () => {
        db.ref("groups/" + groupId + "/members/" + user).remove();
        closeChat();
        menu.style.display = "none";
      };
      menu.appendChild(leaveBtn);

      const viewBtn = document.createElement("button");
      viewBtn.textContent = "View Members";
      viewBtn.onclick = () => {
        db.ref("groups/" + groupId + "/members").once("value", snap => {
          const members = snap.val() || {};
          alert("Members:\n" + Object.keys(members).join(", "));
        });
        menu.style.display = "none";
      };
      menu.appendChild(viewBtn);

    } else {
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete Chat";
      delBtn.onclick = () => {
        db.ref("recentChats/" + user + "/" + currentChat).remove();
        closeChat();
        menu.style.display = "none";
      };
      menu.appendChild(delBtn);

      const blockBtn = document.createElement("button");
      blockBtn.textContent = "Block User";
      blockBtn.onclick = () => {
        db.ref("blocked/" + user + "/" + currentChat).set(true);
        closeChat();
        menu.style.display = "none";
      };
      menu.appendChild(blockBtn);
    }

    menu.style.left = e.pageX + "px";
    menu.style.top = e.pageY + "px";
    menu.style.display = "block";
  };

  // üïí Floating date header (updates as user scrolls)
  const floatingDate = document.getElementById("floatingDate");
  messagesDiv.addEventListener("scroll", () => {
    const labels = messagesDiv.querySelectorAll(".date-label");
    let current = "";
    for (const label of labels) {
      const rect = label.getBoundingClientRect();
      if (rect.top < 100) current = label.textContent;
      else break;
    }
    floatingDate.textContent = current || "";
  });

  // ‚ú® Close menu if user clicks outside
  document.addEventListener("click", () => {
    document.getElementById("msgMenu").style.display = "none";
    document.getElementById("chatTitleMenu").style.display = "none";
  });

  // üì¶ Utility ‚Äì sort object keys by timestamp
  function sortByTime(obj) {
    return Object.entries(obj || {}).sort((a, b) => (b[1] || 0) - (a[1] || 0));
  }
  </script>
  <script>
  // üîç Live search by username/email/phone/group name (case-insensitive)
  document.getElementById("searchBox").addEventListener("input", refreshList);

  function refreshList() {
    const term = document.getElementById("searchBox").value.toLowerCase().trim();
    const recent = document.getElementById("recentChats");
    const users = document.getElementById("userSection");
    const groups = document.getElementById("groupSection");

    recent.innerHTML = "<h4>Recent Chats</h4>";
    users.innerHTML = "<h4>All Users</h4>";
    groups.innerHTML = "<h4>All Groups</h4>";

    // Recent chats & groups
    sortByTime(recentChats).forEach(([id]) => {
      const isGroup = id.startsWith("group_");
      const label = isGroup ? allGroups[id.slice(6)]?.name || "Group" : id;
      const show = label.toLowerCase().includes(term) || id.toLowerCase().includes(term);

      if (show) {
        const btn = document.createElement("button");
        const status = isGroup ? "" : `<small style='color:gray'>${formatLastSeen(allUsers[id]?.lastSeen)}</small>`;
        const badge = unreadCount[id] ? `<span class="unread-badge">${unreadCount[id]}</span>` : "";
        btn.innerHTML = `${label} ${status} ${badge}`;
        btn.onclick = () => {
          closeChat();
          setTimeout(() => {
            isGroup ? openGroup(id.slice(6), label) : openChat(id);
          }, 310);
        };
        recent.appendChild(btn);
      }
    });

    // All users
    Object.entries(allUsers)
      .filter(([uid, info]) =>
        uid !== user &&
        (
          uid.toLowerCase().includes(term) ||
          (info.email || "").toLowerCase().includes(term) ||
          (info.phone || "").toLowerCase().includes(term)
        )
      )
      .sort()
      .forEach(([uid, info]) => {
        const btn = document.createElement("button");
        const lastSeen = formatLastSeen(info.lastSeen);
        btn.innerHTML = `${uid} <small style='color:gray'>${lastSeen}</small>`;
        btn.onclick = () => {
          closeChat();
          setTimeout(() => openChat(uid), 310);
        };
        users.appendChild(btn);
      });

    // All groups
    Object.entries(allGroups)
      .filter(([id, g]) => g?.name?.toLowerCase().includes(term))
      .sort((a, b) => a[1].name.localeCompare(b[1].name))
      .forEach(([id, g]) => {
        const btn = document.createElement("button");
        btn.className = "group";
        btn.innerHTML = `${g.public ? "# " : "üîí "}${g.name}`;
        btn.onclick = () => {
          closeChat();
          setTimeout(() => attemptJoinGroup(id, g.name), 310);
        };
        groups.appendChild(btn);
      });
  }

  // üß† Track unread messages
  function trackUnreadMessages() {
    Object.keys(allUsers).forEach(u => {
      if (u === user) return;
      const id = chatId(user, u);
      db.ref("chats/" + id).on("child_added", snap => {
        const msg = snap.val();
        if (msg.from !== user && (!msg.readBy || !msg.readBy[user])) {
          unreadCount[u] = (unreadCount[u] || 0) + 1;
          refreshList();
        }
      });
    });

    Object.keys(allGroups).forEach(id => {
      db.ref("groupChats/" + id).on("child_added", snap => {
        const msg = snap.val();
        if (msg.from !== user && (!msg.readBy || !msg.readBy[user])) {
          unreadCount["group_" + id] = (unreadCount["group_" + id] || 0) + 1;
          refreshList();
        }
      });
    });
  }

  // üü¢ Typing indicator fix (shows typing when value is true)
  function subscribeToTyping(id, otherUser) {
    typingRef = db.ref(`typing/${id}/${otherUser}`);
    typingRef.on("value", snap => {
      const isTyping = snap.val();
      document.getElementById("typingIndicator").style.display = isTyping ? "block" : "none";
    });
  }
  </script>
  <script>
  // ‚úÖ Save last seen periodically
  setInterval(() => {
    db.ref("users/" + user + "/lastSeen").set(Date.now());
  }, 10000); // every 10 seconds

  // üßπ Final cleanup: close menu on ESC
  document.addEventListener("keydown", e => {
    if (e.key === "Escape") {
      document.getElementById("msgMenu").style.display = "none";
      document.getElementById("chatTitleMenu").style.display = "none";
    }
  });

  // üì• Load recent chats initially
  db.ref("recentChats/" + user).once("value").then(snap => {
    recentChats = snap.val() || {};
    refreshList();
  });

  // üß≠ Update last seen & refresh on focus
  window.addEventListener("focus", () => {
    db.ref("users/" + user + "/lastSeen").set(Date.now());
    refreshList();
  });

  // üíæ Save recent chat timestamp
  function updateRecentChat(id) {
    recentChats[id] = Date.now();
    db.ref("recentChats/" + user).set(recentChats);
  }

  // üßÆ Sort helper
  function sortByTime(obj = {}) {
    return Object.entries(obj).sort((a, b) => (b[1] || 0) - (a[1] || 0));
  }

  // üìÜ Format date label
  function formatDateLabel(date) {
    const now = new Date();
    const yest = new Date(Date.now() - 86400000);
    if (date.toDateString() === now.toDateString()) return "Today";
    if (date.toDateString() === yest.toDateString()) return "Yesterday";
    return date.toLocaleDateString();
  }

  // ‚úÖ Fix invalid timestamps
  function safeDate(ts) {
    const d = new Date(ts);
    return isNaN(d.getTime()) ? new Date() : d;
  }

  // üß™ Initialize unread counters after all load
  setTimeout(() => {
    trackUnreadMessages();
  }, 1000);

  // ‚úÖ Minimize refresh flashes
  let refreshTimeout = null;
  function queueRefresh() {
    if (refreshTimeout) clearTimeout(refreshTimeout);
    refreshTimeout = setTimeout(refreshList, 200);
  }

  // ‚úÖ Scroll to bottom when new messages arrive
  const scrollToBottom = () => {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  };

  // ‚úÖ Session exit cleanup
  window.addEventListener("beforeunload", () => {
    db.ref("users/" + user + "/lastSeen").set(Date.now());
  });

  // üöÄ Done loading
  console.log("WhatsApp Clone Ready ‚úÖ");
  </script>
</body>
</html>
