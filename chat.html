<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bravo Chat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }
    #userList input {
      width: 100%;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #userList button {
      width: 100%;
      margin-bottom: 5px;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0f7fa;
    }
    #userList button.group {
      background: #dcedc8;
      font-weight: bold;
    }
    #chatWindow {
      display: none;
      flex-direction: column;
      height: 100%;
      flex: 1;
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
    }
    .msg {
      padding: 8px;
      margin: 5px;
      border-radius: 7px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .you {
      background: #dcf8c6;
      align-self: flex-end;
    }
    .them {
      background: white;
      align-self: flex-start;
    }
    #sendBar {
      display: flex;
      padding: 10px;
      background: #fff;
    }
    #sendBar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    #sendBar button {
      margin-left: 5px;
      padding: 8px 12px;
      background: #25D366;
      border: none;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      #userList {
        width: 100%;
      }
      #chatWindow {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        display: none;
        flex-direction: column;
        background: white;
        z-index: 100;
      }
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Welcome</div>
    <button onclick="goToDashboard()">Dashboard</button>
  </header>

  <div style="display: flex; height: calc(100% - 50px);">
    <div id="userList" style="width: 30%; overflow-y: auto; padding: 10px; border-right: 1px solid #ccc;">
      <input id="searchBox" placeholder="Search users/groups..." />
      <button onclick="createGroup()">Create Group</button>
      <div id="userSection"></div>
      <div id="groupSection"></div>
    </div>

    <div id="chatWindow">
      <div style="padding: 10px; background: #128C7E; color: white;">
        <span id="chatWith">---</span>
        <button onclick="startCall('voice')">ðŸ“ž</button>
        <button onclick="startCall('video')">ðŸŽ¥</button>
        <button onclick="closeChat()" style="float: right;">âœ–</button>
      </div>
      <div id="messages"></div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type message..." />
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase & Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Load user
    let user = sessionStorage.getItem('username');
    if (!user) {
      user = prompt("Enter your username:");
      if (!user) location.href = "index.html";
      sessionStorage.setItem("username", user);
    }
    document.getElementById("currentUser").textContent = "Welcome, " + user;

    function goToDashboard() {
      sessionStorage.setItem('username', user);
      location.href = "app.html";
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentChat = "", convoRef = null;
    let allUsers = {}, allGroups = {};

    const userListDiv = document.getElementById('userSection');
    const groupListDiv = document.getElementById('groupSection');
    const searchBox = document.getElementById('searchBox');

    searchBox.addEventListener('input', refreshList);

    db.ref('users').on('value', snap => {
      allUsers = snap.val() || {};
      refreshList();
    });

    db.ref('groups').on('value', snap => {
      allGroups = snap.val() || {};
      refreshList();
    });

    function refreshList() {
      const term = searchBox.value.trim().toLowerCase();
      userListDiv.innerHTML = "<h3>Users</h3>";
      groupListDiv.innerHTML = "<h3>Groups</h3>";

      for (const u in allUsers) {
        if (u !== user && u.toLowerCase().includes(term)) {
          const btn = document.createElement('button');
          btn.textContent = u;
          btn.onclick = () => openChat(u);
          userListDiv.appendChild(btn);
        }
      }

      for (const id in allGroups) {
        const g = allGroups[id];
        if (!g || typeof g.name !== 'string') continue;
        const label = g.public ? `# ${g.name}` : `ðŸ”’ ${g.name}`;
        if (g.name.toLowerCase().includes(term)) {
          const btn = document.createElement('button');
          btn.textContent = label;
          btn.className = 'group';
          btn.onclick = () => attemptJoinGroup(id, g.name);
          groupListDiv.appendChild(btn);
        }
      }
    }

    function createGroup() {
      let name = prompt("Enter group name:");
      if (!name) return;

      name = name.trim().replace(/[^a-zA-Z0-9 -]/g, '').replace(/\s+/g, '');
      const type = prompt("Group type (public/private):").toLowerCase();
      if (type !== 'public' && type !== 'private') return alert("Invalid type.");

      const isPublic = type === 'public';
      const password = isPublic ? null : prompt("Set a password:");

      const data = {
        name,
        admin: user,
        public: isPublic,
        password,
        members: { [user]: true }
      };

      const ref = db.ref('groups').push();
      ref.set(data);
      db.ref('groupChats/' + ref.key).push({ from: 'System', text: `${user} created this group.`, ts: Date.now() });
    }

    function attemptJoinGroup(groupId, name) {
      db.ref('groups/' + groupId).once('value').then(snap => {
        const group = snap.val();
        if (!group) return;
        if (group.members && group.members[user]) {
          openGroup(groupId, name);
        } else if (!group.public) {
          const pwd = prompt("Enter group password:");
          if (pwd === group.password) {
            db.ref('groups/' + groupId + '/members/' + user).set(true);
            openGroup(groupId, name);
          } else {
            alert("Wrong password.");
          }
        } else {
          if (confirm("Join this public group?")) {
            db.ref('groups/' + groupId + '/members/' + user).set(true);
            openGroup(groupId, name);
          }
        }
      });
    }
  </script>
  <script>
    function openChat(username) {
      currentChat = username;
      document.getElementById("chatWith").textContent = username;
      document.getElementById("chatWindow").style.display = "flex";
      document.getElementById("messages").innerHTML = "";
      if (convoRef) convoRef.off();

      convoRef = db.ref('chats/' + chatId(user, username));
      convoRef.on('child_added', snap => {
        renderMessage(snap.key, snap.val());
      });
    }

    function openGroup(groupId, groupName) {
      currentChat = groupId;
      document.getElementById("chatWith").textContent = groupName;
      document.getElementById("chatWindow").style.display = "flex";
      document.getElementById("messages").innerHTML = "";
      if (convoRef) convoRef.off();

      convoRef = db.ref('groupChats/' + groupId);
      convoRef.on('child_added', snap => {
        renderMessage(snap.key, snap.val(), true, groupId);
      });
    }

    function chatId(a, b) {
      return [a, b].sort().join('_');
    }

    function renderMessage(id, msg, isGroup = false, groupId = "") {
      if (!msg || msg.deletedFor && msg.deletedFor[user]) return;

      const div = document.createElement('div');
      div.className = 'msg ' + (msg.from === user ? 'you' : 'them');
      div.textContent = (isGroup && msg.from !== user ? `${msg.from}: ` : "") + msg.text;
      div.dataset.id = id;
      div.dataset.from = msg.from;
      div.dataset.ts = msg.ts;
      div.title = new Date(msg.ts).toLocaleTimeString();

      div.addEventListener('contextmenu', e => {
        e.preventDefault();
        showMessageOptions(id, msg, isGroup, groupId, div);
      });

      document.getElementById("messages").appendChild(div);
      document.getElementById("messages").scrollTop = 9999999;
    }

    function showMessageOptions(id, msg, isGroup, groupId, div) {
      const options = [];
      if (msg.from === user && Date.now() - msg.ts <= 60000) {
        options.push("Delete for Everyone");
      }
      options.push("Delete for Me");

      const choice = prompt("Options:\n" + options.join("\n"));
      if (choice === "Delete for Everyone") {
        const ref = isGroup ? db.ref(`groupChats/${groupId}/${id}`) : db.ref(`chats/${chatId(user, currentChat)}/${id}`);
        ref.set({ text: "This message was deleted", from: msg.from, ts: msg.ts, deleted: true });
      } else if (choice === "Delete for Me") {
        div.remove();
        const loc = `deletedFor/${user}`;
        const ref = isGroup ? db.ref(`groupChats/${groupId}/${id}/${loc}`) : db.ref(`chats/${chatId(user, currentChat)}/${id}/${loc}`);
        ref.set(true);
      }
    }

    function sendMsg() {
      const text = document.getElementById("msgInput").value.trim();
      if (!text || !currentChat) return;

      const msg = {
        from: user,
        text,
        ts: Date.now()
      };

      if (currentChat.length < 20) {
        db.ref('chats/' + chatId(user, currentChat)).push(msg);
      } else {
        db.ref('groupChats/' + currentChat).push(msg);
      }
      document.getElementById("msgInput").value = "";
    }

    function closeChat() {
      document.getElementById("chatWindow").style.display = "none";
      if (convoRef) convoRef.off();
    }

    function startCall(type) {
      alert(`${type === 'voice' ? "Voice" : "Video"} call feature coming soon.`);
    }

    // Clickable header options
    document.getElementById("chatWith").onclick = function () {
      if (!currentChat) return;
      if (currentChat.length < 20) {
        const choice = prompt("Options:\n1. Block User\n2. Delete Chat");
        if (choice === "1") {
          alert("User blocked (locally)");
        } else if (choice === "2") {
          if (confirm("Delete entire chat with " + currentChat + "?")) {
            db.ref('chats/' + chatId(user, currentChat)).remove();
            closeChat();
          }
        }
      } else {
        db.ref('groups/' + currentChat).once('value').then(snap => {
          const g = snap.val();
          const isAdmin = g.admin === user;
          let options = "1. View Members\n2. Leave Group";
          if (isAdmin) options += "\n3. Remove Member\n4. Delete Group";

          const choice = prompt("Group Options:\n" + options);
          if (choice === "1") {
            let members = Object.keys(g.members || {}).join("\n");
            alert("Members:\n" + members);
          } else if (choice === "2") {
            if (confirm("Leave group?")) {
              db.ref(`groups/${currentChat}/members/${user}`).remove();
              closeChat();
            }
          } else if (choice === "3" && isAdmin) {
            const who = prompt("Remove who?");
            db.ref(`groups/${currentChat}/members/${who}`).remove();
            db.ref(`groupChats/${currentChat}`).push({ from: "System", text: `${who} was removed.`, ts: Date.now() });
          } else if (choice === "4" && isAdmin) {
            if (confirm("Delete group permanently?")) {
              db.ref('groups/' + currentChat).remove();
              db.ref('groupChats/' + currentChat).remove();
              closeChat();
            }
          }
        });
      }
    };
  </script>
</body>
</html>
