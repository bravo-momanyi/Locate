<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp Clone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <style>
    html, body { width: 100vw; height: 100vh; min-width: 0; overflow: hidden; }
    #mainContainer { display: flex; width: 100vw; height: 100vh; }
    #sidebar {
      width: 320px; min-width: 220px; max-width: 400px;
      background: #f3f4f6; border-right: 1px solid #d1d5db;
      display: flex; flex-direction: column; height: 100vh; overflow-y: auto;
    }
    #chatArea {
      flex: 1; min-width: 0; background: #fff;
      display: flex; flex-direction: column; height: 100vh;
    }
    #chatHeader {
      position: sticky; top: 0; z-index: 40;
      background: #f3f4f6; border-bottom: 1px solid #d1d5db;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.5rem 1rem; min-height: 56px;
      flex-wrap: wrap;
    }
    #chatTitle { font-size: 1.15rem; font-weight: bold; color: #065f46; cursor:pointer; }
    #chatSearchBar {
      border-radius: 6px; background: #fff; border: 1px solid #d1d5db;
      padding: 0.25rem 0.75rem; font-size: 1rem; min-width: 160px;
      margin-left:16px;
    }
    #messages { flex: 1; overflow-y: auto; padding: 1rem; background: #fff; }
    #inputTagBar { position: sticky; bottom: 60px; left: 0; right: 0; z-index: 40; }
    #messageForm { position: sticky; bottom: 0; background: #f3f4f6; }
    .msg-light { background-color: #d4f8e8 !important; color: #222 !important; }
    .msg-dark { background-color: #065f46 !important; color: #fff !important; }
    #contextMenu { min-width: 180px; background: white; border: 1px solid #ddd; position: fixed; z-index: 9999; box-shadow: 0 2px 20px rgba(0,0,0,0.12);}
    #groupInfoModal { position:fixed; top:0; left:0; right:0; bottom:0; z-index:99999; background:rgba(0,0,0,0.14); display:none; align-items:center; justify-content:center;}
    #groupInfoContent { background:#fff; padding:2rem; border-radius:0.75rem; min-width:320px; max-width:90vw;}
    .date-sticky {
      position: sticky;
      top: 56px;
      z-index: 10;
      background: #e2e8f0;
      text-align: center;
      padding: 4px 0 4px 0;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #065f46;
    }
    .reply-tag {
      background: #e2e8f0;
      border-radius: 6px;
      margin-bottom: 2px;
      padding: 2px 8px;
      color: #065f46;
      display: block;
      font-size: 0.88em;
      cursor: pointer;
      border-left: 3px solid #3182ce;
    }
    .input-tag-bar {
      background: #e2e8f0;
      padding: 3px 8px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
      color: #065f46;
      font-size: 0.94em;
    }
    .input-tag-bar .remove-tag {
      color: #e53e3e;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.2em;
    }
    @media (max-width:768px) {
      #sidebar { width: 100vw; min-width: 0; max-width: 100vw; position: absolute; left: 0; top: 0; bottom: 0; z-index: 40; }
      #mainContainer { flex-direction: column; }
      #chatArea { width: 100vw; min-width: 0; }
      #sidebar.hide { display: none !important; }
      #chatArea.hide { display: none !important; }
      #chatHeader { position: sticky; top: 0; left: 0; width: 100vw; }
      #groupInfoContent { min-width: 90vw;}
      #messageForm { position:fixed; bottom:0; left:0; right:0; width:100vw; }
      #inputTagBar { position:fixed; bottom:60px; left:0; right:0; width:100vw; }
    }
    body.dark, body.dark #sidebar, body.dark #chatArea, body.dark #chatHeader, body.dark #messageForm {
      background: #222 !important; color: #fff !important;
    }
    .copy-btn { color:#065f46; background:#d4f8e8; border-radius:6px; padding:2px 8px; font-size:15px; margin-left:3px;}
    .copy-btn:hover { background:#065f46; color:#fff;}
  </style>
</head>
<body class="bg-white text-black transition-colors duration-300">
<div id="mainContainer">
  <!-- ...sidebar code unchanged... -->
  <main id="chatArea" class="hide flex flex-col h-full">
    <div id="chatHeader">
      <div class="flex items-center gap-2">
        <button id="backBtn" class="text-blue-600 pr-2 md:hidden">&larr;</button>
        <span id="chatTitle"></span>
        <input id="chatSearchBar" placeholder="Search messages..." />
      </div>
      <div class="flex items-center gap-2">
        <button id="audioCallBtn" class="bg-green-500 text-white px-3 py-1 rounded text-sm shadow">ðŸ“ž</button>
        <button id="videoCallBtn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm shadow">ðŸŽ¥</button>
        <button id="blockUser" class="text-sm text-red-500 ml-2">ðŸš«</button>
      </div>
    </div>
    <div id="inputTagBar"></div>
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
    <form id="messageForm" class="flex items-center p-2 border-t gap-2">
      <input id="messageInput" type="text" placeholder="Type a message" class="flex-1 border px-3 py-2 rounded" />
      <input type="file" id="fileInput" class="hidden" />
      <button type="button" id="attachBtn" class="text-blue-600">ðŸ“Ž</button>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
    </form>
  </main>
</div>
<!-- ...modals unchanged... -->
<script>
  // ...firebase and global setup unchanged...
  let replyTag = null;
  const inputTagBar = document.getElementById("inputTagBar");

  function formatDate(ts) {
    const d = new Date(ts);
    const now = new Date();
    const msgDay = d.toDateString(), nowDay = now.toDateString();
    if (msgDay === nowDay) return "Today";
    const yesterday = new Date(now.getTime());
    yesterday.setDate(yesterday.getDate() - 1);
    if (msgDay === yesterday.toDateString()) return "Yesterday";
    return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
  }
  function formatTime(ts) {
    const d = new Date(ts);
    const now = new Date();
    const diff = Math.floor((now - d) / 60000);
    if (diff < 1) return "Just now";
    if (diff < 60) return `${diff} mins ago`;
    return d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
  }

  function renderMessagesFiltered(query) {
    messagesEl.innerHTML = "";
    let lastDate = "";
    let lastDateDiv = null;
    const lower = (query||"").toLowerCase();
    allMessages
      .filter(msg =>
        !query || (msg.text && msg.text.toLowerCase().includes(lower)) ||
        (msg.fileName && msg.fileName.toLowerCase().includes(lower))
      )
      .forEach((msg, idx, arr) => {
        const dateStr = formatDate(msg.timestamp);
        if (dateStr !== lastDate) {
          lastDate = dateStr;
          lastDateDiv = document.createElement("div");
          lastDateDiv.className = "date-sticky";
          lastDateDiv.textContent = dateStr;
          messagesEl.appendChild(lastDateDiv);
        }
        renderMessage(msg, msg._id, lastDateDiv);
      });
  }

  function renderMessage(msg, id, lastDateDiv) {
    // ...existing code...
    const isSender = msg.sender === currentUser;
    const timeElapsed = Date.now() - msg.timestamp;
    const showEditDeleteForEveryone = isSender && timeElapsed <= 60000;
    const lightBg = document.documentElement.classList.contains("dark") ? "msg-dark" : "msg-light";
    const div = document.createElement("div");
    div.dataset.id = id;
    div.className = `relative max-w-xs px-4 py-2 rounded shadow text-sm break-words ${lightBg} ${isSender ? "ml-auto" : ""}`;
    // Reply tag if present
    if (msg.replyTo) {
      const replyDiv = document.createElement("div");
      replyDiv.className = "reply-tag";
      replyDiv.textContent = msg.replyText || "Replied message";
      replyDiv.onclick = () => {
        const el = document.querySelector(`[data-id="${msg.replyTo}"]`);
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "center" });
          el.classList.add("ring", "ring-blue-500");
          setTimeout(()=>el.classList.remove("ring","ring-blue-500"), 1200);
        }
      };
      div.appendChild(replyDiv);
    }
    div.innerHTML += msg.text || (msg.fileUrl ? `<a href="${msg.fileUrl}" target="_blank" class="underline text-blue-700">${msg.fileName}</a>` : "");

    function getMenuActions() {
      const actions = [{ label: "Reply", action: "reply" }];
      if (isSender) {
        actions.push({ label: "Edit", action: "edit" });
        actions.push({ label: "Delete for Me", action: "deleteMe" });
        if (showEditDeleteForEveryone) {
          actions.push({ label: "Delete for Everyone", action: "deleteEveryone" });
        }
      } else {
        actions.push({ label: "Delete for Me", action: "deleteMe" });
      }
      actions.push({ label: "React", action: "react" });
      return actions;
    }

    // Swipe to reply
    let startX = null;
    div.addEventListener("touchstart", e => { startX = e.touches[0].clientX; });
    div.addEventListener("touchend", e => {
      if (!startX) return;
      const endX = e.changedTouches[0].clientX;
      if (startX !== null && endX - startX > 60) {
        setReplyTag(msg, id);
      }
      startX = null;
    });

    div.oncontextmenu = e => {
      e.preventDefault();
      contextMsgId = id;
      contextMsg = msg;
      showContextMenu(getMenuActions(), e.clientX, e.clientY);
    };
    let longPressTimer;
    div.addEventListener("touchstart", e => {
      longPressTimer = setTimeout(() => {
        contextMsgId = id;
        contextMsg = msg;
        showContextMenu(getMenuActions(), e.touches[0].clientX, e.touches[0].clientY);
      }, 400);
    });
    div.addEventListener("touchend", () => clearTimeout(longPressTimer));
    div.addEventListener("touchmove", () => clearTimeout(longPressTimer));
    if (msg.sender !== currentUser && selectedChat && !selectedChat.isGroup) {
      db.ref(`${getChatPath()}/${id}/status`).set("read");
    }
    if (isSender) {
      const ticks = document.createElement("span");
      ticks.className = "absolute bottom-1 right-2 text-xs";
      if (msg.status === "read") {
        ticks.textContent = "âœ“âœ“";
        ticks.classList.add("text-green-700");
      } else if (msg.status === "delivered") {
        ticks.textContent = "âœ“âœ“";
      } else {
        ticks.textContent = "âœ“";
      }
      div.appendChild(ticks);
    }
    // Reactions bar
    if (msg.reactions) {
      const reactionBar = document.createElement("div");
      reactionBar.className = "flex gap-1 mt-1";
      for (const [user, emoji] of Object.entries(msg.reactions)) {
        const span = document.createElement("span");
        span.textContent = emoji;
        span.className = "inline-block px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-lg";
        reactionBar.appendChild(span);
      }
      div.appendChild(reactionBar);
    }
    // Add time
    const timeDiv = document.createElement("div");
    timeDiv.className = "text-xs text-gray-500 mt-1";
    timeDiv.textContent = formatTime(msg.timestamp);
    div.appendChild(timeDiv);

    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    if (msg.sender !== currentUser && document.hidden && Notification.permission === "granted") {
      new Notification(`New message from ${msg.sender}`, {
        body: msg.text,
        icon: "/assets/whatsapp-icon.png"
      });
    }
  }

  function setReplyTag(msg, id) {
    replyTag = { id, text: msg.text };
    inputTagBar.innerHTML = `<div class="input-tag-bar">
      <span>Replying to: ${msg.text.slice(0,60)}${msg.text.length>60?'...':''}</span>
      <span class="remove-tag" onclick="removeReplyTag()">Ã—</span>
    </div>`;
    window.removeReplyTag = function() {
      replyTag = null;
      inputTagBar.innerHTML = '';
    };
  }

  messageInput.oninput = () => {
    sendTyping(true);
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => sendTyping(false), 2000);
  };
  function showChatArea() {
    chatListEl.classList.add("hide");
    chatWindowEl.classList.remove("hide");
  }
  function sendTyping(isTyping) {
    if (!selectedChat || selectedChat.isGroup) return;
    db.ref(`typing/${selectedChat.id}`).set(isTyping ? currentUser : "");
  }

  messageForm.onsubmit = async e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text || !selectedChat) return;
    if (!selectedChat.isGroup) {
      if (await enforceBlock()) {
        alert("You or the other user have blocked each other. Messaging is not allowed.");
        return;
      }
      const blockedRef = db.ref(`blocked/${selectedChat.id}/${currentUser}`);
      const blockedSnap = await blockedRef.once("value");
      if (blockedSnap.exists()) { alert("You are blocked by this user."); return; }
    }
    const msg = {
      sender: currentUser,
      text: text,
      timestamp: Date.now(),
      status: "sent"
    };
    if (replyTag) {
      msg.replyTo = replyTag.id;
      msg.replyText = replyTag.text;
    }
    const ref = db.ref(getChatPath()).push();
    await ref.set(msg);
    replyTag = null;
    inputTagBar.innerHTML = '';
    messageInput.value = "";
    sendTyping(false);
    if (!selectedChat.isGroup) {
      const statusRef = db.ref(`users/${selectedChat.id}/online`);
      statusRef.once("value", snap => { if (snap.val()) ref.update({ status: "delivered" }); });
    }
  };

  // ...rest unchanged...

</script>
</body>
</html>
