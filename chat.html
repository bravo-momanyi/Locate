<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bravo Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }
    header button {
      background: #25D366;
      border: none;
      padding: 6px 12px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    #userList {
      width: 30%;
      overflow-y: auto;
      padding: 10px;
      border-right: 1px solid #ccc;
    }
    #userList input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #userList button {
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0f7fa;
    }
    #userList button.group {
      background: #dcedc8;
      font-weight: bold;
    }
    .unread-badge {
      background: red;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      float: right;
      margin-top: -15px;
    }
    #chatWindow {
      display: none;
      flex-direction: column;
      flex: 1;
      height: 100%;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease;
      opacity: 0;
      transform: translateX(100%);
    }
    #chatWindow.active {
      opacity: 1;
      transform: translateX(0);
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
    }
    .msg {
      padding: 8px;
      margin: 6px;
      border-radius: 7px;
      max-width: 70%;
      position: relative;
      word-wrap: break-word;
      animation: slideIn 0.3s ease forwards;
    }
    .you {
      background: #dcf8c6;
      align-self: flex-end;
      text-align: right;
    }
    .them {
      background: white;
      align-self: flex-start;
    }
    .msg-time {
      font-size: 10px;
      color: #888;
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }
    .msg-status {
      margin-left: 6px;
      font-weight: bold;
      color: #999;
    }
    #sendBar {
      display: flex;
      padding: 10px;
      background: white;
    }
    #sendBar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    #sendBar button {
      margin-left: 5px;
      padding: 8px 14px;
      background: #25D366;
      border: none;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
    #typingIndicator {
      padding-left: 12px;
      font-style: italic;
      font-size: 12px;
      color: gray;
      display: none;
    }
    #msgMenu {
      display: none;
      position: absolute;
      background: white;
      border: 2px solid #888;
      border-radius: 10px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      min-width: 240px;
      font-size: 17px;
      padding: 10px;
    }
    #msgMenu button {
      width: 100%;
      border: none;
      padding: 16px 20px;
      background: white;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #msgMenu button:last-child {
      border-bottom: none;
    }
    #msgMenu button:hover {
      background: #f2f2f2;
    }
    #backBtn {
  padding: 6px 12px;
  font-size: 24px;
    }
    @media (max-width: 600px) {
      #userList { width: 100%; }
      #chatWindow {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        background: white;
        z-index: 100;
      }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Welcome</div>
    <button onclick="goToDashboard()">Dashboard</button>
  </header>
  <div style="display: flex; height: calc(100% - 50px);">
    <div id="userList">
      <div style="position: relative;">
  <input id="searchBox" placeholder="Search users/groups..." style="padding-right: 30px;" />
  <span id="clearSearch" style="position: absolute; right: 10px; top: 8px; cursor: pointer; font-weight: bold; font-size: 16px; color: #999;">√ó</span>
      </div>
      <button onclick="createGroup()">Create Group</button>
      <div id="recentChats"><h4>Recent Chats</h4></div>
      <div id="userSection"><h4>All Users</h4></div>
      <div id="groupSection"><h4>All Groups</h4></div>
    </div>
    <div id="chatWindow">
      <div style="padding: 10px; background: #128C7E; color: white; display: flex; justify-content: space-between;">
        <span id="chatWith">---</span>
        <div>
          <div style="padding: 10px; background: #128C7E; color: white; display: flex; justify-content: space-between; align-items: center;">
            <button id="backBtn" onclick="closeChat()" style="font-size: 20px; background: none; border: none; color: white; cursor: pointer;">BACK</button>
            <span id="chatWith" style="flex: 1; text-align: center; font-weight: bold;"></span>
            <div style="width: 40px;"></div>
          </div>
        </div>
      </div>
      <div id="typingIndicator">Typing...</div>
      <div id="messages"></div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type message..."/>
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <div id="chatTitleMenu" style="display:none; position:absolute; background:white; border:1px solid #ccc; padding:10px; border-radius:6px; z-index:99999;">
    <button onclick="leaveGroup()">Leave Group</button><br>
    <button onclick="blockUser()">Block User</button><br>
    <button onclick="alert('Coming soon: View members')">View Members</button>
  </div>

  <div id="msgMenu" class="msg-menu" style="display:none;"></div>
  <!-- Firebase and logic scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
  authDomain: "locater-42fb4.firebaseapp.com",
  databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
  projectId: "locater-42fb4",
  storageBucket: "locater-42fb4.appspot.com",
  messagingSenderId: "250348367998",
  appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// üîê User session
let user = sessionStorage.getItem("username");
if (!user) location.href = "index.html";
document.getElementById("currentUser").textContent = "Welcome, " + user;

// üß† App State
let currentChat = "", convoRef = null, typingRef = null;
let allUsers = {}, allGroups = {}, unreadCount = {};
let replyingTo = null;
const messagesDiv = document.getElementById("messages");
const msgBox = document.getElementById("msgInput");

// üîë Helper
function chatId(a, b) {
  return [a, b].sort().join("_");
}

// üì¶ Go to dashboard
function goToDashboard() {
  location.href = "app.html";
}

// ‚ûï Create group
function createGroup() {
  const name = prompt("Enter group name:");
  if (!name) return;
  const isPrivate = confirm("Is this a private group?");
  const password = isPrivate ? prompt("Set a group password:") : "";
  const id = name.trim();
  db.ref("groups/" + id).set({
    name,
    public: !isPrivate,
    password: isPrivate ? password : null,
    admin: user,
    members: { [user]: true }
  });
}
let usersLoaded = false, groupsLoaded = false;

// üîÅ Load users
db.ref("users").on("value", snap => {
  allUsers = snap.val() || {};
  usersLoaded = true;
  if (groupsLoaded) refreshList(); // only call if both loaded
});

db.ref("groups").on("value", snap => {
  allGroups = snap.val() || {};
  groupsLoaded = true;
  if (usersLoaded) refreshList(); // only call if both loaded
});
// üîç Search and refresh chat list
function refreshList() {
  const term = document.getElementById("searchBox").value.toLowerCase();
  const recent = document.getElementById("recentChats");
  const users = document.getElementById("userSection");
  const groups = document.getElementById("groupSection");

  // Clear all sections
  recent.innerHTML = "<h4>Recent Chats & Groups</h4>";
  users.innerHTML = "<h4>All Users</h4>";
  groups.innerHTML = "<h4>All Groups</h4>";

  // ‚úÖ Load recent chats from Firebase
  db.ref("recentChats/" + user).once("value", snap => {
    const rc = snap.val() || {};
    const seen = new Set(); // prevent duplication

    const sortedRecent = Object.entries(rc).sort((a, b) => b[1] - a[1]);
    sortedRecent.forEach(([id]) => {
      if (seen.has(id)) return;
      seen.add(id);

      const isGroup = id.startsWith("group_");
      const groupId = id.slice(6);
      const label = isGroup ? allGroups[groupId]?.name || "Group" : id;

      const match = isGroup
        ? label.toLowerCase().includes(term)
        : (
          id.toLowerCase().includes(term) ||
          allUsers[id]?.email?.toLowerCase().includes(term) ||
          allUsers[id]?.mobile?.toLowerCase().includes(term)
        );

      if (match) {
        const btn = document.createElement("button");
        const status = isGroup ? "" : `<small style='color:gray'>${allUsers[id]?.lastSeen || 'Offline'}</small>`;
        btn.innerHTML = `${label} ${status} ${unreadCount[id] ? '<span class="unread-badge">' + unreadCount[id] + '</span>' : ''}`;
        btn.onclick = () => {
          if (currentChat !== id) {
            closeChat();
            setTimeout(() => {
              isGroup ? openGroup(groupId, label) : openChat(id);
            }, 310);
          }
        };
        recent.appendChild(btn);
      }
    });
  });

  // ‚úÖ All users section
  Object.keys(allUsers)
    .filter(u =>
      u !== user &&
      (
        u.toLowerCase().includes(term) ||
        allUsers[u]?.email?.toLowerCase().includes(term) ||
        allUsers[u]?.mobile?.toLowerCase().includes(term)
      )
    )
    .sort()
    .forEach(u => {
      const btn = document.createElement("button");
      btn.innerHTML = `${u} <small style='color:gray'>${allUsers[u].lastSeen || 'Offline'}</small>`;
      btn.onclick = () => {
        if (currentChat !== u) {
          closeChat();
          setTimeout(() => openChat(u), 310);
        }
      };
      users.appendChild(btn);
    });

  // ‚úÖ All groups section
  Object.keys(allGroups)
    .filter(id => {
      const g = allGroups[id];
      return g?.name && g.name.toLowerCase().includes(term);
    })
    .sort((a, b) => allGroups[a].name.localeCompare(allGroups[b].name))
    .forEach(id => {
      const g = allGroups[id];
      const btn = document.createElement("button");
      btn.className = "group";
      btn.innerHTML = `${g.public ? "# " : "üîí "}${g.name}`;
      btn.onclick = () => {
        if (currentChat !== "group_" + id) {
          closeChat();
          setTimeout(() => {
            db.ref("groups/" + id + "/members/" + user).set(true);
            openGroup(id, g.name);
          }, 310);
        }
      };
      groups.appendChild(btn);
    });
}

// üîì Join or open group
function joinGroup(groupName) {
  const group = allGroups[groupName];
  if (!group) return;
  if (!group.public) {
    const pwd = prompt("Enter password for private group:");
    if (pwd !== group.password) return alert("Wrong password.");
  }
  db.ref("groups/" + groupName + "/members/" + user).set(true);
  openGroup(groupName, group.name);
}

// üìÇ Open private chat
function openChat(to) {
  currentChat = to;
  document.getElementById("chatWith").textContent = toUser;
  document.getElementById("chatWindow").classList.add("active");
  document.getElementById("chatWindow").style.display = "flex";
  messagesDiv.innerHTML = "";
  const cid = chatId(user, to);

  if (convoRef) convoRef.off();
  if (typingRef) typingRef.off();

  convoRef = db.ref("chats/" + cid);
  convoRef.on("child_added", s => renderMsg(s.key, s.val(), false, cid));

  typingRef = db.ref("typing/" + cid + "/" + to);
  typingRef.on("value", s => {
    document.getElementById("typingIndicator").style.display = s.val() ? "block" : "none";
  });

  db.ref(`seen/${cid}/${user}`).set(Date.now());
  db.ref("recentChats/" + user + "/" + toUser).set(Date.now());
}

// üìÇ Open group chat
function openGroup(name, label) {
  currentChat = "group_" + name;
  document.getElementById("chatWith").textContent = label;
  document.getElementById("chatWindow").classList.add("active");
  document.getElementById("chatWindow").style.display = "flex";
  messagesDiv.innerHTML = "";

  if (convoRef) convoRef.off();
  convoRef = db.ref("groupChats/" + name);
  convoRef.on("child_added", s => renderMsg(s.key, s.val(), true, name));

db.ref("recentChats/" + user + "/group_" + id).set(Date.now());
}
function closeChat() {
  const chatWindow = document.getElementById("chatWindow");
  chatWindow.classList.remove("active");

  setTimeout(() => {
    chatWindow.style.display = "none";
    messagesDiv.innerHTML = "";
    currentChat = "";
    lastMsgDate = ""; // reset floating date header
  }, 300);
}

// üßæ Render a message
function renderMsg(id, msg, isGroup = false, groupId = "") {
  if (!msg || msg.deletedFor?.[user]) return;
  const div = document.createElement("div");
  div.className = "msg " + (msg.from === user ? "you" : "them");

  let inner = "";
  if (msg.replyTo) {
    inner += `<div style="font-size:12px;color:gray;border-left:3px solid #ccc;padding-left:5px">
      <b>${msg.replyTo.from}</b>: ${msg.replyTo.text}</div>`;
  }
  if (isGroup && msg.from !== user) inner += `<b>${msg.from}:</b> `;
  inner += msg.deleted ? "<i>Message deleted</i>" : msg.text;

  const ts = new Date(msg.ts);
  const time = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const status = msg.from === user
    ? (msg.readBy?.[currentChat] ? "‚úì‚úì‚úì" : msg.deliveredTo?.[currentChat] ? "‚úì‚úì" : "‚úì")
    : "";

  inner += `<div class="msg-time">${time} <span class="msg-status">${status}</span></div>`;

  div.innerHTML = inner;
  div.dataset.id = id;
  div.dataset.ts = msg.ts;
  div.dataset.from = msg.from;
  div.dataset.text = msg.text;
  div.addEventListener("contextmenu", e => {
    e.preventDefault();
    showMsgOptions(id, msg, isGroup, groupId, div, e.pageX, e.pageY);
  });

  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  // ‚úÖ Mark as read
  if (msg.from !== user && !msg.readBy?.[user]) {
    const ref = isGroup
      ? db.ref("groupChats/" + groupId + "/" + id + "/readBy/" + user)
      : db.ref("chats/" + chatId(user, currentChat) + "/" + id + "/readBy/" + user);
    ref.set(true);
  }
}
    </script>
    <script>
// ‚úçÔ∏è Typing indicator (only in 1-on-1)
msgBox.addEventListener("input", () => {
  if (!currentChat || currentChat.startsWith("group_")) return;
  const id = chatId(user, currentChat);
  db.ref("typing/" + id + "/" + user).set(true);
  setTimeout(() => db.ref("typing/" + id + "/" + user).set(false), 1500);
});

// ‚úâÔ∏è Send message
function sendMsg() {
  const text = msgBox.value.trim();
  if (!text || !currentChat) return;

  const msg = {
    from: user,
    text,
    ts: Date.now()
  };

  if (replyingTo) {
    msg.replyTo = { ...replyingTo };
  }

  if (currentChat.startsWith("group_")) {
    db.ref("groupChats/" + currentChat.slice(6)).push(msg);
  } else {
    const id = chatId(user, currentChat);
    db.ref("chats/" + id).push(msg);
  }

  msgBox.value = "";
  replyingTo = null;
}

// üìã Message right-click options
function showMsgOptions(id, msg, isGroup, groupId, div, x = 100, y = 100) {
  const m = document.getElementById("msgMenu");
  m.innerHTML = "";
  m.style.left = (x + 240 > window.innerWidth ? window.innerWidth - 260 : x) + "px";
  m.style.top = (y + 180 > window.innerHeight ? window.innerHeight - 200 : y) + "px";
  m.style.display = "block";

  const closeMenu = () => m.style.display = "none";
  document.addEventListener("click", closeMenu, { once: true });

  const addBtn = (text, cb) => {
    const b = document.createElement("button");
    b.textContent = text;
    b.onclick = () => {
      closeMenu();
      cb();
    };
    m.appendChild(b);
  };

  if (msg.from === user && Date.now() - msg.ts < 60000) {
    addBtn("Edit", () => {
      const newText = prompt("Edit message:", msg.text);
      if (newText && newText !== msg.text) {
        const ref = isGroup
          ? db.ref("groupChats/" + groupId + "/" + id)
          : db.ref("chats/" + chatId(user, currentChat) + "/" + id);
        ref.update({ text: newText });
      }
    });

    addBtn("Delete for Everyone", () => {
      const ref = isGroup
        ? db.ref("groupChats/" + groupId + "/" + id)
        : db.ref("chats/" + chatId(user, currentChat) + "/" + id);
      ref.update({ deleted: true });
    });
  }
}

// üß† Swipe to reply (mobile)
let swipeTarget = null;
document.addEventListener("touchstart", e => {
  swipeTarget = e.target.closest(".msg");
  if (swipeTarget) swipeTarget.startX = e.touches[0].clientX;
});
document.addEventListener("touchend", e => {
  if (!swipeTarget) return;
  const endX = e.changedTouches[0].clientX;
  if (endX - swipeTarget.startX > 80) {
    swipeTarget.style.borderLeft = "4px solid #25D366";
    replyingTo = {
      from: swipeTarget.dataset.from,
      text: swipeTarget.dataset.text,
      ts: swipeTarget.dataset.ts
    };
  }
  swipeTarget = null;
});

// üì§ Chat title click menu
document.getElementById("chatWith").addEventListener("click", e => {
  const menu = document.getElementById("chatTitleMenu");
  const isGroup = currentChat.startsWith("group_");

  menu.innerHTML = "";
  if (isGroup) {
    addTitleBtn("Leave Group", () => {
      const groupId = currentChat.slice(6);
      db.ref("groups/" + groupId + "/members/" + user).remove();
      alert("You left the group.");
      closeChat();
    });
    addTitleBtn("View Members", () => {
      const groupId = currentChat.slice(6);
      db.ref("groups/" + groupId + "/members").once("value", snap => {
        const members = Object.keys(snap.val() || {}).join(", ");
        alert("Members:\n" + members);
      });
    });
  } else {
    addTitleBtn("Delete Chat", () => {
      if (confirm("Delete chat with " + currentChat + "?")) {
        const path = chatId(user, currentChat);
        db.ref("chats/" + path).remove();
        closeChat();
      }
    });
    addTitleBtn("Block User", () => {
      alert("Blocking feature coming soon.");
    });
  }

  menu.style.left = e.pageX + "px";
  menu.style.top = e.pageY + "px";
  menu.style.display = "block";
});

function addTitleBtn(text, cb) {
  const btn = document.createElement("button");
  btn.textContent = text;
  btn.onclick = cb;
  document.getElementById("chatTitleMenu").appendChild(btn);
}
    </script>
    <script>
// üïò Format timestamp properly
function formatTime(ts) {
  try {
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  } catch {
    return "";
  }
}

function formatDateLabel(ts) {
  const d = new Date(ts);
  const today = new Date();
  if (d.toDateString() === today.toDateString()) return "Today";
  today.setDate(today.getDate() - 1);
  if (d.toDateString() === today.toDateString()) return "Yesterday";
  return d.toLocaleDateString();
}

// üßæ Enhanced renderMessage with floating date headers
let lastMsgDate = "";
function renderMessage(id, msg, isGroup = false, groupId = "") {
  if (!msg || msg.deletedFor?.[user]) return;

  const dateLabel = formatDateLabel(msg.ts);
  if (dateLabel !== lastMsgDate) {
    const dateDiv = document.createElement("div");
    dateDiv.textContent = dateLabel;
    dateDiv.style.cssText = "text-align:center;color:gray;font-size:12px;margin:6px 0;";
    messagesDiv.appendChild(dateDiv);
    lastMsgDate = dateLabel;
  }

  const div = document.createElement("div");
  div.className = "msg " + (msg.from === user ? "you" : "them");
  div.dataset.id = id;
  div.dataset.ts = msg.ts;
  div.dataset.from = msg.from;
  div.dataset.text = msg.text;

  let inner = "";
  if (msg.deleted) {
    inner = "<i>This message was deleted</i>";
  } else {
    if (msg.replyTo) {
      inner += `<div style="font-size:12px;color:gray;border-left:3px solid #ccc;padding-left:5px">
      <b>${msg.replyTo.from}</b>: ${msg.replyTo.text}</div>`;
    }
    if (isGroup && msg.from !== user) inner += `<b>${msg.from}:</b> `;
    inner += msg.text;
  }

  const status = msg.from === user
    ? (msg.readBy?.[currentChat] ? "‚úì‚úì‚úì" : msg.deliveredTo?.[currentChat] ? "‚úì‚úì" : "‚úì")
    : "";

  inner += `<div class="msg-time">${formatTime(msg.ts)} <span class="msg-status">${status}</span></div>`;
  div.innerHTML = inner;

  // Right-click
  div.addEventListener("contextmenu", e => {
    e.preventDefault();
    showMsgOptions(id, msg, isGroup, groupId, div, e.pageX, e.pageY);
  });

  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  // Mark as read
  if (msg.from !== user && !msg.readBy?.[user]) {
    const ref = isGroup
      ? db.ref("groupChats/" + groupId + "/" + id + "/readBy/" + user)
      : db.ref("chats/" + chatId(user, currentChat) + "/" + id + "/readBy/" + user);
    ref.set(true);
  }
}

// üßπ Remove unused call elements
document.getElementById("callOverlay")?.remove();
document.getElementById("localVideo")?.remove();
document.getElementById("remoteVideo")?.remove();
document.getElementById("incomingControls")?.remove();
document.getElementById("ongoingControls")?.remove();
document.querySelector("button[onclick^='startCall']")?.remove();

// ‚òÅÔ∏è Push recentChats to Firebase (optional, shown here for extension)
function updateRecentInDB() {
  db.ref("users/" + user + "/recent").set(recentChats);
}

// Hook after every open
function updateRecent(chatId) {
  recentChats[chatId] = Date.now();
  localStorage.setItem("recentChats", JSON.stringify(recentChats));
  updateRecentInDB();
}
document.getElementById("searchBox").addEventListener("input", refreshList);
const searchBox = document.getElementById("searchBox");
const clearSearch = document.getElementById("clearSearch");

searchBox.addEventListener("input", () => {
  refreshList();
  clearSearch.style.display = searchBox.value ? "block" : "none";
});

clearSearch.addEventListener("click", () => {
  searchBox.value = "";
  refreshList();
  clearSearch.style.display = "none";
});

// Hide "√ó" initially if empty
clearSearch.style.display = "none";
function formatLastSeen(timestamp) {
  if (!timestamp) return "Offline";
  const now = new Date();
  const date = new Date(timestamp);

  const isToday = now.toDateString() === date.toDateString();
  const isYesterday = new Date(now - 86400000).toDateString() === date.toDateString();

  const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  if (isToday) return `Today at ${time}`;
  if (isYesterday) return `Yesterday at ${time}`;
  return `${date.toLocaleDateString()} at ${time}`;
}
    </script>
</body>
</html>
