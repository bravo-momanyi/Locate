<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bravo Chat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }
    header button {
      background: #25D366;
      border: none;
      padding: 6px 10px;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    #userList input {
      width: 100%;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #userList button {
      width: 100%;
      margin-bottom: 5px;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0f7fa;
    }
    #userList button.group {
      background: #dcedc8;
      font-weight: bold;
    }
    #chatWindow {
      display: none;
      flex-direction: column;
      height: 100%;
      flex: 1;
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
    }
    .msg {
      padding: 8px;
      margin: 5px;
      border-radius: 7px;
      max-width: 70%;
      word-wrap: break-word;
      position: relative;
    }
    .you {
      background: #dcf8c6;
      align-self: flex-end;
      margin-left: auto;
      text-align: right;
    }
    .them {
      background: white;
      align-self: flex-start;
      margin-right: auto;
    }
    .msg-time {
      font-size: 10px;
      color: #999;
      display: block;
      margin-top: 2px;
    }
    #sendBar {
      display: flex;
      padding: 10px;
      background: #fff;
    }
    #sendBar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    #sendBar button {
      margin-left: 5px;
      padding: 8px 12px;
      background: #25D366;
      border: none;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      #userList {
        width: 100%;
      }
      #chatWindow {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        display: none;
        flex-direction: column;
        background: white;
        z-index: 100;
      }
    }
    #typingIndicator {
      font-size: 12px;
      padding-left: 10px;
      color: #888;
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Welcome</div>
    <button onclick="goToDashboard()">Dashboard</button>
  </header>

  <div style="display: flex; height: calc(100% - 50px);">
    <div id="userList" style="width: 30%; overflow-y: auto; padding: 10px; border-right: 1px solid #ccc;">
      <input id="searchBox" placeholder="Search users/groups..." />
      <button onclick="createGroup()">Create Group</button>
      <div id="recentChats"></div>
      <div id="userSection"></div>
      <div id="groupSection"></div>
    </div>

    <div id="chatWindow">
      <div style="padding: 10px; background: #128C7E; color: white;">
        <span id="chatWith">---</span>
        <button onclick="startCall('voice')">ðŸ“ž</button>
        <button onclick="startCall('video')">ðŸŽ¥</button>
        <button onclick="closeChat()" style="float: right;">âœ–</button>
      </div>
      <div id="typingIndicator" style="display:none;">Typing...</div>
      <div id="messages"></div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type message..." />
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase & Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // User session
  let user = sessionStorage.getItem('username');
  if (!user) location.href = "index.html"; // silently redirect, don't prompt

  document.getElementById("currentUser").textContent = "Welcome, " + user;

  function goToDashboard() {
    sessionStorage.setItem('username', user);
    location.href = "app.html";
  }

  let currentChat = "", convoRef = null, typingRef = null;
  let allUsers = {}, allGroups = {}, recentChats = {};

  const searchBox = document.getElementById('searchBox');
  const userListDiv = document.getElementById('userSection');
  const groupListDiv = document.getElementById('groupSection');
  const recentChatsDiv = document.getElementById('recentChats');

  searchBox.addEventListener('input', refreshList);

  db.ref('users').on('value', snap => {
    allUsers = snap.val() || {};
    refreshList();
  });

  db.ref('groups').on('value', snap => {
    allGroups = snap.val() || {};
    refreshList();
  });

  function refreshList() {
    const term = searchBox.value.toLowerCase();
    userListDiv.innerHTML = "<h4>All Users</h4>";
    groupListDiv.innerHTML = "<h4>All Groups</h4>";
    recentChatsDiv.innerHTML = "<h4>Recent Chats</h4>";

    // Sort recent chats by timestamp desc
    const sortedChats = Object.entries(recentChats).sort((a, b) => b[1] - a[1]);
    sortedChats.forEach(([id, ts]) => {
      const name = id.startsWith("group_") ? allGroups[id.slice(6)]?.name || "Group" : id;
      const btn = document.createElement('button');
      btn.textContent = name;
      btn.onclick = () => id.startsWith("group_") ? openGroup(id.slice(6), name) : openChat(name);
      recentChatsDiv.appendChild(btn);
    });

    for (const u in allUsers) {
      if (u !== user && u.toLowerCase().includes(term)) {
        const btn = document.createElement('button');
        btn.textContent = u;
        btn.onclick = () => openChat(u);
        userListDiv.appendChild(btn);
      }
    }

    for (const id in allGroups) {
      const g = allGroups[id];
      if (!g || !g.name) continue;
      const label = g.public ? `# ${g.name}` : `ðŸ”’ ${g.name}`;
      if (g.name.toLowerCase().includes(term)) {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.className = 'group';
        btn.onclick = () => attemptJoinGroup(id, g.name);
        groupListDiv.appendChild(btn);
      }
    }
  }

  function createGroup() {
    let name = prompt("Group name:");
    if (!name) return;
    const type = prompt("public or private:").toLowerCase();
    if (type !== "public" && type !== "private") return;

    const data = {
      name,
      admin: user,
      public: type === "public",
      password: type === "private" ? prompt("Group password:") : null,
      members: { [user]: true }
    };

    const ref = db.ref("groups").push();
    ref.set(data);
    db.ref("groupChats/" + ref.key).push({ from: "System", text: `${user} created the group`, ts: Date.now() });
  }

  function attemptJoinGroup(id, name) {
    db.ref("groups/" + id).once("value").then(snap => {
      const group = snap.val();
      if (!group) return;
      if (group.members && group.members[user]) return openGroup(id, name);

      if (!group.public) {
        const pwd = prompt("Enter password:");
        if (pwd !== group.password) return alert("Wrong password.");
      }

      db.ref(`groups/${id}/members/${user}`).set(true);
      openGroup(id, name);
    });
  }

  function chatId(a, b) {
    return [a, b].sort().join("_");
  }

  function openChat(toUser) {
    currentChat = toUser;
    document.getElementById("chatWith").textContent = toUser;
    document.getElementById("chatWindow").style.display = "flex";
    document.getElementById("messages").innerHTML = "";
    document.getElementById("typingIndicator").style.display = "none";
    if (convoRef) convoRef.off();
    if (typingRef) typingRef.off();

    const id = chatId(user, toUser);
    convoRef = db.ref("chats/" + id);
    convoRef.on("child_added", snap => renderMessage(snap.key, snap.val()));

    typingRef = db.ref(`typing/${id}/${toUser}`);
    typingRef.on("value", snap => {
      document.getElementById("typingIndicator").style.display = snap.val() ? "block" : "none";
    });

    recentChats[toUser] = Date.now();
  }

  function openGroup(id, name) {
    currentChat = "group_" + id;
    document.getElementById("chatWith").textContent = name;
    document.getElementById("chatWindow").style.display = "flex";
    document.getElementById("messages").innerHTML = "";
    document.getElementById("typingIndicator").style.display = "none";
    if (convoRef) convoRef.off();

    convoRef = db.ref("groupChats/" + id);
    convoRef.on("child_added", snap => renderMessage(snap.key, snap.val(), true, id));

    recentChats["group_" + id] = Date.now();
  }

  function renderMessage(id, msg, isGroup = false, groupId = "") {
    if (!msg || msg.deletedFor?.[user]) return;

    const div = document.createElement("div");
    div.className = "msg " + (msg.from === user ? "you" : "them");
    div.innerHTML = (isGroup && msg.from !== user ? `<b>${msg.from}:</b> ` : "") + msg.text;

    const ts = document.createElement("span");
    ts.className = "msg-time";
    ts.textContent = new Date(msg.ts).toLocaleTimeString();
    div.appendChild(ts);

    div.dataset.id = id;
    div.dataset.from = msg.from;
    div.dataset.ts = msg.ts;

    div.addEventListener("contextmenu", e => {
      e.preventDefault();
      showMsgOptions(id, msg, isGroup, groupId, div);
    });

    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = 999999;
  }

  function showMsgOptions(id, msg, isGroup, groupId, div) {
    const opts = [];
    if (msg.from === user && Date.now() - msg.ts < 60000) {
      opts.push("Edit", "Delete for Everyone");
    }
    opts.push("Delete for Me");

    const choice = prompt("Choose:\n" + opts.join("\n"));
    const ref = isGroup ? db.ref(`groupChats/${groupId}/${id}`) : db.ref(`chats/${chatId(user, currentChat)}/${id}`);

    if (choice === "Delete for Everyone") {
      ref.set({ text: "This message was deleted", from: msg.from, ts: msg.ts, deleted: true });
    } else if (choice === "Delete for Me") {
      ref.child("deletedFor/" + user).set(true);
      div.remove();
    } else if (choice === "Edit") {
      const newText = prompt("Edit message:", msg.text);
      if (newText && newText !== msg.text) {
        ref.update({ text: newText });
      }
    }
  }

  function sendMsg() {
    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if (!text || !currentChat) return;

    const msg = {
      from: user,
      text,
      ts: Date.now()
    };

    if (currentChat.startsWith("group_")) {
      db.ref("groupChats/" + currentChat.slice(6)).push(msg);
    } else {
      db.ref("chats/" + chatId(user, currentChat)).push(msg);
      db.ref(`typing/${chatId(user, currentChat)}/${user}`).set(false);
    }

    input.value = "";
  }

  // Typing indicator
  const msgInput = document.getElementById("msgInput");
  msgInput.addEventListener("input", () => {
    if (!currentChat || currentChat.startsWith("group_")) return;
    const typingPath = `typing/${chatId(user, currentChat)}/${user}`;
    db.ref(typingPath).set(true);
    setTimeout(() => db.ref(typingPath).set(false), 1500);
  });

  function closeChat() {
    if (convoRef) convoRef.off();
    if (typingRef) typingRef.off();
    document.getElementById("chatWindow").style.display = "none";
  }

  function startCall(type) {
    alert(`${type === 'voice' ? 'Voice' : 'Video'} call coming soon.`);
  }

  document.getElementById("chatWith").onclick = function () {
    if (!currentChat) return;
    if (!currentChat.startsWith("group_")) {
      const choice = prompt("1. Block User\n2. Delete Chat");
      if (choice === "2") {
        db.ref("chats/" + chatId(user, currentChat)).remove();
        closeChat();
      }
    } else {
      const groupId = currentChat.slice(6);
      db.ref("groups/" + groupId).once("value").then(snap => {
        const g = snap.val();
        if (!g) return;
        const isAdmin = g.admin === user;
        let options = "1. View Members\n2. Leave Group";
        if (isAdmin) options += "\n3. Remove Member\n4. Delete Group";
        const choice = prompt(options);
        if (choice === "1") alert("Members:\n" + Object.keys(g.members).join("\n"));
        else if (choice === "2") {
          db.ref(`groups/${groupId}/members/${user}`).remove();
          closeChat();
        } else if (choice === "3" && isAdmin) {
          const who = prompt("Remove who?");
          if (who && g.members[who]) {
            db.ref(`groups/${groupId}/members/${who}`).remove();
            db.ref(`groupChats/${groupId}`).push({ from: "System", text: `${who} was removed`, ts: Date.now() });
          }
        } else if (choice === "4" && isAdmin) {
          db.ref("groups/" + groupId).remove();
          db.ref("groupChats/" + groupId).remove();
          closeChat();
        }
      });
    }
  };
</script>
</body>
</html>
