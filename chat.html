<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bravo Chat Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: #fff;
      padding: 10px 15px;
      font-weight: bold;
    }

    #main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    #sidebar {
      width: 30%;
      border-right: 1px solid #ccc;
      padding: 10px;
      display: flex;
      flex-direction: column;
      background: #f9f9f9;
      overflow-y: auto;
    }

    #sidebar input {
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .chat-entry {
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 6px;
      background: #e0f2f1;
      cursor: pointer;
    }

    .chat-entry.group { background: #dcedc8; }

    #chatWindow {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #chatHeader {
      padding: 10px;
      background: #128C7E;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #chatWith {
      font-weight: bold;
      cursor: pointer;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
    }

    .msg {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 12px;
      margin: 6px 0;
      position: relative;
      display: inline-block;
      word-wrap: break-word;
    }

    .you {
      align-self: flex-end;
      background: #dcf8c6;
      text-align: right;
    }

    .them {
      align-self: flex-start;
      background: #fff;
    }

    .msg-time {
      font-size: 10px;
      color: gray;
      display: block;
      margin-top: 4px;
    }

    .tick {
      font-size: 12px;
      margin-left: 5px;
      color: gray;
    }

    #sendBar {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ccc;
    }

    #msgInput {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }

    #sendBtn {
      margin-left: 5px;
      padding: 10px 16px;
      border: none;
      border-radius: 20px;
      background: #25D366;
      color: white;
      cursor: pointer;
    }

    .typing {
      font-size: 12px;
      color: #555;
      margin: 5px 10px;
    }

    @media (max-width: 600px) {
      #sidebar {
        display: none;
      }
      #chatWindow {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <span id="currentUser">Welcome</span>
    <button onclick="goToDashboard()">Dashboard</button>
  </header>

  <div id="main">
    <div id="sidebar">
      <input id="searchBox" placeholder="Search chats..." />
      <div id="recentChats"><h3>Recent</h3></div>
      <div id="allUsers"><h3>Users</h3></div>
      <div id="allGroups"><h3>Groups</h3></div>
    </div>

    <div id="chatWindow">
      <div id="chatHeader">
        <span id="chatWith">--</span>
        <span>
          <button onclick="startCall('voice')">📞</button>
          <button onclick="startCall('video')">🎥</button>
          <button onclick="closeChat()">✖</button>
        </span>
      </div>
      <div id="messages"></div>
      <div class="typing" id="typingIndicator" style="display:none">Typing...</div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type a message..." />
        <button id="sendBtn" onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase + Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = sessionStorage.getItem('username');
    if (!user) {
      location.href = "index.html";
    }
    document.getElementById("currentUser").textContent = "Welcome, " + user;

    function goToDashboard() {
      sessionStorage.setItem("username", user);
      location.href = "app.html";
    }

    // Global references
    const searchBox = document.getElementById('searchBox');
    const recentDiv = document.getElementById('recentChats');
    const userDiv = document.getElementById('allUsers');
    const groupDiv = document.getElementById('allGroups');
    const chatWith = document.getElementById("chatWith");
    const messagesDiv = document.getElementById("messages");
    const typingDiv = document.getElementById("typingIndicator");
    const input = document.getElementById("msgInput");

    let currentChat = null, convoRef = null, typingRef = null;
    let recentChats = {};
    let typingTimeout;

    // Load users and groups
    let users = {}, groups = {};

    db.ref("users").on("value", snap => {
      users = snap.val() || {};
      renderUsers();
    });

    db.ref("groups").on("value", snap => {
      groups = snap.val() || {};
      renderGroups();
    });

    // Track recent chats
    db.ref("recent/" + user).on("value", snap => {
      recentChats = snap.val() || {};
      renderRecent();
    });

    function renderUsers() {
      userDiv.innerHTML = "<h3>Users</h3>";
      const term = searchBox.value.trim().toLowerCase();
      for (let u in users) {
        if (u !== user && u.toLowerCase().includes(term)) {
          const btn = document.createElement("div");
          btn.className = "chat-entry";
          btn.textContent = u;
          btn.onclick = () => openChat(u);
          userDiv.appendChild(btn);
        }
      }
    }

    function renderGroups() {
      groupDiv.innerHTML = "<h3>Groups</h3>";
      const term = searchBox.value.trim().toLowerCase();
      for (let g in groups) {
        const grp = groups[g];
        if (!grp.name.toLowerCase().includes(term)) continue;
        const label = grp.public ? `# ${grp.name}` : `🔒 ${grp.name}`;
        const btn = document.createElement("div");
        btn.className = "chat-entry group";
        btn.textContent = label;
        btn.onclick = () => joinGroup(g, grp);
        groupDiv.appendChild(btn);
      }
    }

    function renderRecent() {
      recentDiv.innerHTML = "<h3>Recent</h3>";
      const items = Object.entries(recentChats)
        .sort((a, b) => b[1].last - a[1].last)
        .slice(0, 20);

      for (let [id, info] of items) {
        const btn = document.createElement("div");
        btn.className = "chat-entry";
        btn.textContent = info.name;
        btn.onclick = () => {
          if (info.type === 'user') openChat(info.name);
          else joinGroup(id, groups[id]);
        };
        recentDiv.appendChild(btn);
      }
    }

    function openChat(other) {
      currentChat = other;
      chatWith.textContent = other;
      messagesDiv.innerHTML = "";
      if (convoRef) convoRef.off();
      if (typingRef) typingRef.off();

      const chatPath = `chats/${[user, other].sort().join("_")}`;
      convoRef = db.ref(chatPath);
      convoRef.on("child_added", snap => renderMsg(snap.key, snap.val(), chatPath));
      typingRef = db.ref("typing/" + other + "/" + user);
      typingRef.on("value", snap => {
        typingDiv.style.display = snap.val() ? "block" : "none";
      });

      db.ref("recent/" + user + "/" + other).set({ name: other, type: 'user', last: Date.now() });
    }

    function joinGroup(groupId, groupData) {
      if (groupData.public || (groupData.members && groupData.members[user])) {
        loadGroup(groupId, groupData.name);
        db.ref(`groups/${groupId}/members/${user}`).set(true);
        db.ref("recent/" + user + "/" + groupId).set({ name: groupData.name, type: 'group', last: Date.now() });
      } else {
        const pwd = prompt("Group password:");
        if (pwd === groupData.password) {
          db.ref(`groups/${groupId}/members/${user}`).set(true);
          loadGroup(groupId, groupData.name);
        } else {
          alert("Wrong password.");
        }
      }
    }

    function loadGroup(groupId, name) {
      currentChat = groupId;
      chatWith.textContent = name;
      messagesDiv.innerHTML = "";
      if (convoRef) convoRef.off();

      convoRef = db.ref("groupChats/" + groupId);
      convoRef.on("child_added", snap => renderMsg(snap.key, snap.val(), "groupChats/" + groupId));
    }

    function sendMsg() {
      const text = input.value.trim();
      if (!text || !currentChat) return;

      const ts = Date.now();
      const msg = { from: user, text, ts, status: 'sent' };

      if (currentChat.length < 20) {
        const ref = db.ref(`chats/${[user, currentChat].sort().join("_")}`).push();
        ref.set(msg);
        db.ref(`recent/${user}/${currentChat}`).set({ name: currentChat, type: 'user', last: ts });
        db.ref(`recent/${currentChat}/${user}`).set({ name: user, type: 'user', last: ts });
      } else {
        db.ref(`groupChats/${currentChat}`).push(msg);
        db.ref(`recent/${user}/${currentChat}`).set({ name: chatWith.textContent, type: 'group', last: ts });
      }

      input.value = "";
      db.ref("typing/" + user + "/" + currentChat).set(false);
    }

    function renderMsg(id, msg, path) {
      if (!msg || msg.deletedFor && msg.deletedFor[user]) return;

      const div = document.createElement("div");
      div.className = "msg " + (msg.from === user ? "you" : "them");
      div.innerHTML = `<span>${msg.text}</span><br>
        <span class="msg-time">${new Date(msg.ts).toLocaleTimeString()} 
        ${msg.status === 'read' ? '✔✔' : '✔'}</span>`;
      div.dataset.id = id;

      div.oncontextmenu = (e) => {
        e.preventDefault();
        let options = [];
        if (msg.from === user && Date.now() - msg.ts < 60000) {
          options.push("Edit", "Delete for Everyone");
        }
        options.push("Delete for Me");

        const choice = prompt("Choose:\n" + options.join("\n"));
        if (choice === "Delete for Everyone") {
          db.ref(`${path}/${id}`).set({
            from: msg.from,
            text: "This message was deleted",
            ts: msg.ts,
            deleted: true
          });
        } else if (choice === "Delete for Me") {
          div.remove();
          db.ref(`${path}/${id}/deletedFor/${user}`).set(true);
        } else if (choice === "Edit") {
          const newText = prompt("Edit message:", msg.text);
          if (newText) {
            db.ref(`${path}/${id}/text`).set(newText + " ✏️");
          }
        }
      };

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = 999999;
    }

    input.oninput = () => {
      db.ref("typing/" + user + "/" + currentChat).set(input.value.trim() !== "");
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        db.ref("typing/" + user + "/" + currentChat).set(false);
      }, 3000);
    };

    function closeChat() {
      currentChat = null;
      messagesDiv.innerHTML = "";
      chatWith.textContent = "--";
      if (convoRef) convoRef.off();
      if (typingRef) typingRef.off();
    }

    function startCall(type) {
      alert(`${type.toUpperCase()} call feature coming soon.`);
    }

    chatWith.onclick = () => {
      if (!currentChat) return;
      if (currentChat.length < 20) {
        const opt = prompt("1. Block\n2. Delete Chat");
        if (opt === "2" && confirm("Delete chat?")) {
          db.ref("chats/" + [user, currentChat].sort().join("_")).remove();
          db.ref("recent/" + user + "/" + currentChat).remove();
          closeChat();
        }
      } else {
        db.ref("groups/" + currentChat).once("value", snap => {
          const g = snap.val();
          if (!g) return;
          let opt = "1. View Members\n2. Leave Group";
          if (g.admin === user) opt += "\n3. Remove Member\n4. Delete Group";
          const choice = prompt(opt);
          if (choice === "1") {
            alert("Members:\n" + Object.keys(g.members || {}).join("\n"));
          } else if (choice === "2") {
            db.ref(`groups/${currentChat}/members/${user}`).remove();
            closeChat();
          } else if (choice === "3") {
            const who = prompt("Remove who?");
            db.ref(`groups/${currentChat}/members/${who}`).remove();
          } else if (choice === "4") {
            db.ref("groups/" + currentChat).remove();
            db.ref("groupChats/" + currentChat).remove();
            closeChat();
          }
        });
      }
    };

    // Push Notification (basic support)
    if ("Notification" in window) {
      Notification.requestPermission();
    }

    function notify(title, body) {
      if (Notification.permission === "granted") {
        new Notification(title, { body });
      }
    }

    // Register service worker for notification (optional)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.log);
    }
  </script>
</body>
</html>
