<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bravo Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    #main {
      display: flex;
      height: 100vh;
    }
    #sidebar {
      width: 300px;
      background: #ffffff;
      border-right: 1px solid #ccc;
      overflow-y: auto;
    }
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #e5ddd5;
    }
    .chat-header {
      background: #075E54;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }
    .msg {
      padding: 6px 10px;
      margin: 5px 0;
      border-radius: 6px;
      max-width: 75%;
      position: relative;
      word-wrap: break-word;
    }
    .from-me {
      background: #DCF8C6;
      align-self: flex-end;
    }
    .from-them {
      background: white;
      align-self: flex-start;
    }
    .timestamp {
      font-size: 0.75em;
      color: #666;
      text-align: right;
    }
    .input-area {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 5px;
      background: #f7f7f7;
    }
    .input-area input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
    }
    .input-area button {
      padding: 10px 15px;
      margin-left: 5px;
      border: none;
      border-radius: 20px;
      background: #075E54;
      color: white;
      cursor: pointer;
    }
    .reply-tag {
      background: #fff3cd;
      color: #856404;
      padding: 5px;
      font-size: 0.9em;
      margin-bottom: 5px;
      border-left: 4px solid #ffc107;
    }
    .date-label {
      align-self: center;
      background: #d3d3d3;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 0.85em;
      margin: 10px 0;
    }
  </style>
</head>
<body>
<div id="main">
  <div id="sidebar">
    <div style="background:#075E54;color:#fff;padding:10px;font-weight:bold;">Bravo Chat</div>
    <div id="userList"></div>
    <div id="groupList"></div>
  </div>
  <div id="chatArea">
    <div class="chat-header" id="chatHeader">
      <span id="chatWith">Select a chat</span>
      <button onclick="showChatOptions()">⋮</button>
    </div>
    <div id="messages"></div>
    <div id="replyTag" class="reply-tag" style="display:none;"></div>
    <div class="input-area">
      <input type="text" id="msgInput" placeholder="Type a message"/>
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  let currentUser = localStorage.getItem('currentUser') || prompt("Enter your username");
  if (!currentUser) location.reload();
  localStorage.setItem('currentUser', currentUser);
  let currentChat = null;
  let replyTo = null;
</script>
<script>
  const userListDiv = document.getElementById('userList');
  const groupListDiv = document.getElementById('groupList');
  const chatWithSpan = document.getElementById('chatWith');
  const messagesDiv = document.getElementById('messages');

  function loadUsersAndGroups() {
    db.ref('users').once('value', snap => {
      userListDiv.innerHTML = "<h4 style='padding:10px;'>Users</h4>";
      snap.forEach(child => {
        const uname = child.key;
        if (uname !== currentUser) {
          const div = document.createElement('div');
          div.innerText = uname;
          div.style.padding = "10px";
          div.style.borderBottom = "1px solid #eee";
          div.style.cursor = "pointer";
          div.onclick = () => openChat(uname, false);
          userListDiv.appendChild(div);
        }
      });
    });

    db.ref('groups').once('value', snap => {
      groupListDiv.innerHTML = "<h4 style='padding:10px;'>Groups</h4>";
      snap.forEach(child => {
        const groupId = child.key;
        const data = child.val();
        const div = document.createElement('div');
        div.innerText = data.name;
        div.style.padding = "10px";
        div.style.borderBottom = "1px solid #eee";
        div.style.cursor = "pointer";
        div.onclick = () => openChat(data.name, true);
        groupListDiv.appendChild(div);
      });
    });
  }

  function openChat(chatId, isGroup) {
    currentChat = { id: chatId, isGroup };
    chatWithSpan.innerText = isGroup ? `Group: ${chatId}` : chatId;
    messagesDiv.innerHTML = "";
    loadMessages();
    loadTypingIndicator();
  }

  function msgPath() {
    if (!currentChat) return null;
    return currentChat.isGroup
      ? `groupChats/${currentChat.id}`
      : `chats/${[currentUser, currentChat.id].sort().join("_")}`;
  }
        </script>
        <script>
  function sendMsg() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text || !currentChat) return;

    const path = msgPath();
    const msgKey = db.ref().child(path).push().key;
    const msgData = {
      from: currentUser,
      text,
      ts: Date.now(),
      readBy: { [currentUser]: Date.now() }
    };

    if (replyTo) msgData.replyTo = replyTo;
    db.ref(`${path}/${msgKey}`).set(msgData);

    if (!currentChat.isGroup) {
      db.ref(`recentChats/${currentUser}/${currentChat.id}`).set(Date.now());
      db.ref(`recentChats/${currentChat.id}/${currentUser}`).set(Date.now());
    }

    input.value = '';
    clearReplyTag();
  }

  function clearReplyTag() {
    replyTo = null;
    document.getElementById('replyTag').style.display = 'none';
    document.getElementById('replyTag').innerText = '';
  }

  function showReplyTag(msgObj) {
    replyTo = msgObj.text;
    const replyTag = document.getElementById('replyTag');
    replyTag.innerText = `Replying to: ${msgObj.text}`;
    replyTag.style.display = 'block';
  }
        </script>
        <script>
  function loadMessages() {
    const path = msgPath();
    if (!path) return;
    messagesDiv.innerHTML = "";

    db.ref(path).off(); // remove previous listener
    db.ref(path).on('child_added', snap => {
      const msg = snap.val();
      const div = document.createElement('div');
      const isMine = msg.from === currentUser;
      div.className = 'msg ' + (isMine ? 'from-me' : 'from-them');

      if (msg.replyTo) {
        const reply = document.createElement('div');
        reply.innerText = `↪ ${msg.replyTo}`;
        reply.style.fontSize = '0.8em';
        reply.style.color = '#555';
        div.appendChild(reply);
      }

      const textNode = document.createElement('div');
      textNode.innerText = msg.text;
      div.appendChild(textNode);

      const time = document.createElement('div');
      time.className = 'timestamp';
      time.innerText = new Date(msg.ts).toLocaleTimeString();
      div.appendChild(time);

      div.onclick = () => showReplyTag(msg);
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      markAsRead(snap.key);
    });
  }

  function markAsRead(msgKey) {
    const path = msgPath();
    if (!path || !msgKey) return;
    db.ref(`${path}/${msgKey}/readBy/${currentUser}`).set(Date.now());
  }
        </script>
        <script>
  const typingPath = () => currentChat && !currentChat.isGroup
    ? `typing/${[currentUser, currentChat.id].sort().join("_")}`
    : null;

  function startTyping() {
    const path = typingPath();
    if (!path) return;
    db.ref(`${path}/${currentUser}`).set(true);
    if (typingTimeout) clearTimeout(typingTimeout);
    typingTimeout = setTimeout(stopTyping, 2000);
  }

  function stopTyping() {
    const path = typingPath();
    if (!path) return;
    db.ref(`${path}/${currentUser}`).set(false);
  }

  function loadTypingIndicator() {
    const path = typingPath();
    if (!path) return;
    db.ref(path).on('value', snap => {
      const val = snap.val();
      if (!val) return;
      const typingDiv = document.getElementById('typingStatus');
      for (let user in val) {
        if (user !== currentUser && val[user]) {
          typingDiv.innerText = `${user} is typing...`;
          return;
        }
      }
      typingDiv.innerText = "";
    });
  }

  let typingTimeout = null;
  document.getElementById('msgInput').addEventListener('input', startTyping);
        </script>
        <script>
  let selectedMsgs = new Set();
  let rightClickMode = false;

  function renderMsgItem(msg, key) {
    const div = document.createElement('div');
    const isMine = msg.from === currentUser;
    div.className = 'msg ' + (isMine ? 'from-me' : 'from-them');
    div.dataset.key = key;

    if (msg.replyTo) {
      const reply = document.createElement('div');
      reply.innerText = `↪ ${msg.replyTo}`;
      reply.style.fontSize = '0.8em';
      reply.style.color = '#555';
      div.appendChild(reply);
    }

    const textNode = document.createElement('div');
    textNode.innerText = msg.text;
    div.appendChild(textNode);

    const time = document.createElement('div');
    time.className = 'timestamp';
    time.innerText = new Date(msg.ts).toLocaleTimeString();
    div.appendChild(time);

    div.onclick = () => {
      if (rightClickMode) toggleSelect(div, key);
      else showReplyTag(msg);
    };

    div.oncontextmenu = (e) => {
      e.preventDefault();
      rightClickMode = true;
      toggleSelect(div, key);
      showRightClickActions();
    };

    return div;
  }

  function toggleSelect(div, key) {
    if (selectedMsgs.has(key)) {
      selectedMsgs.delete(key);
      div.style.background = '';
    } else {
      selectedMsgs.add(key);
      div.style.background = '#e0e0e0';
    }
  }

  function showRightClickActions() {
    const header = document.getElementById('chatHeader');
    header.innerHTML = '';

    const copyBtn = document.createElement('button');
    copyBtn.innerText = 'Copy';
    copyBtn.onclick = () => {
      navigator.clipboard.writeText([...selectedMsgs].map(k => lastMsgs[k].text).join('\n'));
      resetRightClick();
    };

    const editBtn = document.createElement('button');
    editBtn.innerText = 'Edit';
    editBtn.disabled = selectedMsgs.size !== 1;
    editBtn.onclick = () => {
      const key = [...selectedMsgs][0];
      const msg = lastMsgs[key];
      if (msg.from === currentUser && Date.now() - msg.ts <= 60000) {
        document.getElementById('msgInput').value = msg.text;
        editingMsgKey = key;
      }
      resetRightClick();
    };

    const delBtn = document.createElement('button');
    delBtn.innerText = 'Delete';
    delBtn.onclick = () => {
      selectedMsgs.forEach(k => {
        const path = msgPath();
        if (lastMsgs[k].from === currentUser) {
          db.ref(`${path}/${k}`).update({ text: "🗑 Message deleted", deleted: true });
        }
      });
      resetRightClick();
    };

    const cancelBtn = document.createElement('button');
    cancelBtn.innerText = 'Cancel';
    cancelBtn.onclick = resetRightClick;

    header.append(copyBtn, editBtn, delBtn, cancelBtn);
  }

  function resetRightClick() {
    selectedMsgs.clear();
    rightClickMode = false;
    loadMessages(); // re-render
    document.getElementById('chatHeader').innerHTML = `<span id="chatWith">Select a chat</span>`;
  }

  let lastMsgs = {};
  let editingMsgKey = null;

  function loadMessages() {
    const path = msgPath();
    if (!path) return;
    messagesDiv.innerHTML = "";
    lastMsgs = {};

    db.ref(path).off();
    db.ref(path).on('child_added', snap => {
      const key = snap.key;
      const msg = snap.val();
      lastMsgs[key] = msg;
      const div = renderMsgItem(msg, key);
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      markAsRead(key);
    });

    db.ref(path).on('child_changed', snap => {
      const key = snap.key;
      const msg = snap.val();
      lastMsgs[key] = msg;
      const existing = messagesDiv.querySelector(`[data-key="${key}"]`);
      if (existing) {
        existing.replaceWith(renderMsgItem(msg, key));
      }
    });
  }
</script>
<script>
  let replyMsg = null;

  function showReplyTag(msg) {
    replyMsg = msg;
    const replyTag = document.getElementById('replyTag');
    replyTag.innerHTML = `Replying to: <b>${msg.text}</b> <button onclick="cancelReply()">✕</button>`;
    replyTag.style.display = 'block';
  }

  function cancelReply() {
    replyMsg = null;
    document.getElementById('replyTag').style.display = 'none';
  }

  function renderMsgItem(msg, key) {
    const div = document.createElement('div');
    const isMine = msg.from === currentUser;
    div.className = 'msg ' + (isMine ? 'from-me' : 'from-them');
    div.dataset.key = key;

    // Floating date headers
    const dateLabel = document.createElement('div');
    const msgDate = new Date(msg.ts).toDateString();
    if (!lastDateShown || lastDateShown !== msgDate) {
      dateLabel.className = 'date-label';
      dateLabel.innerText = msgDate;
      messagesDiv.appendChild(dateLabel);
      lastDateShown = msgDate;
    }

    // Reply to
    if (msg.replyTo) {
      const reply = document.createElement('div');
      reply.innerText = `↪ ${msg.replyTo}`;
      reply.style.fontSize = '0.8em';
      reply.style.color = '#555';
      div.appendChild(reply);
    }

    // Main message
    const textNode = document.createElement('div');
    textNode.innerText = msg.text;
    div.appendChild(textNode);

    // Timestamp + ticks
    const time = document.createElement('div');
    time.className = 'timestamp';
    time.innerText = new Date(msg.ts).toLocaleTimeString();
    if (isMine && !msg.deleted) {
      const tick = document.createElement('span');
      tick.innerText = getTickIcon(msg);
      tick.className = 'tick';
      time.appendChild(tick);
    }
    div.appendChild(time);

    div.onclick = () => {
      if (rightClickMode) toggleSelect(div, key);
      else showReplyTag(msg);
    };

    div.oncontextmenu = (e) => {
      e.preventDefault();
      rightClickMode = true;
      toggleSelect(div, key);
      showRightClickActions();
    };

    return div;
  }

  function getTickIcon(msg) {
    const readBy = msg.readBy || {};
    const total = currentChat.isGroup
      ? Object.keys(currentChat.members).length - 1
      : 1;

    const reads = Object.keys(readBy).length;
    if (reads >= total) return '✓✓✓';
    else if (reads > 0) return '✓✓';
    else return '✓';
  }

  function markAsRead(key) {
    const path = msgPath();
    db.ref(`${path}/${key}/readBy/${currentUser}`).set(Date.now());
  }

  let lastDateShown = null;
</script>

<style>
  .date-label {
    text-align: center;
    background: #eaeaea;
    padding: 5px;
    font-size: 0.9em;
    margin: 10px 0;
    border-radius: 5px;
  }
  .tick {
    margin-left: 10px;
    font-size: 1em;
    color: blue;
  }
</style>
<script>
  function setupChatHeader() {
    const header = document.getElementById('chatHeader');
    header.onclick = () => {
      const menu = document.createElement('div');
      menu.className = 'chat-menu';

      if (!currentChat) return;

      if (!currentChat.isGroup) {
        // One-to-one chat
        addMenuBtn(menu, "Block User", () => blockUser(currentChat.id));
        addMenuBtn(menu, "Delete Chat", () => deleteChat(currentChat.id));
      } else {
        // Group
        addMenuBtn(menu, "View Members", () => viewMembers(currentChat.id));
        addMenuBtn(menu, "Leave Group", () => leaveGroup(currentChat.id));
      }

      header.appendChild(menu);
    };
  }

  function addMenuBtn(container, label, action) {
    const btn = document.createElement('button');
    btn.innerText = label;
    btn.onclick = () => {
      action();
      container.remove();
    };
    container.appendChild(btn);
  }

  function blockUser(userId) {
    db.ref(`blocked/${currentUser}/${userId}`).set(true);
    alert(`${userId} blocked`);
  }

  function deleteChat(userId) {
    db.ref(`chats/${chatKey(currentUser, userId)}`).remove();
    db.ref(`recentChats/${currentUser}/${userId}`).remove();
    messagesDiv.innerHTML = '';
  }

  function viewMembers(groupId) {
    db.ref(`groups/${groupId}/members`).once('value', snap => {
      const members = snap.val();
      let html = `<div><h3>Group Members</h3>`;
      for (let user in members) {
        html += `<div>${user} ${members[user].admin ? '(Admin)' : ''}</div>`;
      }
      html += `</div>`;
      showModal(html);
    });
  }

  function leaveGroup(groupId) {
    db.ref(`groups/${groupId}/leaveRequests/${currentUser}`).set(true);
    alert("Request sent to admin.");
  }

  function showModal(contentHtml) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = contentHtml + '<button onclick="this.parentNode.remove()">Close</button>';
    document.body.appendChild(modal);
  }
</script>

<style>
  .chat-menu {
    position: absolute;
    top: 50px;
    right: 10px;
    background: white;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 999;
  }
  .modal {
    position: fixed;
    top: 20%;
    left: 20%;
    background: white;
    padding: 20px;
    border: 2px solid #333;
    z-index: 9999;
  }
</style>
<script>
  function viewMembers(groupId) {
    db.ref(`groups/${groupId}`).once('value', snap => {
      const group = snap.val();
      const isAdmin = group.admin === currentUser;
      let html = `<div><h3>Group Members</h3>`;
      for (let user in group.members) {
        html += `<div>
          ${user}
          ${user === group.admin ? ' (Admin)' : ''}
          ${isAdmin && user !== currentUser
            ? ` <button onclick="makeAdmin('${groupId}', '${user}')">Make Admin</button>
                <button onclick="removeFromGroup('${groupId}', '${user}')">Remove</button>`
            : ''
          }
        </div>`;
      }
      html += '</div>';

      if (isAdmin && group.leaveRequests) {
        html += '<hr><h4>Leave Requests</h4>';
        for (let requester in group.leaveRequests) {
          html += `<div>
            ${requester}
            <button onclick="confirmLeave('${groupId}', '${requester}')">Confirm</button>
            <button onclick="cancelLeave('${groupId}', '${requester}')">Cancel</button>
          </div>`;
        }
      }

      if (isAdmin) {
        html += `<hr><button onclick="deleteGroup('${groupId}')">Delete Group</button>`;
      }

      showModal(html);
    });
  }

  function makeAdmin(groupId, user) {
    db.ref(`groups/${groupId}/admin`).set(user);
    alert(`${user} is now admin`);
  }

  function removeFromGroup(groupId, user) {
    db.ref(`groups/${groupId}/members/${user}`).remove();
    db.ref(`groupChats/${groupId}`).once('value', snap => {
      const msgs = snap.val();
      for (let key in msgs) {
        db.ref(`groupChats/${groupId}/${key}/readBy/${user}`).remove();
      }
    });
    alert(`${user} removed`);
  }

  function confirmLeave(groupId, user) {
    db.ref(`groups/${groupId}/members/${user}`).remove();
    db.ref(`groups/${groupId}/leaveRequests/${user}`).remove();
    alert(`${user} removed from group`);
  }

  function cancelLeave(groupId, user) {
    db.ref(`groups/${groupId}/leaveRequests/${user}`).remove();
    alert(`Leave request by ${user} cancelled`);
  }

  function deleteGroup(groupId) {
    if (confirm("Are you sure you want to delete the group?")) {
      db.ref(`groups/${groupId}`).remove();
      db.ref(`groupChats/${groupId}`).remove();
      alert("Group deleted.");
      location.reload();
    }
  }
</script>
<script>
  function notifyUser(recipient, msg) {
    // Push Notification placeholder
    db.ref(`users/${recipient}/lastSeen`).once('value', snap => {
      const last = snap.val() || 0;
      if (Date.now() - last > 10000) {
        // User inactive > 10s
        new Notification(`New message from ${msg.from}`, {
          body: msg.text,
        });
      }
    });
  }

  function bindRealTimeListeners() {
    if (!currentChat) return;

    const path = msgPath();
    db.ref(path).off();

    db.ref(path).on('child_added', snap => {
      const msg = snap.val();
      const key = snap.key;
      if (!document.querySelector(`.msg[data-key="${key}"]`)) {
        const div = renderMsgItem(msg, key);
        messagesDiv.appendChild(div);
        markAsRead(key);
        scrollToBottom();
        if (msg.from !== currentUser) notifyUser(currentUser, msg);
      }
    });

    db.ref(path).on('child_changed', snap => {
      const key = snap.key;
      const updated = snap.val();
      const msgDiv = document.querySelector(`.msg[data-key="${key}"]`);
      if (msgDiv) {
        msgDiv.querySelector('div').innerText = updated.text || '[deleted]';
      }
    });

    db.ref(path).on('child_removed', snap => {
      const key = snap.key;
      const msgDiv = document.querySelector(`.msg[data-key="${key}"]`);
      if (msgDiv) msgDiv.remove();
    });
  }

  // Permission for notifications
  if ('Notification' in window && Notification.permission !== 'granted') {
    Notification.requestPermission();
  }

  // Setup everything after login
  function afterLoginSetup() {
    loadChats();
    setupChatHeader();
    bindRealTimeListeners();
  }

  afterLoginSetup();
</script>
</body>
</html>
