<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp Clone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <style>
    html, body { width: 100vw; height: 100vh; min-width: 0; overflow: hidden; }
    body { min-width: 0; }
    #mainContainer { display: flex; width: 100vw; height: 100vh; min-width: 0; }
    #sidebar {
      width: 320px;
      min-width: 220px;
      max-width: 400px;
      background: #f3f4f6;
      border-right: 1px solid #d1d5db;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
      transition: background 0.3s, color 0.3s;
    }
    #chatArea {
      flex: 1;
      min-width: 0;
      background: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    .msg-light { background-color: #d4f8e8 !important; color: #222 !important; }
    .msg-dark { background-color: #065f46 !important; color: #fff !important; }
    .badge { background: #e53e3e; color: #fff; font-size: 0.75rem; border-radius: 999px; padding: 0.15rem 0.5rem; margin-left: 0.5rem; font-weight: bold; min-width: 1.5rem; text-align: center; display: inline-block; }
    .badge-green { background: #38a169; }
    .badge-blue { background: #3182ce; }
    .badge-gray { background: #a0aec0; }
    .sidebar-search:focus { outline: 2px solid #3182ce; outline-offset: 0; }
    .sidebar-header {
      background: #065f46;
      color: #fff;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.3s, color 0.3s;
    }
    .sidebar-header .dashboard-btn {
      background: #fff;
      color: #065f46;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: background 0.2s;
      margin-left: 1rem;
    }
    .sidebar-header .dashboard-btn:hover { background: #d4f8e8; }
    .theme-btn {
      font-size: 1.2rem;
      background: transparent;
      color: #fff;
      padding: 0.3rem 0.5rem;
      border-radius: 0.375rem;
      border: none;
      transition: background 0.2s;
      cursor: pointer;
      margin-left: 1rem;
    }
    .theme-btn:hover { background: #d4f8e8; color: #065f46; }
    #contextMenu { min-width: 180px; background: white; border: 1px solid #ddd; position: absolute; z-index: 9999; }
    @media (max-width: 768px) {
      #sidebar { width: 100vw; min-width: 0; max-width: 100vw; position: absolute; left: 0; top: 0; bottom: 0; z-index: 40; }
      #mainContainer { flex-direction: column; }
      #chatArea { width: 100vw; min-width: 0; }
      #sidebar.hide { display: none !important; }
      #chatArea.hide { display: none !important; }
      #mobileHeader { display: flex !important; }
    }
    @media (min-width: 768px) {
      #sidebar { display: block !important; }
      #mainContainer { flex-direction: row; }
      #chatArea { display: flex !important; }
      #mobileHeader { display: none !important; }
    }
    body.dark, body.dark #sidebar, body.dark #chatArea {
      background: #222 !important;
      color: #fff !important;
    }
    body.dark .sidebar-header { background: #222 !important; color: #d4f8e8 !important;}
    body.dark .dashboard-btn { background: #065f46 !important; color: #fff !important;}
  </style>
</head>
<body class="bg-white text-black transition-colors duration-300">
<div id="mainContainer">
  <!-- Sidebar (Users + Groups) -->
  <aside id="sidebar">
    <div class="sidebar-header">
      <span class="font-bold text-lg">WhatsApp Clone</span>
      <span class="">Welcome, <span id="welcomeUserSidebar"></span></span>
      <button id="dashboardBtn" class="dashboard-btn">Dashboard</button>
      <button id="toggleTheme" class="theme-btn">ðŸŒ“</button>
    </div>
    <div class="p-4 border-b flex flex-col gap-2">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold">Chats</h2>
        <button id="createGroupBtn" class="text-sm text-blue-600 hover:underline">+ Group</button>
      </div>
      <input id="sidebarSearch" type="text" placeholder="Search Recents, Users, Groups..." class="sidebar-search border px-2 py-1 rounded text-sm w-full bg-white dark:bg-gray-800 dark:text-white" autocomplete="off" />
    </div>
    <div class="px-4 mt-3">
      <h2 class="text-lg font-semibold text-blue-700 mb-2">Recents</h2>
      <ul id="recentsList" class="divide-y"></ul>
    </div>
    <div class="px-4 mt-3">
      <h2 class="text-lg font-semibold text-green-700">Groups</h2>
      <ul id="groupList" class="divide-y"></ul>
    </div>
    <div class="px-4 mt-3">
      <h2 class="text-lg font-semibold">Users</h2>
      <ul id="userList" class="divide-y"></ul>
    </div>
  </aside>
  <!-- Chat Area -->
  <main id="chatArea" class="hide">
    <div id="mobileHeader" class="w-full bg-blue-600 text-white p-4 items-center justify-between" style="display:none;">
      <div class="flex items-center justify-between w-full">
        <span class="font-bold text-lg">WhatsApp Clone</span>
        <span class="">Welcome, <span id="welcomeUserMobile"></span></span>
        <button id="mobileBackBtn" class="bg-white text-blue-600 px-3 py-1 rounded font-semibold hover:bg-blue-100 transition">Back</button>
      </div>
    </div>
    <div id="chatHeader" class="flex items-center justify-between px-4 py-2 border-b bg-gray-100 dark:bg-gray-800">
      <div class="flex items-center gap-2">
        <button id="backBtn" class="text-blue-600 pr-2 md:hidden" style="display:none;">&larr;</button>
        <div>
          <h2 id="chatName" class="text-lg font-semibold"></h2>
          <p id="chatStatus" class="text-sm text-gray-500"></p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="audioCallBtn" class="bg-green-500 text-white px-3 py-1 rounded text-sm shadow">ðŸ“ž Audio</button>
        <button id="videoCallBtn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm shadow">ðŸŽ¥ Video</button>
        <button id="blockUser" class="text-sm text-red-500 ml-2">ðŸš« Block</button>
      </div>
    </div>
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-white dark:bg-gray-800 transition-colors duration-300"></div>
    <div id="typing" class="text-sm text-gray-400 px-4 py-1 hidden">Typing...</div>
    <form id="messageForm" class="flex items-center p-2 border-t gap-2 bg-gray-50 dark:bg-gray-900">
      <input id="messageInput" type="text" placeholder="Type a message" class="flex-1 border px-3 py-2 rounded" />
      <input type="file" id="fileInput" class="hidden" />
      <button type="button" id="attachBtn" class="text-blue-600">ðŸ“Ž</button>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
    </form>
  </main>
</div>
<div id="groupModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-40">
  <div class="bg-white p-4 rounded-lg w-96 space-y-4">
    <h3 class="text-lg font-bold">Create Group</h3>
    <input type="text" id="groupName" class="w-full border px-3 py-2 rounded" placeholder="Group Name" />
    <div id="groupUsers" class="max-h-40 overflow-y-auto space-y-2"></div>
    <div class="flex justify-end gap-2">
      <button id="createGroup" class="bg-blue-600 text-white px-4 py-2 rounded">Create</button>
      <button id="closeModal" class="text-sm text-gray-500 hover:underline">Cancel</button>
    </div>
  </div>
</div>
<div id="contextMenu" class="hidden"></div>
<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  // User info and header
  const currentUser = sessionStorage.getItem('username') || localStorage.getItem('username');
  if (!currentUser) { alert('Session expired'); location.href = 'index.html'; }
  document.getElementById('welcomeUserSidebar').textContent = currentUser;
  document.getElementById('welcomeUserMobile').textContent = currentUser;

  // Elements
  const userList = document.getElementById("userList");
  const groupList = document.getElementById("groupList");
  const recentsList = document.getElementById("recentsList");
  const messagesEl = document.getElementById("messages");
  const chatName = document.getElementById("chatName");
  const chatStatus = document.getElementById("chatStatus");
  const messageForm = document.getElementById("messageForm");
  const messageInput = document.getElementById("messageInput");
  const attachBtn = document.getElementById("attachBtn");
  const fileInput = document.getElementById("fileInput");
  const typingEl = document.getElementById("typing");
  const backBtn = document.getElementById("backBtn");
  const chatListEl = document.getElementById("sidebar");
  const chatWindowEl = document.getElementById("chatArea");
  const createGroupBtn = document.getElementById("createGroupBtn");
  const groupModal = document.getElementById("groupModal");
  const closeModal = document.getElementById("closeModal");
  const groupNameInput = document.getElementById("groupName");
  const groupUsers = document.getElementById("groupUsers");
  const createGroup = document.getElementById("createGroup");
  const blockUserBtn = document.getElementById("blockUser");
  const toggleThemeBtn = document.getElementById("toggleTheme");
  const dashboardBtn = document.getElementById("dashboardBtn");
  const sidebarSearch = document.getElementById("sidebarSearch");
  const audioCallBtn = document.getElementById("audioCallBtn");
  const videoCallBtn = document.getElementById("videoCallBtn");
  const mobileBackBtn = document.getElementById("mobileBackBtn");

  let selectedChat = null, typingTimer, quoteText = "";
  let allUsers = {}, allGroups = {}, recentsData = [];
  let messagesListener = null, renderedMsgIds = new Set();

  // --- Theme ---
  function setTheme(theme) {
    if (theme === "dark") {
      document.documentElement.classList.add("dark");
      document.body.classList.add("dark");
      toggleThemeBtn.innerText = "ðŸŒž";
    } else {
      document.documentElement.classList.remove("dark");
      document.body.classList.remove("dark");
      toggleThemeBtn.innerText = "ðŸŒ“";
    }
    localStorage.setItem("theme", theme);
    // update all
    document.querySelectorAll("#sidebar, #chatArea, .sidebar-header").forEach(e => {
      e.classList.toggle("dark", theme === "dark");
    });
    Array.from(messagesEl.children).forEach(el => {
      el.classList.remove("msg-light", "msg-dark");
      el.classList.add(theme === "dark" ? "msg-dark" : "msg-light");
    });
  }
  toggleThemeBtn.onclick = () => setTheme(document.documentElement.classList.contains("dark") ? "light" : "dark");
  setTheme(localStorage.getItem("theme") || "light");
  dashboardBtn.onclick = () => window.location.href = "app.html";

  // --- Sidebar lists and recents ---
  function refreshUserList() {
    db.ref("users").once("value", snapshot => {
      userList.innerHTML = "";
      allUsers = snapshot.val() || {};
      Object.keys(allUsers).forEach(username => {
        if (username === currentUser) return;
        const li = document.createElement("li");
        li.className = "p-3 hover:bg-gray-100 cursor-pointer flex justify-between items-center";
        li.innerHTML = `<span>${allUsers[username].name || username}</span><span class="badge badge-gray" id="badge-user-${username}">0</span>`;
        li.onclick = () => openChat(username, false);
        userList.appendChild(li);
      });
      filterSidebarLists();
    });
  }
  db.ref("users").on("value", refreshUserList);

  function refreshGroupList() {
    groupList.innerHTML = "";
    db.ref("groups").once("value", snapshot => {
      allGroups = snapshot.val() || {};
      Object.values(allGroups).forEach(group => {
        if (!group.members || !group.members[currentUser]) return;
        const li = document.createElement("li");
        li.className = "p-3 hover:bg-green-100 cursor-pointer text-green-700 font-semibold flex justify-between items-center";
        li.innerHTML = `<span># ${group.name}</span><span class="badge badge-green" id="badge-group-${group.id}">0</span>`;
        li.onclick = () => openChat(group.id, true, group.name);
        groupList.appendChild(li);
      });
      filterSidebarLists();
    });
  }
  db.ref("groups").on("value", refreshGroupList);

  function loadRecents() {
    recentsData = [];
    db.ref("messages").once("value").then(snapshot => {
      snapshot.forEach(child => {
        const chatId = child.key;
        const users = chatId.split('_');
        if (users.includes(currentUser)) {
          let lastMsg = null, unreadCount = 0;
          child.forEach(msgSnap => {
            const msg = msgSnap.val();
            if (!lastMsg || msg.timestamp > lastMsg.timestamp) lastMsg = { ...msg, _id: msgSnap.key };
            if (msg.sender !== currentUser && msg.status !== "read") unreadCount++;
          });
          const otherUser = users.find(u => u !== currentUser);
          if (otherUser) {
            recentsData.push({
              type: "user",
              id: otherUser,
              name: allUsers[otherUser]?.name || otherUser,
              email: allUsers[otherUser]?.email || "",
              phone: allUsers[otherUser]?.phone || "",
              timestamp: lastMsg?.timestamp || 0,
              unread: unreadCount
            });
          }
        }
      });
      db.ref("groupMessages").once("value").then(groupSnap => {
        groupSnap.forEach(child => {
          const groupId = child.key;
          if (allGroups[groupId]?.members?.[currentUser]) {
            let lastMsg = null, unreadCount = 0;
            child.forEach(msgSnap => {
              const msg = msgSnap.val();
              if (!lastMsg || msg.timestamp > lastMsg.timestamp) lastMsg = { ...msg, _id: msgSnap.key };
              if (msg.sender !== currentUser && (!msg.status || msg.status !== "read")) unreadCount++;
            });
            recentsData.push({
              type: "group",
              id: groupId,
              name: allGroups[groupId]?.name || groupId,
              email: "",
              phone: "",
              timestamp: lastMsg?.timestamp || 0,
              unread: unreadCount
            });
          }
        });
        recentsData.sort((a, b) => b.timestamp - a.timestamp);
        renderRecents();
        filterSidebarLists();
      });
    });
  }
  function renderRecents() {
    recentsList.innerHTML = "";
    recentsData.forEach(item => {
      const li = document.createElement("li");
      li.className = "p-3 hover:bg-gray-100 cursor-pointer flex justify-between items-center";
      const badgeClass = item.type === "group" ? "badge-green" : "badge-blue";
      li.innerHTML = `<span>${item.type === "group" ? "# " : ""}${item.name}</span>
        <span class="badge ${badgeClass}">${item.unread}</span>`;
      li.onclick = () => openChat(item.id, item.type === "group", item.name);
      recentsList.appendChild(li);
    });
  }
  function reloadRecents() { recentsData = []; loadRecents(); }
  db.ref("users").on("value", reloadRecents);
  db.ref("groups").on("value", reloadRecents);
  db.ref("messages").on("value", reloadRecents);
  db.ref("groupMessages").on("value", reloadRecents);

  function filterSidebarLists() {
    const query = (sidebarSearch.value || "").toLowerCase();
    function filterList(list, items, getFields) {
      Array.from(list.children).forEach((li, idx) => {
        if (!items[idx]) return li.style.display = "none";
        const { name, email, phone } = getFields(items[idx]);
        li.style.display = (
          name.toLowerCase().includes(query) ||
          email.toLowerCase().includes(query) ||
          phone.toLowerCase().includes(query)
        ) ? "" : "none";
      });
    }
    filterList(recentsList, recentsData, i => i);
    filterList(userList, Object.keys(allUsers).filter(u => u !== currentUser), u => ({
      name: allUsers[u]?.name || u,
      email: allUsers[u]?.email || "",
      phone: allUsers[u]?.phone || ""
    }));
    filterList(groupList, Object.values(allGroups).filter(g => g.members && g.members[currentUser]), g => ({
      name: g.name || g.id, email: "", phone: ""
    }));
  }
  sidebarSearch.oninput = filterSidebarLists;

  // --- Back Button for mobile ---
  function showSidebar() {
    chatListEl.classList.remove("hide");
    chatWindowEl.classList.add("hide");
    document.getElementById("mobileHeader").style.display = "none";
  }
  function showChatArea() {
    chatListEl.classList.add("hide");
    chatWindowEl.classList.remove("hide");
    if (window.innerWidth < 768) document.getElementById("mobileHeader").style.display = "flex";
  }
  backBtn.onclick = mobileBackBtn.onclick = showSidebar;

  // --- Block/Unblock logic and enforcement ---
  async function isBlocked(otherUser) {
    const userBlockedSnap = await db.ref(`blocked/${currentUser}/${otherUser}`).once("value");
    const otherBlockedSnap = await db.ref(`blocked/${otherUser}/${currentUser}`).once("value");
    return userBlockedSnap.exists() || otherBlockedSnap.exists();
  }
  async function updateBlockButton() {
    if (!selectedChat || selectedChat.isGroup) {
      blockUserBtn.textContent = "ðŸš« Block";
      blockUserBtn.disabled = true;
      return;
    }
    const otherUser = selectedChat.id;
    const userBlockedSnap = await db.ref(`blocked/${currentUser}/${otherUser}`).once("value");
    const otherBlockedSnap = await db.ref(`blocked/${otherUser}/${currentUser}`).once("value");
    if (userBlockedSnap.exists()) {
      blockUserBtn.textContent = "âœ… Unblock";
      blockUserBtn.disabled = false;
    } else if (otherBlockedSnap.exists()) {
      blockUserBtn.textContent = "ðŸš« Blocked";
      blockUserBtn.disabled = false;
    } else {
      blockUserBtn.textContent = "ðŸš« Block";
      blockUserBtn.disabled = false;
    }
  }
  async function enforceBlock() {
    if (!selectedChat || selectedChat.isGroup) return false;
    const otherUser = selectedChat.id;
    const userBlockedSnap = await db.ref(`blocked/${currentUser}/${otherUser}`).once("value");
    const otherBlockedSnap = await db.ref(`blocked/${otherUser}/${currentUser}`).once("value");
    return userBlockedSnap.exists() || otherBlockedSnap.exists();
  }
  blockUserBtn.onclick = async () => {
    if (!selectedChat || selectedChat.isGroup) return;
    const otherUser = selectedChat.id;
    const userBlockedSnap = await db.ref(`blocked/${currentUser}/${otherUser}`).once("value");
    const otherBlockedSnap = await db.ref(`blocked/${otherUser}/${currentUser}`).once("value");
    if (userBlockedSnap.exists()) {
      if (confirm(`Unblock ${otherUser}?`)) {
        await db.ref(`blocked/${currentUser}/${otherUser}`).remove();
        alert(`${otherUser} has been unblocked.`);
        updateBlockButton();
      }
    } else if (otherBlockedSnap.exists()) {
      alert(`You are blocked by ${otherUser}. You cannot message or call them.`);
    } else {
      if (confirm(`Block ${otherUser}?`)) {
        await db.ref(`blocked/${currentUser}/${otherUser}`).set(true);
        alert(`${otherUser} has been blocked.`);
        updateBlockButton();
      }
    }
  };

  // --- Open Chat ---
  async function openChat(id, isGroup = false, groupName = "") {
    selectedChat = { id, isGroup, groupName };
    messagesEl.innerHTML = "";
    renderedMsgIds.clear();
    chatName.textContent = isGroup ? `# ${groupName || id}` : allUsers[id]?.name || id;
    chatStatus.textContent = isGroup ? "Group" : "Loading...";
    if (messagesListener) messagesListener.off();

    if (!isGroup) {
      db.ref(`users/${id}/lastSeen`).on("value", snap => {
        const val = snap.val();
        if (!val) return;
        chatStatus.textContent = `last seen ${new Date(val).toLocaleTimeString()}`;
      });
    } else {
      chatStatus.textContent = "Group";
    }
    showChatArea();
    await updateBlockButton();

    const path = getChatPath();
    messagesListener = db.ref(path);
    messagesListener.off();
    messagesListener.on("child_added", snap => {
      if (renderedMsgIds.has(snap.key)) return; // Prevent duplicate rendering
      renderedMsgIds.add(snap.key);
      renderMessage(snap.val(), snap.key);
    });
    messagesListener.on("child_changed", snap => {
      const id = snap.key;
      const updatedMsg = snap.val();
      const bubble = document.querySelector(`[data-id="${id}"]`);
      if (bubble) bubble.remove();
      renderedMsgIds.delete(id);
      renderMessage(updatedMsg, id);
      renderedMsgIds.add(id);
    });
    messagesListener.on("child_removed", snap => {
      const id = snap.key;
      const bubble = document.querySelector(`[data-id="${id}"]`);
      if (bubble) bubble.remove();
      renderedMsgIds.delete(id);
    });
  }
  function getChatPath() {
    if (!selectedChat) return "";
    if (selectedChat.isGroup) return `groupMessages/${selectedChat.id}`;
    const ids = [currentUser, selectedChat.id].sort();
    return `messages/${ids[0]}_${ids[1]}`;
  }

  // --- Context Menu ---
  const contextMenu = document.getElementById("contextMenu");
  let contextMsgId = null, contextMsg = null, contextMenuOpen = false;
  function showContextMenu(actions, x = window.innerWidth / 2, y = window.innerHeight / 2, center = false) {
    let menuHtml = "";
    actions.forEach(({ label, action }) => {
      menuHtml += `<div class="p-2 hover:bg-gray-200 cursor-pointer" data-action="${action}">${label}</div>`;
    });
    contextMenu.innerHTML = menuHtml;
    contextMenu.classList.remove("hidden");
    contextMenuOpen = true;
    if (center) {
      contextMenu.style.top = "50%";
      contextMenu.style.left = "50%";
      contextMenu.style.transform = "translate(-50%, -50%)";
    } else {
      contextMenu.style.top = `${y}px`;
      contextMenu.style.left = `${x}px`;
      contextMenu.style.transform = "";
    }
  }
  function hideContextMenu() {
    contextMenu.classList.add("hidden");
    contextMenuOpen = false;
  }
  contextMenu.onclick = e => {
    const action = e.target.dataset.action;
    if (!action || !contextMsgId || !contextMsg) return;
    if (action === "reply") quoteMessage(contextMsg.text);
    if (action === "edit") editMessage(contextMsgId, contextMsg.text);
    if (action === "deleteMe") deleteForMe(contextMsgId);
    if (action === "deleteEveryone") deleteForEveryone(contextMsgId);
    if (action === "react") addReaction(contextMsgId);
    hideContextMenu();
  };
  document.body.addEventListener("click", () => { if (contextMenuOpen) hideContextMenu(); });
  window.addEventListener("scroll", hideContextMenu);
  window.addEventListener("resize", hideContextMenu);
  function quoteMessage(text) { messageInput.value = `> ${text}\n`; messageInput.focus(); }
  function editMessage(id, oldText) {
    const newText = prompt("Edit your message:", oldText);
    if (newText && newText.trim() && newText !== oldText) {
      db.ref(`${getChatPath()}/${id}`).update({ text: newText + " (edited)" });
    }
  }
  function addReaction(msgId) {
    const emoji = prompt("React with an emoji:");
    if (!emoji) return;
    db.ref(`${getChatPath()}/${msgId}/reactions/${currentUser}`).set(emoji);
  }
  function deleteForMe(id) {
    const bubble = document.querySelector(`[data-id="${id}"]`);
    if (bubble) bubble.remove();
  }
  function deleteForEveryone(id) {
    db.ref(`${getChatPath()}/${id}`).update({
      text: "ðŸš« This message was deleted.",
      fileUrl: null,
      fileName: null,
      deleted: true
    });
  }

  function renderMessage(msg, id) {
    const isSender = msg.sender === currentUser;
    const timeElapsed = Date.now() - msg.timestamp;
    const lightBg = document.documentElement.classList.contains("dark") ? "msg-dark" : "msg-light";
    const div = document.createElement("div");
    div.dataset.id = id;
    div.className = `relative max-w-xs px-4 py-2 rounded shadow text-sm break-words ${lightBg} ${isSender ? "ml-auto" : ""}`;
    div.innerHTML = msg.text || (msg.fileUrl ? `<a href="${msg.fileUrl}" target="_blank" class="underline text-blue-700">${msg.fileName}</a>` : "");
    function getMenuActions() {
      const actions = [
        { label: "Reply", action: "reply" },
        { label: "Edit", action: "edit" },
        { label: "Delete for Me", action: "deleteMe" }
      ];
      if (isSender && timeElapsed <= 60000) {
        actions.push({ label: "Delete for Everyone", action: "deleteEveryone" });
      }
      actions.push({ label: "React", action: "react" });
      return actions;
    }
    div.oncontextmenu = e => {
      e.preventDefault();
      contextMsgId = id;
      contextMsg = msg;
      showContextMenu(getMenuActions(), e.clientX, e.clientY, false);
    };
    let longPressTimer;
    div.addEventListener("touchstart", e => {
      longPressTimer = setTimeout(() => {
        contextMsgId = id;
        contextMsg = msg;
        showContextMenu(getMenuActions(), undefined, undefined, true);
      }, 400);
    });
    div.addEventListener("touchend", () => clearTimeout(longPressTimer));
    div.addEventListener("touchmove", () => clearTimeout(longPressTimer));
    if (msg.sender !== currentUser && selectedChat && !selectedChat.isGroup) {
      db.ref(`${getChatPath()}/${id}/status`).set("read");
    }
    if (isSender) {
      const ticks = document.createElement("span");
      ticks.className = "absolute bottom-1 right-2 text-xs";
      if (msg.status === "read") {
        ticks.textContent = "âœ“âœ“";
        ticks.classList.add("text-green-700");
      } else if (msg.status === "delivered") {
        ticks.textContent = "âœ“âœ“";
      } else {
        ticks.textContent = "âœ“";
      }
      div.appendChild(ticks);
    }
    if (msg.reactions) {
      const reactionBar = document.createElement("div");
      reactionBar.className = "text-sm mt-1";
      for (const [user, emoji] of Object.entries(msg.reactions)) {
        const span = document.createElement("span");
        span.textContent = emoji;
        span.className = "mr-1";
        reactionBar.appendChild(span);
      }
      div.appendChild(reactionBar);
    }
    let startX = null;
    div.addEventListener("touchstart", e => { startX = e.touches[0].clientX; });
    div.addEventListener("touchend", e => {
      if (!startX) return;
      const endX = e.changedTouches[0].clientX;
      if (endX - startX > 80 && msg.sender !== currentUser) { quoteMessage(msg.text); }
      startX = null;
    });
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    if (msg.sender !== currentUser && document.hidden && Notification.permission === "granted") {
      new Notification(`New message from ${msg.sender}`, {
        body: msg.text,
        icon: "/assets/whatsapp-icon.png"
      });
    }
  }

  messageInput.oninput = () => {
    sendTyping(true);
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => sendTyping(false), 2000);
  };
  function sendTyping(isTyping) {
    if (!selectedChat || selectedChat.isGroup) return;
    db.ref(`typing/${selectedChat.id}`).set(isTyping ? currentUser : "");
  }
  db.ref(`typing/${currentUser}`).on("value", snap => {
    const typer = snap.val();
    typingEl.classList.toggle("hidden", !typer);
    if (typer) typingEl.textContent = `${typer} is typing...`;
  });

  messageForm.onsubmit = async e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text || !selectedChat) return;
    if (selectedChat.isGroup) return;
    if (await enforceBlock()) {
      alert("You or the other user have blocked each other. Messaging is not allowed.");
      return;
    }
    const blockedRef = db.ref(`blocked/${selectedChat.id}/${currentUser}`);
    const blockedSnap = await blockedRef.once("value");
    if (blockedSnap.exists()) { alert("You are blocked by this user."); return; }

    const msg = {
      sender: currentUser,
      text: quoteText ? `${quoteText}\n\n${text}` : text,
      timestamp: Date.now(),
      status: "sent"
    };
    const ref = db.ref(getChatPath()).push();
    await ref.set(msg);
    quoteText = "";
    messageInput.value = "";
    sendTyping(false);
    if (!selectedChat.isGroup) {
      const statusRef = db.ref(`users/${selectedChat.id}/online`);
      statusRef.once("value", snap => { if (snap.val()) ref.update({ status: "delivered" }); });
    }
  };
  audioCallBtn.onclick = async () => {
    if (!selectedChat || selectedChat.isGroup) { alert("Calls are only supported in private chats."); return; }
    if (await enforceBlock()) { alert("You or the other user have blocked each other. Calls are not allowed."); return; }
    //startCall(false);
  };
  videoCallBtn.onclick = async () => {
    if (!selectedChat || selectedChat.isGroup) { alert("Calls are only supported in private chats."); return; }
    if (await enforceBlock()) { alert("You or the other user have blocked each other. Calls are not allowed."); return; }
    //startCall(true);
  };

  attachBtn.onclick = () => fileInput.click();
  fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (!file || !selectedChat) return;
    if (file.size > 10 * 1024 * 1024) { alert("File is too large (max 10MB)."); return; }
    const ref = storage.ref().child(`attachments/${Date.now()}_${file.name}`);
    await ref.put(file);
    const url = await ref.getDownloadURL();
    const msg = { sender: currentUser, fileUrl: url, fileName: file.name, timestamp: Date.now() };
    await db.ref(getChatPath()).push(msg);
  };

  createGroupBtn.onclick = () => {
    groupModal.classList.remove("hidden");
    groupNameInput.value = "";
    groupUsers.innerHTML = "";
    db.ref("users").once("value", snap => {
      const usersObj = snap.val();
      if (!usersObj) return;
      Object.keys(usersObj).forEach(username => {
        if (username === currentUser) return;
        const div = document.createElement("div");
        div.className = "flex items-center gap-2 p-1";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = username;
        div.appendChild(checkbox);
        div.appendChild(document.createTextNode(usersObj[username].name || username));
        groupUsers.appendChild(div);
      });
    });
  };
  closeModal.onclick = () => groupModal.classList.add("hidden");
  createGroup.onclick = () => {
    const name = groupNameInput.value.trim();
    if (!name) return alert("Group name required!");
    const memberCheckboxes = groupUsers.querySelectorAll("input[type=checkbox]:checked");
    if (memberCheckboxes.length < 1) return alert("Select at least one member.");
    const members = { [currentUser]: true };
    memberCheckboxes.forEach(cb => members[cb.value] = true);
    const groupId = "group_" + Date.now();
    db.ref(`groups/${groupId}`).set({ id: groupId, name, members });
    groupModal.classList.add("hidden");
    openChat(groupId, true, name);
  };

  window.addEventListener("beforeunload", () => { db.ref(`users/${currentUser}/lastSeen`).set(Date.now()); });
  db.ref(`users/${currentUser}/online`).set(true);
  db.ref(`users/${currentUser}/online`).onDisconnect().set(false);
  db.ref(`users/${currentUser}/lastSeen`).onDisconnect().set(Date.now());

</script>
</body>
</html>
