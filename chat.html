<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bravo Chat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; background: #fff; }
    header { display: flex; justify-content: space-between; align-items: center; background: #075E54; color: white; padding: 10px; }
    header button { background: #25D366; border: none; padding: 6px 12px; color: white; border-radius: 5px; cursor: pointer; }
    #userList { width: 30%; overflow-y: auto; padding: 10px; border-right: 1px solid #ccc; }
    #userList input, #msgInput { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 10px; }
    #chatWindow { flex: 1; display: none; flex-direction: column; height: 100%; }
    #chatWindow.active { display: flex; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; background: #f0f0f0; display: flex; flex-direction: column; }
    .msg { padding: 10px; margin: 6px; border-radius: 10px; max-width: 70%; word-wrap: break-word; }
    .you { background: #dcf8c6; align-self: flex-end; }
    .them { background: white; align-self: flex-start; }
    .msg-time { font-size: 10px; color: #999; margin-top: 4px; text-align: right; }
    .unread-badge { background: red; color: white; padding: 2px 5px; font-size: 10px; border-radius: 12px; float: right; }
    #sendBar { display: flex; padding: 10px; border-top: 1px solid #ccc; }
    #sendBar input { flex: 1; }
    #sendBar button { margin-left: 5px; padding: 10px; background: #25D366; color: white; border: none; border-radius: 5px; }
    .group { background: #dcedc8; font-weight: bold; }
    .status { font-size: 12px; color: gray; }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Welcome</div>
    <button onclick="location.href='app.html'">Dashboard</button>
  </header>
  <div style="display: flex; height: calc(100% - 50px);">
    <div id="userList">
      <input id="searchBox" placeholder="Search users/groups..." oninput="refreshList()" />
      <button onclick="createGroup()">Create Group</button>
      <div id="recentChats"><h4>Recent</h4></div>
      <div id="userSection"><h4>All Users</h4></div>
      <div id="groupSection"><h4>All Groups</h4></div>
    </div>
    <div id="chatWindow">
      <div style="padding: 10px; background: #128C7E; color: white;">
        <span id="chatWith">---</span>
        <div class="status" id="chatStatus"></div>
      </div>
      <div id="typing" class="status" style="padding-left: 12px; display:none;">Typing...</div>
      <div id="messages"></div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type a message..." oninput="setTyping()" />
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = sessionStorage.getItem("username");
    if (!user) location.href = "index.html";
    document.getElementById("currentUser").textContent = "Welcome, " + user;

    let currentChat = "", chatRef = null, typingRef = null;
    let allUsers = {}, allGroups = {}, recentChats = {}, unread = {};

    db.ref("users").on("value", snap => {
      allUsers = snap.val() || {};
      refreshList();
    });

    db.ref("groups").on("value", snap => {
      allGroups = snap.val() || {};
      refreshList();
    });

    db.ref("recentChats/" + user).on("value", snap => {
      recentChats = snap.val() || {};
      refreshList();
    });

    function chatId(a, b) {
      return [a, b].sort().join("_");
    }

    function refreshList() {
      const search = document.getElementById("searchBox").value.toLowerCase();
      const rc = document.getElementById("recentChats");
      const us = document.getElementById("userSection");
      const gs = document.getElementById("groupSection");
      rc.innerHTML = "<h4>Recent</h4>";
      us.innerHTML = "<h4>All Users</h4>";
      gs.innerHTML = "<h4>All Groups</h4>";

      Object.keys(recentChats).forEach(id => {
        const btn = document.createElement("button");
        const isGroup = id.startsWith("group_");
        const label = isGroup ? allGroups[id.slice(6)]?.name : id;
        btn.innerHTML = `${label} ${unread[id] ? "<span class='unread-badge'>" + unread[id] + "</span>" : ""}`;
        btn.onclick = () => openChat(id, isGroup);
        rc.appendChild(btn);
      });

      Object.keys(allUsers).filter(u => u !== user && u.toLowerCase().includes(search)).forEach(u => {
        const btn = document.createElement("button");
        btn.innerHTML = `${u} <div class="status">${formatLastSeen(allUsers[u]?.lastSeen)}</div>`;
        btn.onclick = () => openChat(u, false);
        us.appendChild(btn);
      });

      Object.keys(allGroups).filter(g => allGroups[g].name.toLowerCase().includes(search)).forEach(g => {
        const group = allGroups[g];
        const btn = document.createElement("button");
        btn.className = "group";
        btn.textContent = `${group.name}`;
        btn.onclick = () => {
          db.ref("groups/" + g + "/members/" + user).set(true);
          openChat("group_" + g, true);
        };
        gs.appendChild(btn);
      });
    }

    function formatLastSeen(ts) {
      if (!ts) return "Offline";
      const d = new Date(ts);
      return d.toLocaleDateString() + " " + d.toLocaleTimeString();
    }

    function openChat(id, isGroup) {
      currentChat = id;
      document.getElementById("chatWindow").classList.add("active");
      document.getElementById("messages").innerHTML = "";
      document.getElementById("chatWith").textContent = isGroup ? allGroups[id.slice(6)].name : id;
      document.getElementById("chatStatus").textContent = isGroup ? "Group" : formatLastSeen(allUsers[id]?.lastSeen);

      if (chatRef) chatRef.off();
      if (typingRef) typingRef.off();

      chatRef = isGroup ? db.ref("groupChats/" + id.slice(6)) : db.ref("chats/" + chatId(user, id));
      chatRef.on("child_added", snap => renderMsg(snap.key, snap.val(), isGroup));
      chatRef.on("child_changed", snap => renderMsg(snap.key, snap.val(), isGroup));

      if (!isGroup) {
        typingRef = db.ref("typing/" + chatId(user, id) + "/" + id);
        typingRef.on("value", s => {
          document.getElementById("typing").style.display = s.val() ? "block" : "none";
        });
      }

      db.ref("recentChats/" + user + "/" + id).set(Date.now());
      db.ref("seen/" + (isGroup ? id.slice(6) : chatId(user, id)) + "/" + user).set(firebase.database.ServerValue.TIMESTAMP);
    }

    function renderMsg(id, msg, isGroup) {
      if (!msg || msg.deletedFor?.[user]) return;
      const div = document.createElement("div");
      div.className = "msg " + (msg.from === user ? "you" : "them");
      div.innerHTML = msg.text + `<div class="msg-time">${new Date(msg.ts).toLocaleTimeString()}</div>`;
      document.getElementById("messages").appendChild(div);
      document.getElementById("messages").scrollTop = 999999;
    }

    function sendMsg() {
      const input = document.getElementById("msgInput");
      const text = input.value.trim();
      if (!text || !currentChat) return;
      const msg = { from: user, text, ts: Date.now() };

      if (currentChat.startsWith("group_")) {
        db.ref("groupChats/" + currentChat.slice(6)).push(msg);
      } else {
        db.ref("chats/" + chatId(user, currentChat)).push(msg);
      }

      input.value = "";
    }

    function setTyping() {
      if (!currentChat || currentChat.startsWith("group_")) return;
      const ref = db.ref("typing/" + chatId(user, currentChat) + "/" + user);
      ref.set(true);
      setTimeout(() => ref.set(false), 1500);
    }

    function createGroup() {
      const name = prompt("Group name:");
      if (!name) return;
      const type = prompt("Type (public/private):");
      let password = "";
      if (type === "private") {
        password = prompt("Password:");
        if (!password) return;
      }
      const id = db.ref("groups").push().key;
      db.ref("groups/" + id).set({ name, type, password, createdBy: user, members: { [user]: true } });
    }
  </script>
</body>
</html>
