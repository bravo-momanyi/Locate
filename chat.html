<!-- chat.html — Part 1 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bravo Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }
    header button {
      background: #25D366;
      border: none;
      padding: 6px 12px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    #userList {
      width: 30%;
      overflow-y: auto;
      padding: 10px;
      border-right: 1px solid #ccc;
    }
    #userList input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #userList button {
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0f7fa;
    }
    #userList button.group {
      background: #dcedc8;
      font-weight: bold;
    }
    .unread-badge {
      background: red;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      float: right;
      margin-top: -15px;
    }
    #chatWindow {
      display: none;
      flex-direction: column;
      flex: 1;
      height: 100%;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease;
      opacity: 0;
      transform: translateX(100%);
    }
    #chatWindow.active {
      opacity: 1;
      transform: translateX(0);
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
    }
    .msg {
      padding: 8px;
      margin: 6px;
      border-radius: 7px;
      max-width: 70%;
      position: relative;
      word-wrap: break-word;
      animation: slideIn 0.3s ease forwards;
    }
    .you {
      background: #dcf8c6;
      align-self: flex-end;
      text-align: right;
    }
    .them {
      background: white;
      align-self: flex-start;
    }
    .msg .meta {
      font-size: 10px;
      color: gray;
      margin-top: 4px;
    }
    .tick {
      margin-left: 5px;
      font-size: 10px;
    }
    @keyframes slideIn {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #inputArea {
      display: flex;
      align-items: center;
      padding: 10px;
      border-top: 1px solid #ccc;
      background: #fff;
    }
    #inputArea input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
      margin-right: 10px;
    }
    #inputArea button {
      background: #075E54;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
    }
    #typingIndicator {
      font-size: 12px;
      color: #888;
      padding-left: 10px;
      display: none;
    }
    #replyTag {
      display: none;
      background: #f0f0f0;
      border-left: 4px solid #34B7F1;
      padding: 4px 8px;
      font-size: 12px;
      max-width: 90%;
      margin: 4px;
    }
    .floating-date {
      position: sticky;
      top: 0;
      background: #e0e0e0;
      text-align: center;
      padding: 4px;
      font-size: 12px;
      color: #555;
    }
    #titleOptions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      top: 45px;
      right: 10px;
      display: none;
      z-index: 10;
    }
    #titleOptions button {
      display: block;
      width: 100%;
      border: none;
      padding: 8px;
      background: white;
      text-align: left;
      cursor: pointer;
    }
    #titleOptions button:hover {
      background: #eee;
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Logged in as: <span id="usernameDisplay"></span></div>
    <button onclick="logout()">Logout</button>
  </header>
  <div style="display:flex;height:calc(100% - 50px);">
    <div id="userList">
      <input type="text" placeholder="Search users/groups..." oninput="filterUsers(this.value)">
      <div id="userButtons"></div>
    </div>
    <div id="chatWindow">
      <div style="background:#075E54;color:white;padding:10px;position:relative;">
        <span id="chatTitle" onclick="toggleTitleOptions()" style="cursor:pointer;"></span>
        <div id="titleOptions"></div>
        <div id="typingIndicator"></div>
      </div>
      <div id="messages"></div>
      <div id="replyTag"></div>
      <div id="inputArea">
        <input id="msgInput" type="text" placeholder="Type a message" oninput="handleTyping()" onkeydown="handleKey(event)">
        <button onclick="sendMsg()">➤</button>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = localStorage.getItem("username") || prompt("Enter username");
    if (!currentUser) location.reload();
    localStorage.setItem("username", currentUser);
    document.getElementById("usernameDisplay").textContent = currentUser;

    let currentChat = "";
    let isGroup = false;
    let replyTo = null;
    let blockedUsers = {};
    let blockList = {};

    const chatWindow = document.getElementById("chatWindow");
    const messagesDiv = document.getElementById("messages");
    const inputField = document.getElementById("msgInput");
    const replyTag = document.getElementById("replyTag");

    function logout() {
      localStorage.removeItem("username");
      location.reload();
    }
  </script>
  <script>
    function filterUsers(query) {
      query = query.toLowerCase();
      const buttons = document.querySelectorAll("#userButtons button");
      buttons.forEach(btn => {
        btn.style.display = btn.textContent.toLowerCase().includes(query) ? "" : "none";
      });
    }

    function toggleTitleOptions() {
      const menu = document.getElementById("titleOptions");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    function loadUsersAndGroups() {
      const userButtons = document.getElementById("userButtons");
      userButtons.innerHTML = "";

      db.ref("users").once("value", snap => {
        const data = snap.val() || {};
        Object.keys(data).forEach(username => {
          if (username === currentUser) return;
          const btn = document.createElement("button");
          btn.textContent = username;
          btn.onclick = () => openChat(username, false);
          userButtons.appendChild(btn);
        });
      });

      db.ref("groups").once("value", snap => {
        const groups = snap.val() || {};
        Object.keys(groups).forEach(groupName => {
          const group = groups[groupName];
          const btn = document.createElement("button");
          btn.className = "group";
          btn.textContent = group.name;
          btn.onclick = () => handleGroupClick(group.name, group);
          userButtons.appendChild(btn);
        });
      });
    }

    function handleGroupClick(name, groupData) {
      const memberList = groupData.members || {};
      if (memberList[currentUser]) {
        openChat(name, true);
      } else {
        if (!groupData.public) {
          const pass = prompt("This group is private. Enter password:");
          if (pass !== groupData.password) return alert("Wrong password");
        }
        if (confirm(`Join group "${name}"?`)) {
          db.ref(`groups/${name}/members/${currentUser}`).set(true);
          openChat(name, true);
        }
      }
    }

    function openChat(chatId, group) {
      currentChat = chatId;
      isGroup = group;
      chatWindow.classList.add("active");
      messagesDiv.innerHTML = "";
      replyTo = null;
      replyTag.style.display = "none";
      document.getElementById("chatTitle").textContent = chatId;
      document.getElementById("titleOptions").innerHTML = "";

      if (group) {
        loadGroupOptions(chatId);
        listenToGroupMessages(chatId);
      } else {
        loadUserOptions(chatId);
        listenToUserMessages(currentUser, chatId);
      }

      updateSeenStatus();
      listenToTyping();
      loadRecentChats();
    }

    function loadGroupOptions(name) {
      const menu = document.getElementById("titleOptions");
      menu.innerHTML = `
        <button onclick="viewGroupMembers()">View Members</button>
        <button onclick="leaveGroup()">Leave Group</button>
      `;
    }

    function loadUserOptions(name) {
      const menu = document.getElementById("titleOptions");
      menu.innerHTML = `
        <button onclick="blockUser()">Block User</button>
        <button onclick="deleteChat()">Delete Chat</button>
      `;
    }

    function blockUser() {
      if (!confirm(`Block ${currentChat}?`)) return;
      db.ref(`users/${currentUser}/blocked/${currentChat}`).set(true);
      alert(`${currentChat} is blocked.`);
    }

    function deleteChat() {
      if (!confirm(`Delete chat with ${currentChat}?`)) return;
      const path = `chats/${chatCode(currentUser, currentChat)}`;
      db.ref(path).remove();
      messagesDiv.innerHTML = "";
    }

    function viewGroupMembers() {
      db.ref(`groups/${currentChat}/members`).once("value", snap => {
        const members = snap.val() || {};
        alert("Members:\n" + Object.keys(members).join("\n"));
      });
    }

    function leaveGroup() {
      if (!confirm("Request to leave this group?")) return;
      db.ref(`groups/${currentChat}/leaveRequests/${currentUser}`).set(true);
      alert("Request sent to admin.");
    }

    function chatCode(userA, userB) {
      return [userA, userB].sort().join("_");
    }

    function updateSeenStatus() {
      const code = isGroup ? `groupChats/${currentChat}` : `seen/${chatCode(currentUser, currentChat)}/${currentUser}`;
      if (!isGroup) db.ref(code).set(Date.now());
    }

    function listenToTyping() {
      const code = chatCode(currentUser, currentChat);
      const ref = db.ref(`typing/${code}`);
      ref.on("value", snap => {
        const data = snap.val() || {};
        const other = Object.keys(data).find(u => u !== currentUser);
        if (data[other]) {
          document.getElementById("typingIndicator").style.display = "block";
          document.getElementById("typingIndicator").textContent = `${other} is typing...`;
        } else {
          document.getElementById("typingIndicator").style.display = "none";
        }
      });
    }

    function handleTyping() {
      const code = chatCode(currentUser, currentChat);
      const ref = db.ref(`typing/${code}/${currentUser}`);
      ref.set(true);
      setTimeout(() => ref.set(false), 3000);
    }

    function handleKey(e) {
      if (e.key === "Enter") sendMsg();
    }
  </script>
  <script>
    function sendMsg() {
      const text = msgInput.value.trim();
      if (!text) return;

      const now = Date.now();
      const message = {
        from: currentUser,
        text,
        ts: now,
      };

      if (replyTo) message.reply = replyTo;

      let ref;
      if (isGroup) {
        ref = db.ref(`groupChats/${currentChat}`).push();
        message.readBy = { [currentUser]: true };
        db.ref(`recentChats/${currentUser}/${currentChat}`).set({ ts: now, group: true });
      } else {
        const code = chatCode(currentUser, currentChat);
        ref = db.ref(`chats/${code}`).push();
        db.ref(`seen/${code}/${currentUser}`).set(now);
        db.ref(`recentChats/${currentUser}/${currentChat}`).set({ ts: now, group: false });
        db.ref(`recentChats/${currentChat}/${currentUser}`).set({ ts: now, group: false });
      }

      ref.set(message).then(() => {
        msgInput.value = "";
        replyTo = null;
        replyTag.style.display = "none";
      });
    }

    function listenToUserMessages(user1, user2) {
      const code = chatCode(user1, user2);
      const ref = db.ref(`chats/${code}`);
      ref.off();
      ref.on("child_added", snap => {
        const msg = snap.val();
        msg.id = snap.key;
        renderMsg(msg);
      });
    }

    function listenToGroupMessages(groupName) {
      const ref = db.ref(`groupChats/${groupName}`);
      ref.off();
      ref.on("child_added", snap => {
        const msg = snap.val();
        msg.id = snap.key;
        if (!msg.readBy || !msg.readBy[currentUser]) {
          db.ref(`groupChats/${groupName}/${msg.id}/readBy/${currentUser}`).set(true);
        }
        renderMsg(msg);
      });
    }

    function renderMsg(msg) {
      const div = document.createElement("div");
      div.className = msg.from === currentUser ? "msg you" : "msg";

      const meta = document.createElement("span");
      meta.className = "meta";
      const date = new Date(msg.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      if (isGroup) {
        meta.textContent = `${msg.from} • ${date}`;
      } else {
        const code = chatCode(currentUser, currentChat);
        db.ref(`seen/${code}`).once("value", snap => {
          const seen = snap.val() || {};
          if (seen[currentChat] && msg.ts <= seen[currentChat]) {
            meta.innerHTML += " ✓✓✓";
          } else {
            db.ref(`users/${currentChat}/lastSeen`).once("value", snap2 => {
              if (snap2.val() && msg.ts <= snap2.val()) {
                meta.innerHTML += " ✓✓";
              } else {
                meta.innerHTML += " ✓";
              }
            });
          }
        });
      }

      if (msg.reply) {
        const replyDiv = document.createElement("div");
        replyDiv.className = "reply";
        replyDiv.innerHTML = `<strong>${msg.reply.from}</strong>: ${msg.reply.text}`;
        div.appendChild(replyDiv);
      }

      const text = document.createElement("p");
      text.textContent = msg.text;

      div.appendChild(text);
      div.appendChild(meta);

      div.addEventListener("contextmenu", e => {
        e.preventDefault();
        selectMessage(msg, div);
      });

      div.addEventListener("touchstart", handleSwipeStart);
      div.addEventListener("touchend", e => handleSwipeEnd(e, msg));

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function handleSwipeStart(e) {
      this.swipeX = e.changedTouches[0].clientX;
    }

    function handleSwipeEnd(e, msg) {
      const dx = e.changedTouches[0].clientX - this.swipeX;
      if (dx > 50) {
        replyTo = { from: msg.from, text: msg.text };
        replyTag.innerHTML = `<strong>${msg.from}</strong>: ${msg.text}`;
        replyTag.style.display = "flex";
      } else if (dx < -50 && replyTo) {
        replyTo = null;
        replyTag.style.display = "none";
      }
    }
   </script>
   <script>
    let selectedMsgs = [];

    function selectMessage(msg, element) {
      if (!selectedMsgs.find(m => m.id === msg.id)) {
        selectedMsgs.push(msg);
        element.classList.add("selected");
      } else {
        selectedMsgs = selectedMsgs.filter(m => m.id !== msg.id);
        element.classList.remove("selected");
      }

      showActionBar();
    }

    function showActionBar() {
      if (selectedMsgs.length === 0) {
        actionBar.innerHTML = "";
        return;
      }

      actionBar.innerHTML = `
        <button onclick="copySelected()">Copy</button>
        ${selectedMsgs.length === 1 && selectedMsgs[0].from === currentUser && Date.now() - selectedMsgs[0].ts < 60000 ? `<button onclick="editSelected()">Edit</button>` : ""}
        <button onclick="deleteSelected()">Delete</button>
        <button onclick="cancelSelection()">Cancel</button>
      `;
    }

    function copySelected() {
      const text = selectedMsgs.map(m => m.text).join("\n");
      navigator.clipboard.writeText(text);
      cancelSelection();
    }

    function editSelected() {
      if (selectedMsgs.length !== 1) return;
      const msg = selectedMsgs[0];
      msgInput.value = msg.text;
      msgInput.focus();
      editMode = msg;
      cancelSelection();
    }

    function deleteSelected() {
      selectedMsgs.forEach(msg => {
        if (isGroup) {
          const ref = db.ref(`groupChats/${currentChat}/${msg.id}`);
          if (msg.from === currentUser) {
            if (confirm("Delete for everyone?")) ref.remove();
            else ref.update({ text: "This message was deleted" });
          } else {
            ref.update({ [`deletedFor/${currentUser}`]: true });
          }
        } else {
          const code = chatCode(currentUser, currentChat);
          const ref = db.ref(`chats/${code}/${msg.id}`);
          if (msg.from === currentUser && confirm("Delete for everyone?")) {
            ref.remove();
          } else {
            ref.update({ [`deletedFor/${currentUser}`]: true });
          }
        }
      });
      cancelSelection();
    }

    function cancelSelection() {
      selectedMsgs = [];
      document.querySelectorAll(".msg.selected").forEach(el => el.classList.remove("selected"));
      actionBar.innerHTML = "";
    }

    msgInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (editMode) {
          applyEdit(editMode.id, msgInput.value.trim());
          editMode = null;
        } else {
          sendMsg();
        }
      }
    });

    function applyEdit(msgId, newText) {
      if (!newText) return;
      const code = isGroup ? `groupChats/${currentChat}/${msgId}` : `chats/${chatCode(currentUser, currentChat)}/${msgId}`;
      db.ref(code).update({ text: newText + " (edited)" });
      msgInput.value = "";
    }
   </script>
   <script>
    chatHeader.addEventListener("click", () => {
      if (!currentChat) return;

      let html = "";

      if (isGroup) {
        html += `<button onclick="viewMembers()">View Members</button>`;
        html += `<button onclick="leaveGroup()">Leave Group</button>`;
        if (groupInfo?.admin === currentUser) {
          html += `<button onclick="showLeaveRequests()">Manage Leave Requests</button>`;
          html += `<button onclick="deleteGroup()">Delete Group</button>`;
        }
      } else {
        html += `<button onclick="blockUser()">Block User</button>`;
        html += `<button onclick="deleteChat()">Delete Chat</button>`;
      }

      chatOptions.innerHTML = html;
      chatOptions.style.display = "block";

      setTimeout(() => chatOptions.style.display = "none", 10000);
    });

    function blockUser() {
      if (!confirm(`Block ${currentChat}?`)) return;
      db.ref(`blocks/${currentUser}_${currentChat}`).set(true);
      alert(`${currentChat} is blocked.`);
    }

    function deleteChat() {
      if (!confirm("Delete entire chat?")) return;
      const code = chatCode(currentUser, currentChat);
      db.ref(`chats/${code}`).once("value", snap => {
        const msgs = snap.val();
        if (msgs) {
          Object.keys(msgs).forEach(id => {
            db.ref(`chats/${code}/${id}/deletedFor/${currentUser}`).set(true);
          });
        }
      });
      db.ref(`recentChats/${currentUser}/${currentChat}`).remove();
      alert("Chat deleted.");
    }

    function viewMembers() {
      let members = Object.keys(groupInfo.members || {});
      let html = members.map(m => {
        let isAdmin = groupInfo.admin === m;
        return `<div>${m}
          ${groupInfo.admin === currentUser && m !== currentUser ? `
            <button onclick="makeAdmin('${m}')">Make Admin</button>
            <button onclick="removeMember('${m}')">Remove</button>` : ""}
          ${isAdmin ? " (Admin)" : ""}
        </div>`;
      }).join("");
      chatOptions.innerHTML = html;
    }

    function makeAdmin(user) {
      db.ref(`groups/${currentChat}/admin`).set(user);
      alert(`${user} is now the admin.`);
    }

    function removeMember(user) {
      if (!confirm(`Remove ${user} from group?`)) return;
      db.ref(`groups/${currentChat}/members/${user}`).remove();
      db.ref(`recentChats/${user}/${currentChat}`).remove();
    }

    function leaveGroup() {
      db.ref(`groupLeaves/${currentChat}/${currentUser}`).set("pending");
      alert("Leave request sent to admin.");
    }

    function showLeaveRequests() {
      db.ref(`groupLeaves/${currentChat}`).once("value", snap => {
        const requests = snap.val() || {};
        chatOptions.innerHTML = Object.keys(requests).map(user => `
          <div>${user} wants to leave.
            <button onclick="confirmLeave('${user}')">Confirm</button>
            <button onclick="cancelLeave('${user}')">Cancel</button>
          </div>
        `).join("");
      });
    }

    function confirmLeave(user) {
      db.ref(`groups/${currentChat}/members/${user}`).remove();
      db.ref(`groupLeaves/${currentChat}/${user}`).remove();
      db.ref(`recentChats/${user}/${currentChat}`).remove();
    }

    function cancelLeave(user) {
      db.ref(`groupLeaves/${currentChat}/${user}`).remove();
    }

    function deleteGroup() {
      if (!confirm("Delete group for everyone?")) return;
      db.ref(`groups/${currentChat}`).remove();
      db.ref(`groupChats/${currentChat}`).remove();
      db.ref(`recentChats`).once("value", snap => {
        const rc = snap.val() || {};
        Object.keys(rc).forEach(user => {
          db.ref(`recentChats/${user}/${currentChat}`).remove();
        });
      });
      alert("Group deleted.");
    }
   </script>
   <script>
    // --- Floating date headers ---
    function formatDateHeader(ts) {
      const date = new Date(ts);
      const today = new Date();
      if (
        date.toDateString() === today.toDateString()
      ) return "Today";
      today.setDate(today.getDate() - 1);
      if (date.toDateString() === today.toDateString())
        return "Yesterday";
      return date.toDateString();
    }

    function insertDateHeaderIfNeeded(ts) {
      const dayKey = new Date(ts).toDateString();
      if (lastRenderedDate !== dayKey) {
        lastRenderedDate = dayKey;
        const header = document.createElement("div");
        header.className = "date-header";
        header.textContent = formatDateHeader(ts);
        messages.appendChild(header);
      }
    }

    // --- Swipe to reply ---
    let touchStartX = null;
    messages.addEventListener("touchstart", (e) => {
      const msgEl = e.target.closest(".msg");
      if (!msgEl) return;
      touchStartX = e.touches[0].clientX;
      msgEl.dataset.swipeId = msgEl.id;
    });

    messages.addEventListener("touchmove", (e) => {
      const msgEl = e.target.closest(".msg");
      if (!msgEl || touchStartX === null) return;
      const deltaX = e.touches[0].clientX - touchStartX;
      if (deltaX > 60) {
        const id = msgEl.dataset.swipeId;
        const msgText = msgEl.querySelector(".text").textContent;
        replyTag.style.display = "block";
        replyMsg = { id, text: msgText };
        replyTag.textContent = `Replying: ${msgText}`;
        touchStartX = null;
      } else if (deltaX < -30) {
        replyTag.style.display = "none";
        replyMsg = null;
        touchStartX = null;
      }
    });

    // --- Push notifications ---
    function showNotification(title, body) {
      if (Notification.permission === "granted") {
        new Notification(title, { body });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") {
            new Notification(title, { body });
          }
        });
      }
    }

    function notifyOnNewMsg(from, msg) {
      if (from !== currentUser && document.hidden) {
        showNotification(`New message from ${from}`, msg);
      }
    }

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden && currentChat) {
        updateReadStatus();
      }
    });

    function updateReadStatus() {
      const path = isGroup
        ? `groupChats/${currentChat}`
        : `chats/${chatCode(currentUser, currentChat)}`;
      db.ref(path).once("value", snap => {
        const msgs = snap.val();
        if (!msgs) return;
        Object.keys(msgs).forEach(id => {
          const msg = msgs[id];
          if (msg.from !== currentUser) {
            if (isGroup) {
              db.ref(`${path}/${id}/readBy/${currentUser}`).set(Date.now());
            } else {
              db.ref(`${path}/${id}/readBy`).set({ [currentUser]: Date.now() });
            }
          }
        });
      });
    }
  </script>
  <style>
    .date-header {
      text-align: center;
      background: #f1f1f1;
      padding: 3px 10px;
      font-size: 0.8em;
      color: #555;
      margin: 10px auto;
      border-radius: 5px;
      width: fit-content;
    }
  </style>
</body>
</html>
