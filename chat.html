<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bravo Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }
    header button {
      background: #25D366;
      border: none;
      padding: 6px 12px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    #userList {
      width: 30%;
      overflow-y: auto;
      padding: 10px;
      border-right: 1px solid #ccc;
    }
    #userList input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #userList button {
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0f7fa;
    }
    #userList button.group {
      background: #dcedc8;
      font-weight: bold;
    }
    .unread-badge {
      background: red;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      float: right;
      margin-top: -15px;
    }
    #chatWindow {
      display: none;
      flex-direction: column;
      flex: 1;
      height: 100%;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease;
      opacity: 0;
      transform: translateX(100%);
    }
    #chatWindow.active {
      opacity: 1;
      transform: translateX(0);
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
    }
    .msg {
      padding: 8px;
      margin: 6px;
      border-radius: 7px;
      max-width: 70%;
      position: relative;
      word-wrap: break-word;
      animation: slideIn 0.3s ease forwards;
    }
    .you {
      background: #dcf8c6;
      align-self: flex-end;
      text-align: right;
    }
    .them {
      background: white;
      align-self: flex-start;
    }
    .msg-time {
      font-size: 10px;
      color: #888;
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }
    .msg-status {
      margin-left: 6px;
      font-weight: bold;
      color: #999;
    }
    #sendBar {
      display: flex;
      padding: 10px;
      background: white;
      align-items: center;
      gap: 8px;
    }
    #sendBar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    #sendBar button {
      padding: 8px 14px;
      background: #25D366;
      border: none;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
    #typingIndicator {
      font-size: 16px;
      font-weight: bold;
      padding: 5px;
      color: #0a9c3c;
      display: none;
    }
    #replyTag {
      display: none;
      padding: 6px 10px;
      font-size: 13px;
      border-left: 3px solid #0a9c3c;
      background: #e1f5e0;
      color: #333;
      margin: 6px 10px -4px 10px;
    }
    #msgMenu {
      display: none;
      position: absolute;
      background: white;
      border: 2px solid #888;
      border-radius: 10px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      min-width: 240px;
      font-size: 17px;
      padding: 10px;
    }
    #msgMenu button {
      width: 100%;
      border: none;
      padding: 16px 20px;
      background: white;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #msgMenu button:last-child {
      border-bottom: none;
    }
    #msgMenu button:hover {
      background: #f2f2f2;
    }
    #backBtn {
      padding: 6px 12px;
      font-size: 24px;
    }
    @media (max-width: 600px) {
      #userList { width: 100%; }
      #chatWindow {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        background: white;
        z-index: 100;
      }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Welcome</div>
    <button onclick="goToDashboard()">Dashboard</button>
  </header>
  <div style="display: flex; height: calc(100% - 50px);">
    <div id="userList">
      <div style="position: relative;">
        <input id="searchBox" placeholder="Search users/groups..." style="padding-right: 30px;" />
        <span id="clearSearch" style="position: absolute; right: 10px; top: 8px; cursor: pointer; font-weight: bold; font-size: 16px; color: #999;">×</span>
      </div>
      <button onclick="createGroup()">Create Group</button>
      <div id="recentChats"><h4>Recent Chats</h4></div>
      <div id="userSection"><h4>All Users</h4></div>
      <div id="groupSection"><h4>All Groups</h4></div>
    </div>
    <div id="chatWindow">
      <div style="padding: 10px; background: #128C7E; color: white; display: flex; justify-content: space-between;">
        <button id="backBtn" onclick="closeChat()">BACK</button>
        <span id="chatWith" style="flex: 1; text-align: center; font-weight: bold;"></span>
        <div style="width: 40px;"></div>
      </div>
      <div id="typingIndicator">Typing...</div>
      <div id="messages"></div>
      <div id="replyTag"></div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type message..."/>
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
  apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
  authDomain: "locater-42fb4.firebaseapp.com",
  databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
  projectId: "locater-42fb4",
  storageBucket: "locater-42fb4.appspot.com",
  messagingSenderId: "250348367998",
  appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let user = sessionStorage.getItem("username");
  if (!user) location.href = "index.html";
  document.getElementById("currentUser").innerText = `Welcome ${user}`;
  let currentChat = null;
  let isGroup = false;
  let replyTo = null;
  let blockedUsers = {};
  let replyTag = document.getElementById("replyTag");

  function goToDashboard() {
    location.href = "dashboard.html";
  }

  function closeChat() {
    document.getElementById("chatWindow").classList.remove("active");
    currentChat = null;
    isGroup = false;
    replyTo = null;
    replyTag.style.display = "none";
  }

  function showReplyTag(msgId, text) {
    replyTo = msgId;
    replyTag.innerText = text.length > 60 ? text.substring(0, 60) + "..." : text;
    replyTag.style.display = "block";
  }

  replyTag.addEventListener("click", () => {
    replyTo = null;
    replyTag.style.display = "none";
  });

  function sendMsg() {
    const input = document.getElementById("msgInput");
    let text = input.value.trim();
    if (!text || !currentChat) return;

    const ts = Date.now();
    const msgObj = {
      from: user,
      text,
      ts,
      replyTo: replyTo || null
    };

    let ref;
    if (isGroup) {
      ref = db.ref(`groupChats/${currentChat}`).push();
    } else {
      const path = [user, currentChat].sort().join("_");
      ref = db.ref(`chats/${path}`).push();
    }

    ref.set(msgObj).then(() => {
      db.ref(`recentChats/${user}/${currentChat}`).set(ts);
      db.ref(`recentChats/${currentChat}/${user}`).set(ts);
    });

    input.value = "";
    replyTo = null;
    replyTag.style.display = "none";
  }

  document.getElementById("msgInput").addEventListener("keydown", e => {
    if (e.key === "Enter") sendMsg();
    else updateTyping(true);
  });

  function updateTyping(status) {
    if (!currentChat || isGroup) return;
    const key = [user, currentChat].sort().join("_");
    db.ref(`typing/${key}/${user}`).set(status);
    if (status) {
      setTimeout(() => db.ref(`typing/${key}/${user}`).set(false), 2000);
    }
  }

  function setupTypingListener(chatUser) {
    if (isGroup) return;
    const key = [user, chatUser].sort().join("_");
    db.ref(`typing/${key}/${chatUser}`).on("value", snap => {
      document.getElementById("typingIndicator").style.display = snap.val() ? "block" : "none";
    });
  }
</script>
<script>
  function renderMsg(id, msg) {
    const msgDiv = document.createElement("div");
    msgDiv.className = msg.from === user ? "msg you" : "msg them";
    msgDiv.dataset.id = id;

    if (msg.replyTo) {
      const replyDiv = document.createElement("div");
      replyDiv.style.fontSize = "12px";
      replyDiv.style.paddingBottom = "4px";
      replyDiv.style.borderLeft = "3px solid #aaa";
      replyDiv.style.marginBottom = "4px";
      replyDiv.style.color = "#444";
      replyDiv.innerText = "Replying to: " + (msg.text || "(deleted)");
      msgDiv.appendChild(replyDiv);
    }

    msgDiv.innerHTML += `
      <div>${msg.text || "(deleted)"}</div>
      <div class="msg-time">${formatTime(msg.ts)} <span class="msg-status">✓</span></div>
    `;

    msgDiv.oncontextmenu = (e) => {
      e.preventDefault();
      enterSelectionMode(id);
    };

    msgDiv.onclick = (e) => {
      if (selectionMode) toggleSelection(id, msgDiv);
    };

    document.getElementById("messages").appendChild(msgDiv);
    document.getElementById("messages").scrollTop = 99999;
  }

  function formatTime(ts) {
    const d = new Date(ts);
    return d.getHours().toString().padStart(2, "0") + ":" +
           d.getMinutes().toString().padStart(2, "0");
  }

  let selectedMessages = [];
  let selectionMode = false;

  function enterSelectionMode(msgId) {
    selectionMode = true;
    selectedMessages = [msgId];
    document.querySelector(`[data-id="${msgId}"]`).style.border = "2px solid blue";
    showMsgMenu();
  }

  function toggleSelection(msgId, div) {
    const i = selectedMessages.indexOf(msgId);
    if (i >= 0) {
      selectedMessages.splice(i, 1);
      div.style.border = "";
    } else {
      selectedMessages.push(msgId);
      div.style.border = "2px solid blue";
    }

    if (selectedMessages.length === 0) exitSelectionMode();
  }

  function exitSelectionMode() {
    selectionMode = false;
    selectedMessages = [];
    document.querySelectorAll(".msg").forEach(m => m.style.border = "");
    document.getElementById("msgMenu").style.display = "none";
  }

  function showMsgMenu() {
    const menu = document.getElementById("msgMenu");
    menu.innerHTML = "";

    if (selectedMessages.length === 1) {
      const msgId = selectedMessages[0];
      const msgEl = document.querySelector(`[data-id="${msgId}"]`);
      const text = msgEl?.innerText;

      const copyBtn = document.createElement("button");
      copyBtn.innerText = "Copy";
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(text);
        exitSelectionMode();
      };
      menu.appendChild(copyBtn);

      const replyBtn = document.createElement("button");
      replyBtn.innerText = "Reply";
      replyBtn.onclick = () => {
        showReplyTag(msgId, text);
        exitSelectionMode();
      };
      menu.appendChild(replyBtn);

      const msgData = msgEl?.dataset;
      const ts = +msgData?.ts || 0;
      const editable = Date.now() - ts < 60000 && msg.from === user;

      if (editable) {
        const editBtn = document.createElement("button");
        editBtn.innerText = "Edit";
        editBtn.onclick = () => {
          document.getElementById("msgInput").value = text;
          deleteMsg(msgId);
          exitSelectionMode();
        };
        menu.appendChild(editBtn);
      }
    }

    const delBtn = document.createElement("button");
    delBtn.innerText = "Delete";
    delBtn.onclick = () => {
      selectedMessages.forEach(deleteMsg);
      exitSelectionMode();
    };
    menu.appendChild(delBtn);

    const cancelBtn = document.createElement("button");
    cancelBtn.innerText = "Cancel";
    cancelBtn.onclick = exitSelectionMode;
    menu.appendChild(cancelBtn);

    menu.style.display = "block";
    menu.style.top = "60px";
    menu.style.left = "50%";
    menu.style.transform = "translateX(-50%)";
  }

  function deleteMsg(id) {
    if (!currentChat) return;
    const path = isGroup
      ? `groupChats/${currentChat}/${id}`
      : `chats/${[user, currentChat].sort().join("_")}/${id}`;
    db.ref(path).remove();
  }

  function setupChatListener(chatId, group) {
    const path = group ? `groupChats/${chatId}` : `chats/${[user, chatId].sort().join("_")}`;
    const ref = db.ref(path);
    document.getElementById("messages").innerHTML = "";

    ref.on("child_added", snap => {
      renderMsg(snap.key, snap.val());
    });

    ref.on("child_removed", snap => {
      const el = document.querySelector(`[data-id="${snap.key}"]`);
      if (el) el.remove();
    });
  }
    </script>
    <script>
  function openChat(name, group = false) {
    currentChat = name;
    isGroup = group;
    document.getElementById("chatWindow").classList.add("active");
    document.getElementById("chatTitle").innerText = name;
    document.getElementById("messages").innerHTML = "";
    setupChatListener(name, group);
    if (!group) setupTypingListener(name);
  }

  function fetchUsersAndGroups() {
    const usersRef = db.ref("users");
    const groupsRef = db.ref("groups");

    usersRef.once("value", snap => {
      const list = document.getElementById("chatList");
      snap.forEach(child => {
        const uname = child.key;
        if (uname !== user) {
          const div = document.createElement("div");
          div.className = "chatItem";
          div.innerText = uname;
          div.onclick = () => openChat(uname, false);
          list.appendChild(div);
        }
      });
    });

    groupsRef.once("value", snap => {
      const list = document.getElementById("chatList");
      snap.forEach(child => {
        const gname = child.val().name;
        const members = child.val().members || {};
        const isMember = members[user];

        const div = document.createElement("div");
        div.className = "chatItem";
        div.innerText = "#" + gname;
        div.onclick = () => {
          if (isMember) {
            openChat(gname, true);
          } else {
            const join = confirm("Join this group?");
            if (join) {
              if (!child.val().public) {
                const pwd = prompt("Enter group password:");
                if (pwd !== child.val().password) return alert("Wrong password.");
              }
              db.ref(`groups/${gname}/members/${user}`).set(true);
              openChat(gname, true);
            }
          }
        };
        list.appendChild(div);
      });
    });
  }

  function createGroup() {
    const gname = prompt("Group name:");
    if (!gname) return;

    const pub = confirm("Make group public?");
    const password = pub ? null : prompt("Enter group password:");

    const newGroup = {
      name: gname,
      admin: user,
      members: { [user]: true },
      public: pub,
      password: pub ? "" : password
    };

    db.ref(`groups/${gname}`).set(newGroup);
    openChat(gname, true);
  }

  function setupChatTitleOptions() {
    const title = document.getElementById("chatTitle");
    title.onclick = () => {
      const menu = document.createElement("div");
      menu.className = "menu";
      menu.style.position = "absolute";
      menu.style.top = "40px";
      menu.style.right = "10px";
      menu.style.background = "#fff";
      menu.style.padding = "10px";
      menu.style.border = "1px solid #ccc";
      menu.style.boxShadow = "0 2px 5px rgba(0,0,0,0.2)";
      menu.innerHTML = "";

      if (!isGroup) {
        const blockBtn = document.createElement("button");
        blockBtn.innerText = "Block User";
        blockBtn.onclick = () => {
          db.ref(`blocked/${user}/${currentChat}`).set(true);
          alert("User blocked.");
          menu.remove();
        };
        menu.appendChild(blockBtn);

        const delChat = document.createElement("button");
        delChat.innerText = "Delete Chat";
        delChat.onclick = () => {
          const path = [user, currentChat].sort().join("_");
          db.ref(`chats/${path}`).remove();
          menu.remove();
        };
        menu.appendChild(delChat);
      } else {
        const leaveBtn = document.createElement("button");
        leaveBtn.innerText = "Leave Group";
        leaveBtn.onclick = () => {
          db.ref(`groups/${currentChat}/leaveRequests/${user}`).set(true);
          alert("Leave request sent.");
          menu.remove();
        };
        menu.appendChild(leaveBtn);

        const viewMembers = document.createElement("button");
        viewMembers.innerText = "View Members";
        viewMembers.onclick = () => {
          db.ref(`groups/${currentChat}/members`).once("value", snap => {
            let out = "";
            snap.forEach(c => {
              out += c.key + "\n";
            });
            alert(out);
            menu.remove();
          });
        };
        menu.appendChild(viewMembers);
      }

      document.body.appendChild(menu);
      setTimeout(() => {
        document.addEventListener("click", () => menu.remove(), { once: true });
      }, 10);
    };
  }

  window.onload = () => {
    fetchUsersAndGroups();
    setupChatTitleOptions();
  };
    </script>
    <script>
  function formatDateHeader(timestamp) {
    const date = new Date(timestamp);
    return date.toDateString();
  }

  function insertFloatingDate(ts) {
    const dateStr = formatDateHeader(ts);
    if (!lastDate || lastDate !== dateStr) {
      const dateDiv = document.createElement("div");
      dateDiv.className = "dateHeader";
      dateDiv.innerText = dateStr;
      document.getElementById("messages").appendChild(dateDiv);
      lastDate = dateStr;
    }
  }

  function requestNotificationPermission() {
    if ("Notification" in window) {
      Notification.requestPermission();
    }
  }

  function sendNotification(title, body) {
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification(title, { body });
    }
  }

  // Call this at login
  requestNotificationPermission();
</script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    height: 100vh;
    overflow: hidden;
  }

  .container {
    display: flex;
    height: 100%;
  }

  #userList, #chatWindow {
    flex: 1;
    overflow-y: auto;
    border-right: 1px solid #ccc;
  }

  #chatWindow {
    display: flex;
    flex-direction: column;
  }

  #chatTitle {
    background: #075e54;
    color: white;
    padding: 10px;
    font-weight: bold;
    position: relative;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #e5ddd5;
  }

  .message {
    background: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    margin-bottom: 6px;
    max-width: 60%;
    word-wrap: break-word;
    position: relative;
  }

  .message.self {
    background: #dcf8c6;
    align-self: flex-end;
  }

  .dateHeader {
    text-align: center;
    font-size: 12px;
    color: #555;
    margin: 10px 0;
  }

  #msgInput {
    display: flex;
    border-top: 1px solid #ccc;
    padding: 6px;
  }

  #msgInput input {
    flex: 1;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  #msgInput button {
    padding: 8px 12px;
    margin-left: 6px;
    background: #075e54;
    color: white;
    border: none;
    border-radius: 6px;
  }

  .replyTag {
    background: #f1f0f0;
    padding: 4px 8px;
    margin-bottom: 4px;
    font-size: 12px;
    color: #444;
    border-left: 3px solid #34b7f1;
  }

  .chatItem {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #ccc;
  }

  .chatItem:hover {
    background: #f1f1f1;
  }

  .menu button {
    display: block;
    width: 100%;
    padding: 6px;
    background: white;
    border: none;
    text-align: left;
    cursor: pointer;
  }

  .menu button:hover {
    background: #eee;
  }
</style>

</body>
</html>
