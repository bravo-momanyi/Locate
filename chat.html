<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bravo Chat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }
    header button {
      background: #25D366;
      border: none;
      padding: 6px 12px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    #userList {
      width: 30%;
      overflow-y: auto;
      padding: 10px;
      border-right: 1px solid #ccc;
    }
    #userList input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #userList button {
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0f7fa;
    }
    #userList button.group {
      background: #dcedc8;
      font-weight: bold;
    }
    .unread-badge {
      background: red;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      float: right;
      margin-top: -15px;
    }
    #chatWindow {
      display: none;
      flex-direction: column;
      flex: 1;
      height: 100%;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease;
      opacity: 0;
      transform: translateX(100%);
    }
    #chatWindow.active {
      opacity: 1;
      transform: translateX(0);
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
    }
    .msg {
      padding: 8px;
      margin: 6px;
      border-radius: 7px;
      max-width: 70%;
      position: relative;
      word-wrap: break-word;
      animation: slideIn 0.3s ease forwards;
    }
    .you {
      background: #dcf8c6;
      align-self: flex-end;
      text-align: right;
    }
    .them {
      background: white;
      align-self: flex-start;
    }
    .msg-time {
      font-size: 10px;
      color: #999;
      margin-top: 4px;
    }
    #sendBar {
      display: flex;
      padding: 10px;
      background: white;
    }
    #sendBar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    #sendBar button {
      margin-left: 5px;
      padding: 8px 14px;
      background: #25D366;
      border: none;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
    #typingIndicator {
      padding-left: 12px;
      font-style: italic;
      font-size: 12px;
      color: gray;
      display: none;
    }
    #floatingDate {
      position: sticky;
      top: 0;
      background: #f0f0f0;
      text-align: center;
      font-size: 13px;
      color: gray;
      z-index: 10;
      padding: 4px 0;
    }
    .date-label {
      text-align: center;
      color: gray;
      font-size: 12px;
      margin: 10px 0 5px;
    }
    @media (max-width: 600px) {
      #userList {
        width: 100%;
      }
      #chatWindow {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: white;
        z-index: 100;
      }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #callOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000000cc;
      color: white;
      z-index: 99999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #callOverlay.show {
      display: flex;
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Welcome</div>
    <button onclick="goToDashboard()">Dashboard</button>
  </header>
  <div style="display: flex; height: calc(100% - 50px);">
    <div id="userList">
      <input id="searchBox" placeholder="Search users/groups..." />
      <button onclick="createGroup()">Create Group</button>
      <div id="recentChats"><h4>Recent Chats</h4></div>
      <div id="userSection"><h4>All Users</h4></div>
      <div id="groupSection"><h4>All Groups</h4></div>
    </div>
    <div id="chatWindow">
      <div style="padding: 10px; background: #128C7E; color: white; display: flex; justify-content: space-between;">
        <span id="chatWith">---</span>
        <div>
          <button onclick="startCall('voice')">üìû</button>
          <button onclick="startCall('video')">üé•</button>
          <button onclick="closeChat()">‚úñ</button>
        </div>
      </div>
      <div id="typingIndicator">Typing...</div>
      <div id="messages"><div id="floatingDate"></div></div>
      <div id="sendBar">
        <input type="file" id="mediaInput" />
        <input id="msgInput" placeholder="Type message..." />
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <!-- Hidden video elements for WebRTC -->
  <video id="localVideo" autoplay muted playsinline style="width: 0; height: 0;"></video>
  <video id="remoteVideo" autoplay playsinline style="width: 0; height: 0;"></video>

  <!-- Call UI -->
  <div id="callOverlay">
    <h2 id="callStatus">Calling...</h2>
    <button onclick="endCall()" style="margin-top: 20px; padding: 10px 20px; background:red; border:none; border-radius:5px; color:white;">End Call</button>
    <button onclick="minimizeCall()" style="margin-top: 10px; padding: 8px 16px;">Minimize</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // üîê Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
  <script>
  // üë§ Current user from session
  let user = sessionStorage.getItem('username');
  if (!user) location.href = "index.html";
  document.getElementById("currentUser").textContent = "Welcome, " + user;

  let currentChat = "", convoRef = null, typingRef = null;
  let allUsers = {}, allGroups = {}, unreadCount = {}, replyingTo = null;
  let recentChats = {};

  const msgBox = document.getElementById("msgInput");
  const messagesDiv = document.getElementById("messages");

  // üåê Go to dashboard
  function goToDashboard() {
    location.href = "app.html";
  }

  // ‚ûï Create Group
  function createGroup() {
    const name = prompt("Enter group name:");
    if (!name) return;
    const isPrivate = confirm("Make this group private?");
    let password = "";
    if (isPrivate) password = prompt("Set group password:");
    const id = db.ref("groups").push().key;
    db.ref("groups/" + id).set({
      name,
      public: !isPrivate,
      password: isPrivate ? password : "",
      createdBy: user,
      members: { [user]: true }
    });
  }

  // üîÑ Load Users
  db.ref("users").on("value", snap => {
    allUsers = snap.val() || {};
    refreshList();
  });

  // üîÑ Load Groups
  db.ref("groups").on("value", snap => {
    allGroups = snap.val() || {};
    refreshList();
  });

  // üîÅ Refresh list
  function refreshList() {
    const term = document.getElementById("searchBox").value.toLowerCase();
    const userSec = document.getElementById("userSection");
    const groupSec = document.getElementById("groupSection");

    userSec.innerHTML = "<h4>All Users</h4>";
    groupSec.innerHTML = "<h4>All Groups</h4>";

    Object.keys(allUsers).forEach(u => {
      if (u === user || !u.toLowerCase().includes(term)) return;
      const btn = document.createElement("button");
      btn.innerHTML = `${u} <small style='color:gray'>${formatLastSeen(allUsers[u]?.lastSeen)}</small>`;
      btn.onclick = () => {
        closeChat();
        setTimeout(() => openChat(u), 300);
      };
      userSec.appendChild(btn);
    });

    Object.entries(allGroups).forEach(([id, g]) => {
      if (!g.name.toLowerCase().includes(term)) return;
      const btn = document.createElement("button");
      btn.className = "group";
      btn.innerHTML = `${g.public ? "# " : "üîí "}${g.name}`;
      btn.onclick = () => {
        if (!g.public && (!g.members || !g.members[user])) {
          const entered = prompt("Enter password to join:");
          if (entered !== g.password) return alert("Incorrect password");
        }
        db.ref("groups/" + id + "/members/" + user).set(true);
        closeChat();
        setTimeout(() => openGroup(id, g.name), 300);
      };
      groupSec.appendChild(btn);
    });
  }

  function formatLastSeen(ts) {
    if (!ts) return "Offline";
    const date = new Date(ts);
    const today = new Date();
    const isToday = date.toDateString() === today.toDateString();
    return isToday
      ? "Today at " + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : date.toLocaleDateString() + " at " + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function chatId(a, b) {
    return [a, b].sort().join("_");
  }

  // üìÇ Open 1-on-1 Chat
  function openChat(toUser) {
    currentChat = toUser;
    document.getElementById("chatWith").textContent = toUser;

    const id = chatId(user, toUser);
    const ref = db.ref("chats/" + id);
    convoRef?.off();
    convoRef = ref;
    messagesDiv.innerHTML = "";

    ref.on("child_added", snap => renderMessage(snap.val(), snap.key));
    db.ref("seen/" + id + "/" + user).set(firebase.database.ServerValue.TIMESTAMP);

    document.getElementById("chatWindow").classList.add("active");
    document.getElementById("chatWindow").style.display = "flex";
  }

  // üìÇ Open Group Chat
  function openGroup(id, name) {
    currentChat = "group_" + id;
    document.getElementById("chatWith").textContent = name;

    const ref = db.ref("groupChats/" + id);
    convoRef?.off();
    convoRef = ref;
    messagesDiv.innerHTML = "";

    ref.on("child_added", snap => renderMessage(snap.val(), snap.key, true));
    document.getElementById("chatWindow").classList.add("active");
    document.getElementById("chatWindow").style.display = "flex";
  }

  // üß† Render message (group or private)
  function renderMessage(msg, id, isGroup = false) {
    if (!msg) return;
    const div = document.createElement("div");
    div.className = "msg " + (msg.from === user ? "you" : "them");
    div.innerHTML = (isGroup ? `<b>${msg.from}</b>: ` : "") + msg.text +
      `<div class="msg-time">${new Date(msg.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // ‚å®Ô∏è Typing indicator
  msgBox.addEventListener("input", () => {
    if (!currentChat.startsWith("group_")) {
      const id = chatId(user, currentChat);
      db.ref("typing/" + id + "/" + user).set(true);
      setTimeout(() => db.ref("typing/" + id + "/" + user).set(false), 1500);
    }
  });

  // ‚ùå Close Chat
  function closeChat() {
    currentChat = "";
    convoRef?.off();
    document.getElementById("chatWindow").classList.remove("active");
    setTimeout(() => {
      document.getElementById("chatWindow").style.display = "none";
      messagesDiv.innerHTML = "";
    }, 300);
  }

  // ‚úâÔ∏è Send message
  function sendMsg() {
    const text = msgBox.value.trim();
    if (!text || !currentChat) return;
    const ts = Date.now();
    const msg = { from: user, text, ts };
    const ref = currentChat.startsWith("group_")
      ? db.ref("groupChats/" + currentChat.slice(6)).push()
      : db.ref("chats/" + chatId(user, currentChat)).push();
    ref.set(msg);
    msgBox.value = "";
  }

  // üìû CALLING SYSTEM (WebRTC via Firebase)
  let peerConn, localStream;

  async function startCall(type = "voice") {
    const isVideo = type === "video";
    localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
    document.getElementById("localVideo").srcObject = localStream;

    peerConn = new RTCPeerConnection();
    localStream.getTracks().forEach(track => peerConn.addTrack(track, localStream));

    peerConn.ontrack = e => {
      document.getElementById("remoteVideo").srcObject = e.streams[0];
    };

    const offer = await peerConn.createOffer();
    await peerConn.setLocalDescription(offer);

    const callId = chatId(user, currentChat);
    db.ref("calls/" + callId).set({ from: user, type, offer: offer.sdp });

    document.getElementById("callOverlay").classList.add("show");
    listenForAnswer(callId);
  }

  function listenForAnswer(callId) {
    db.ref("calls/" + callId + "/answer").on("value", async snap => {
      if (!snap.exists()) return;
      const answer = new RTCSessionDescription({ type: "answer", sdp: snap.val() });
      await peerConn.setRemoteDescription(answer);
    });
  }

  function endCall() {
    document.getElementById("callOverlay").classList.remove("show");
    peerConn?.close();
    if (localStream) localStream.getTracks().forEach(track => track.stop());
  }

  function minimizeCall() {
    document.getElementById("callOverlay").classList.remove("show");
  }
</script>
</body>
</html>
