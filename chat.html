<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp Clone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body class="flex h-screen overflow-hidden">
  <!-- Chat List Sidebar -->
  <aside id="chatList" class="w-full md:w-1/3 lg:w-1/4 border-r border-gray-300 overflow-y-auto">
    <div class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold">Chats</h2>
      <button id="createGroupBtn" class="text-sm text-blue-600 hover:underline">+ Group</button>
    </div>
    <ul id="userList" class="divide-y"></ul>
  </aside>

  <!-- Chat Window -->
  <main class="flex-1 flex flex-col">
    <!-- Chat Header -->
    <div id="chatHeader" class="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
      <div>
        <h2 id="chatName" class="text-lg font-semibold"></h2>
        <p id="chatStatus" class="text-sm text-gray-500"></p>
      </div>
      <button id="closeChat" class="text-red-600 hover:underline">Close</button>
    </div>

    <!-- Messages -->
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-white"></div>

    <!-- Typing Indicator -->
    <div id="typing" class="text-sm text-gray-400 px-4 py-1 hidden">Typing...</div>

    <!-- Message Input -->
    <form id="messageForm" class="flex items-center p-2 border-t gap-2 bg-gray-50">
      <input id="messageInput" type="text" placeholder="Type a message" class="flex-1 border px-3 py-2 rounded" />
      <input type="file" id="fileInput" class="hidden" />
      <button type="button" id="attachBtn" class="text-blue-600">ðŸ“Ž</button>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
    </form>
  </main>

  <!-- Group Modal (Hidden by Default) -->
  <div id="groupModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white p-4 rounded-lg w-96 space-y-4">
      <h3 class="text-lg font-bold">Create Group</h3>
      <input type="text" id="groupName" class="w-full border px-3 py-2 rounded" placeholder="Group Name" />
      <div id="groupUsers" class="max-h-40 overflow-y-auto space-y-2"></div>
      <button id="createGroup" class="bg-blue-600 text-white px-4 py-2 rounded">Create</button>
      <button id="closeModal" class="text-sm text-gray-500 hover:underline">Cancel</button>
    </div>
  </div>

  <script src="chat.js"></script>
<script>
// Firebase config (replace with your own)
const firebaseConfig = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

const currentUser = sessionStorage.getItem("username");
if (!currentUser) location.href = "index.html";

const userList = document.getElementById("userList");
const messagesEl = document.getElementById("messages");
const chatHeader = document.getElementById("chatHeader");
const chatName = document.getElementById("chatName");
const chatStatus = document.getElementById("chatStatus");
const messageForm = document.getElementById("messageForm");
const messageInput = document.getElementById("messageInput");
const attachBtn = document.getElementById("attachBtn");
const fileInput = document.getElementById("fileInput");
const typingEl = document.getElementById("typing");

let selectedChat = null;
let typingTimer;

// Load Users and Groups
function loadUsers() {
  db.ref("users").on("value", snapshot => {
    userList.innerHTML = "";
    snapshot.forEach(child => {
      const user = child.val();
      if (user.username === currentUser) return;
      const li = document.createElement("li");
      li.className = "p-3 hover:bg-gray-100 cursor-pointer";
      li.textContent = user.username;
      li.onclick = () => openChat(user.username, false);
      userList.appendChild(li);
    });
  });

  db.ref("groups").on("child_added", snap => {
    const group = snap.val();
    if (!group.members.includes(currentUser)) return;
    const li = document.createElement("li");
    li.className = "p-3 hover:bg-gray-100 cursor-pointer text-green-600";
    li.textContent = `# ${group.name}`;
    li.onclick = () => openChat(group.id, true);
    userList.appendChild(li);
  });
}

// Open Chat
function openChat(id, isGroup = false) {
  selectedChat = { id, isGroup };
  messagesEl.innerHTML = "";
  chatName.textContent = isGroup ? `# ${id}` : id;
  chatStatus.textContent = isGroup ? "Group" : "Loading...";

  if (!isGroup) {
    db.ref(`users/${id}/lastSeen`).on("value", snap => {
      const val = snap.val();
      if (!val) return;
      chatStatus.textContent = `last seen ${new Date(val).toLocaleTimeString()}`;
    });
  }

  db.ref(getChatPath()).off(); // remove old listener
  db.ref(getChatPath()).on("child_added", snap => {
    const msg = snap.val();
    renderMessage(msg, snap.key);
  });
}

function getChatPath() {
  if (!selectedChat) return "";
  if (selectedChat.isGroup) return `groupMessages/${selectedChat.id}`;
  const ids = [currentUser, selectedChat.id].sort();
  return `messages/${ids[0]}_${ids[1]}`;
}

function renderMessage(msg, id) {
  const div = document.createElement("div");
  div.className = `relative max-w-xs px-4 py-2 rounded shadow text-sm break-words ${
    msg.sender === currentUser ? "bg-blue-100 ml-auto" : "bg-gray-100"
  }`;
  div.innerHTML = msg.text || (msg.fileUrl ? `<a href="${msg.fileUrl}" target="_blank">ðŸ“Ž ${msg.fileName}</a>` : "");

  const ticks = document.createElement("span");
  ticks.className = "absolute bottom-1 right-2 text-xs";

  if (msg.sender === currentUser) {
    if (msg.status === "read") {
      ticks.textContent = "âœ“âœ“";
      ticks.classList.add("text-blue-500");
    } else if (msg.status === "delivered") {
      ticks.textContent = "âœ“âœ“";
    } else {
      ticks.textContent = "âœ“";
    }
    div.appendChild(ticks);

    const del = document.createElement("span");
    del.textContent = " âŒ";
    del.className = "cursor-pointer ml-2 text-red-500";
    del.onclick = () => deleteMessage(id);
    div.appendChild(del);
  } else {
    // Mark as read if you're the recipient
    if (!selectedChat.isGroup) {
      db.ref(`${getChatPath()}/${id}/status`).set("read");
    }
  }

  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}


// Send Message
messageForm.onsubmit = async e => {
  e.preventDefault();
  const text = messageInput.value.trim();
  if (!text || !selectedChat) return;

  const msg = {
    sender: currentUser,
    text,
    timestamp: Date.now(),
    status: "sent"
  };

  const ref = db.ref(getChatPath()).push();
  await ref.set(msg);

  // Set delivered status immediately for group or if user is online
  if (!selectedChat.isGroup) {
    const recipientStatusRef = db.ref(`users/${selectedChat.id}/online`);
    recipientStatusRef.once("value", snap => {
      if (snap.val()) {
        ref.update({ status: "delivered" });
      }
    });
  }

  messageInput.value = "";
  sendTyping(false);
};


// Typing Indicator
messageInput.oninput = () => {
  sendTyping(true);
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => sendTyping(false), 2000);
};

function sendTyping(isTyping) {
  if (!selectedChat || selectedChat.isGroup) return;
  db.ref(`typing/${selectedChat.id}`).set(isTyping ? currentUser : "");
}

db.ref(`typing/${currentUser}`).on("value", snap => {
  const typer = snap.val();
  typingEl.classList.toggle("hidden", !typer);
  if (typer) typingEl.textContent = `${typer} is typing...`;
});

// File Attachments
attachBtn.onclick = () => fileInput.click();
fileInput.onchange = async () => {
  const file = fileInput.files[0];
  if (!file) return;
  const ref = storage.ref().child(`attachments/${Date.now()}_${file.name}`);
  await ref.put(file);
  const url = await ref.getDownloadURL();

  const msg = {
    sender: currentUser,
    fileUrl: url,
    fileName: file.name,
    timestamp: Date.now()
  };

  await db.ref(getChatPath()).push(msg);
};

// Delete Message (basic, for user only)
function deleteMessage(id) {
  db.ref(`${getChatPath()}/${id}`).remove();
}

// Close Chat
document.getElementById("closeChat").onclick = () => {
  selectedChat = null;
  chatName.textContent = "";
  chatStatus.textContent = "";
  messagesEl.innerHTML = "";
};

// Group Modal Logic
document.getElementById("createGroupBtn").onclick = () => {
  document.getElementById("groupModal").classList.remove("hidden");
  const groupUsers = document.getElementById("groupUsers");
  groupUsers.innerHTML = "";
  db.ref("users").once("value", snap => {
    snap.forEach(child => {
      const user = child.val();
      if (user.username === currentUser) return;
      const checkbox = document.createElement("div");
      checkbox.innerHTML = `<label><input type="checkbox" value="${user.username}" /> ${user.username}</label>`;
      groupUsers.appendChild(checkbox);
    });
  });
};

document.getElementById("closeModal").onclick = () => {
  document.getElementById("groupModal").classList.add("hidden");
};

document.getElementById("createGroup").onclick = () => {
  const name = document.getElementById("groupName").value.trim();
  if (!name) return alert("Enter group name");

  const checkboxes = document.querySelectorAll("#groupUsers input:checked");
  const members = Array.from(checkboxes).map(cb => cb.value);
  members.push(currentUser);

  const groupId = `${name}_${Date.now()}`;
  db.ref(`groups/${groupId}`).set({ id: groupId, name, members });
  document.getElementById("groupModal").classList.add("hidden");
};

// Update Last Seen on exit
window.addEventListener("beforeunload", () => {
  db.ref(`users/${currentUser}/lastSeen`).set(Date.now());
});

// Load users and start
loadUsers();
</script>
</body>
</html>
