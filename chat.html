<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp Clone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <style>
    @media (max-width: 768px) {
      #chatList { display: none; }
      #chatWindow { display: flex !important; }
    }
    @media (min-width: 768px) {
      #chatWindow { display: flex; }
    }
    video#localVideo { width: 100px; height: 100px; object-fit: cover; }
    video#remoteVideo { width: 100%; height: 300px; object-fit: cover; }
    #contextMenu {
      min-width: 150px; background: white; border: 1px solid #ddd;
      position: absolute; z-index: 9999;
    }
  </style>
</head>
<body class="flex flex-col md:flex-row h-screen bg-white dark:bg-gray-900 text-black dark:text-white">

  <!-- Header -->
  <header class="w-full md:hidden bg-blue-600 text-white p-4">
    <h1 class="text-xl font-bold">Welcome, <span id="welcomeUserMobile"></span></h1>
  </header>

  <!-- Chat List Sidebar -->
  <aside id="chatList" class="w-full md:w-1/3 lg:w-1/4 border-r border-gray-300 overflow-y-auto hidden md:block">
    <div class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold">Chats</h2>
      <button id="createGroupBtn" class="text-sm text-blue-600 hover:underline">+ Group</button>
    </div>
    <ul id="userList" class="divide-y"></ul>
  </aside>

  <!-- Chat Window -->
  <main id="chatWindow" class="flex-1 flex flex-col hidden">
    <!-- Chat Header -->
    <div id="chatHeader" class="flex items-center justify-between px-4 py-2 border-b bg-gray-100">
      <div class="flex items-center gap-2">
        <button id="backBtn" class="md:hidden text-blue-600 pr-2">&larr;</button>
        <div>
          <h2 id="chatName" class="text-lg font-semibold"></h2>
          <p id="chatStatus" class="text-sm text-gray-500"></p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <input id="searchInput" type="text" placeholder="Search..." class="border px-2 py-1 rounded text-sm hidden md:inline-block" />
        <button id="toggleTheme" class="text-sm text-gray-600 hover:text-black">üåì</button>
        <button id="blockUser" class="text-sm text-red-500">üö´ Block</button>
      </div>
    </div>

    <!-- Messages Area -->
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-white dark:bg-gray-800"></div>

    <!-- Typing Indicator -->
    <div id="typing" class="text-sm text-gray-400 px-4 py-1 hidden">Typing...</div>

    <!-- Message Input -->
    <form id="messageForm" class="flex items-center p-2 border-t gap-2 bg-gray-50">
      <input id="messageInput" type="text" placeholder="Type a message" class="flex-1 border px-3 py-2 rounded" />
      <input type="file" id="fileInput" class="hidden" />
      <button type="button" id="attachBtn" class="text-blue-600">üìé</button>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
    </form>

    <!-- Call Controls -->
    <div id="callControls" class="absolute bottom-20 right-4 flex flex-col space-y-2 z-50">
      <button id="audioCallBtn" class="bg-green-500 text-white px-4 py-2 rounded shadow">üìû Audio</button>
      <button id="videoCallBtn" class="bg-blue-600 text-white px-4 py-2 rounded shadow">üé• Video</button>
    </div>

    <!-- Call Modal -->
    <div id="callModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
      <div id="callModalContent" class="bg-white p-6 rounded-lg text-center space-y-4 w-full max-w-md mx-auto">
        <h3 id="callTitle" class="text-xl font-bold">Calling...</h3>
        <video id="remoteVideo" autoplay playsinline class="bg-black rounded"></video>
        <video id="localVideo" autoplay playsinline muted class="rounded-full absolute bottom-4 right-4 border-2 border-white"></video>
        <button id="endCallBtn" class="bg-red-600 text-white px-4 py-2 rounded">End Call</button>
      </div>
    </div>
  </main>

  <!-- Group Modal -->
  <div id="groupModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-40">
    <div class="bg-white p-4 rounded-lg w-96 space-y-4">
      <h3 class="text-lg font-bold">Create Group</h3>
      <input type="text" id="groupName" class="w-full border px-3 py-2 rounded" placeholder="Group Name" />
      <div id="groupUsers" class="max-h-40 overflow-y-auto space-y-2"></div>
      <div class="flex justify-end gap-2">
        <button id="createGroup" class="bg-blue-600 text-white px-4 py-2 rounded">Create</button>
        <button id="closeModal" class="text-sm text-gray-500 hover:underline">Cancel</button>
      </div>
    </div>
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  // Get current user from session
  const currentUser = sessionStorage.getItem('username') || localStorage.getItem('username');
  if (!currentUser) {
    alert('Session expired');
    location.href = 'index.html';
  }
  document.getElementById('welcomeUserMobile').textContent = currentUser;

  // Get elements
  const userList = document.getElementById("userList");
  const messagesEl = document.getElementById("messages");
  const chatHeader = document.getElementById("chatHeader");
  const chatName = document.getElementById("chatName");
  const chatStatus = document.getElementById("chatStatus");
  const messageForm = document.getElementById("messageForm");
  const messageInput = document.getElementById("messageInput");
  const attachBtn = document.getElementById("attachBtn");
  const fileInput = document.getElementById("fileInput");
  const typingEl = document.getElementById("typing");
  const searchInput = document.getElementById("searchInput");
  const backBtn = document.getElementById("backBtn");
  const chatListEl = document.getElementById("chatList");
  const chatWindowEl = document.getElementById("chatWindow");
  const createGroupBtn = document.getElementById("createGroupBtn");
  const groupModal = document.getElementById("groupModal");
  const closeModal = document.getElementById("closeModal");
  const groupNameInput = document.getElementById("groupName");
  const groupUsers = document.getElementById("groupUsers");
  const createGroup = document.getElementById("createGroup");

  let selectedChat = null;
  let typingTimer;
  let quoteText = "";

  // Load users from Firebase and show in sidebar
  db.ref("users").on("value", snapshot => {
    userList.innerHTML = "";
    const usersObj = snapshot.val();
    if (!usersObj) {
      const li = document.createElement("li");
      li.className = "p-3 text-gray-500";
      li.textContent = "No other users found.";
      userList.appendChild(li);
      return;
    }
    Object.keys(usersObj).forEach(username => {
      if (username === currentUser) return;
      const li = document.createElement("li");
      li.className = "p-3 hover:bg-gray-100 cursor-pointer";
      li.textContent = username;
      li.onclick = () => openChat(username, false);
      userList.appendChild(li);
    });
  });

  // Load groups
  db.ref("groups").on("child_added", snap => {
    const group = snap.val();
    if (!group.members || !group.members[currentUser]) return;
    const li = document.createElement("li");
    li.className = "p-3 hover:bg-gray-100 cursor-pointer text-green-600";
    li.textContent = `# ${group.name}`;
    li.onclick = () => openChat(group.id, true, group.name);
    userList.appendChild(li);
  });

  searchInput.oninput = () => {
    const query = searchInput.value.toLowerCase();
    const messages = messagesEl.querySelectorAll("div[data-id]");
    messages.forEach(m => {
      const match = m.textContent.toLowerCase().includes(query);
      m.style.display = match ? "" : "none";
    });
  };

  backBtn.onclick = () => {
    chatListEl.classList.remove("hidden");
    chatWindowEl.classList.add("hidden");
  };

  function openChat(id, isGroup = false, groupName = "") {
    selectedChat = { id, isGroup, groupName };
    messagesEl.innerHTML = "";
    chatName.textContent = isGroup ? `# ${groupName || id}` : id;
    chatStatus.textContent = isGroup ? "Group" : "Loading...";

    if (!isGroup) {
      db.ref(`users/${id}/lastSeen`).on("value", snap => {
        const val = snap.val();
        if (!val) return;
        chatStatus.textContent = `last seen ${new Date(val).toLocaleTimeString()}`;
      });
    }

    chatListEl.classList.add("hidden");
    chatWindowEl.classList.remove("hidden");

    db.ref(getChatPath()).off();
    db.ref(getChatPath()).on("child_added", snap => {
      const msg = snap.val();
      renderMessage(msg, snap.key);
    });
    db.ref(getChatPath()).on("child_changed", snap => {
      const id = snap.key;
      const updatedMsg = snap.val();
      const bubble = document.querySelector(`[data-id="${id}"]`);
      if (bubble) bubble.remove();
      renderMessage(updatedMsg, id);
    });
    db.ref(getChatPath()).on("child_removed", snap => {
      const id = snap.key;
      const bubble = document.querySelector(`[data-id="${id}"]`);
      if (bubble) bubble.remove();
    });
  }

  function getChatPath() {
    if (!selectedChat) return "";
    if (selectedChat.isGroup) return `groupMessages/${selectedChat.id}`;
    const ids = [currentUser, selectedChat.id].sort();
    return `messages/${ids[0]}_${ids[1]}`;
  }

  function renderMessage(msg, id) {
    const div = document.createElement("div");
    div.dataset.id = id;
    div.className = `relative max-w-xs px-4 py-2 rounded shadow text-sm break-words ${
      msg.sender === currentUser ? "bg-blue-100 ml-auto" : "bg-gray-100"
    }`;
    div.innerHTML = msg.text || (msg.fileUrl ? `<a href="${msg.fileUrl}" target="_blank">üìé ${msg.fileName}</a>` : "");

    div.oncontextmenu = e => {
      e.preventDefault();
      contextMsgId = id;
      contextMsg = msg;
      showContextMenu(e.clientX, e.clientY);
    };

    if (msg.sender !== currentUser && selectedChat && !selectedChat.isGroup) {
      db.ref(`${getChatPath()}/${id}/status`).set("read");
    }
    if (msg.sender === currentUser) {
      const ticks = document.createElement("span");
      ticks.className = "absolute bottom-1 right-2 text-xs";
      if (msg.status === "read") {
        ticks.textContent = "‚úì‚úì";
        ticks.classList.add("text-blue-500");
      } else if (msg.status === "delivered") {
        ticks.textContent = "‚úì‚úì";
      } else {
        ticks.textContent = "‚úì";
      }
      div.appendChild(ticks);
    }

    if (msg.reactions) {
      const reactionBar = document.createElement("div");
      reactionBar.className = "text-sm mt-1";
      for (const [user, emoji] of Object.entries(msg.reactions)) {
        const span = document.createElement("span");
        span.textContent = emoji;
        span.className = "mr-1";
        reactionBar.appendChild(span);
      }
      div.appendChild(reactionBar);
    }

    let startX = null;
    div.addEventListener("touchstart", e => {
      startX = e.touches[0].clientX;
    });
    div.addEventListener("touchend", e => {
      if (!startX) return;
      const endX = e.changedTouches[0].clientX;
      if (endX - startX > 80 && msg.sender !== currentUser) {
        quoteMessage(msg.text);
      }
      startX = null;
    });

    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    if (msg.sender !== currentUser && document.hidden && Notification.permission === "granted") {
      new Notification(`New message from ${msg.sender}`, {
        body: msg.text,
        icon: "/assets/whatsapp-icon.png"
      });
    }
  }

  function quoteMessage(text) {
    quoteText = text;
    messageInput.value = `> ${text}\n`;
    messageInput.focus();
  }

  messageForm.onsubmit = async e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text || !selectedChat) return;

    const blockedRef = db.ref(`blocked/${selectedChat.id}/${currentUser}`);
    const blockedSnap = await blockedRef.once("value");
    if (blockedSnap.exists()) {
      alert("You are blocked by this user.");
      return;
    }

    const msg = {
      sender: currentUser,
      text: quoteText ? `${quoteText}\n\n${text}` : text,
      timestamp: Date.now(),
      status: "sent"
    };

    const ref = db.ref(getChatPath()).push();
    await ref.set(msg);
    quoteText = "";
    messageInput.value = "";
    sendTyping(false);

    if (!selectedChat.isGroup) {
      const statusRef = db.ref(`users/${selectedChat.id}/online`);
      statusRef.once("value", snap => {
        if (snap.val()) {
          ref.update({ status: "delivered" });
        }
      });
    }
  };

  messageInput.oninput = () => {
    sendTyping(true);
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => sendTyping(false), 2000);
  };

  function sendTyping(isTyping) {
    if (!selectedChat || selectedChat.isGroup) return;
    db.ref(`typing/${selectedChat.id}`).set(isTyping ? currentUser : "");
  }

  db.ref(`typing/${currentUser}`).on("value", snap => {
    const typer = snap.val();
    typingEl.classList.toggle("hidden", !typer);
    if (typer) typingEl.textContent = `${typer} is typing...`;
  });

  attachBtn.onclick = () => fileInput.click();
  fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (!file || !selectedChat) return;

    if (file.size > 10 * 1024 * 1024) {
      alert("File is too large (max 10MB).");
      return;
    }

    const ref = storage.ref().child(`attachments/${Date.now()}_${file.name}`);
    await ref.put(file);
    const url = await ref.getDownloadURL();

    const msg = {
      sender: currentUser,
      fileUrl: url,
      fileName: file.name,
      timestamp: Date.now()
    };

    await db.ref(getChatPath()).push(msg);
  };

  function deleteMessage(id) {
    const msgRef = db.ref(`${getChatPath()}/${id}`);
    msgRef.once("value", snap => {
      const msg = snap.val();
      if (!msg) return;
      const timeElapsed = Date.now() - msg.timestamp;
      const canDeleteForEveryone = msg.sender === currentUser && timeElapsed <= 60000;
      const confirmText = canDeleteForEveryone
        ? "Delete for everyone or just for you?" : "Delete for me only?";
      const confirmed = confirm(confirmText);
      if (confirmed && canDeleteForEveryone) {
        msgRef.update({
          text: "üö´ This message was deleted.",
          fileUrl: null,
          fileName: null,
          deleted: true
        });
      } else {
        const bubble = document.querySelector(`[data-id="${id}"]`);
        if (bubble) bubble.remove();
      }
    });
  }

  function editMessage(id, oldText) {
    const newText = prompt("Edit your message:", oldText);
    if (newText && newText.trim() && newText !== oldText) {
      db.ref(`${getChatPath()}/${id}`).update({
        text: newText + " (edited)"
      });
    }
  }

  function toggleStar(id, msg) {
    const ref = db.ref(`stars/${currentUser}/${id}`);
    ref.once("value", snap => {
      if (snap.exists()) {
        ref.remove();
      } else {
        ref.set({ ...msg, chatId: getChatPath() });
      }
    });
  }
  db.ref(`stars/${currentUser}`).once("value", snap => {
    snap.forEach(child => {
      renderMessage(child.val(), child.key);
    });
  });

  function addReaction(msgId) {
    const emoji = prompt("React with emoji:");
    if (!emoji) return;
    db.ref(`${getChatPath()}/${msgId}/reactions/${currentUser}`).set(emoji);
  }

  document.getElementById("blockUser").onclick = () => {
    if (!selectedChat || selectedChat.isGroup) return;
    const confirmBlock = confirm(`Block ${selectedChat.id}?`);
    if (confirmBlock) {
      db.ref(`blocked/${currentUser}/${selectedChat.id}`).set(true);
      alert(`${selectedChat.id} has been blocked.`);
    }
  };

  window.addEventListener("beforeunload", () => {
    db.ref(`users/${currentUser}/lastSeen`).set(Date.now());
  });
  db.ref(`users/${currentUser}/online`).set(true);
  db.ref(`users/${currentUser}/online`).onDisconnect().set(false);
  db.ref(`users/${currentUser}/lastSeen`).onDisconnect().set(Date.now());

  const toggleThemeBtn = document.getElementById("toggleTheme");
  toggleThemeBtn.onclick = () => {
    document.documentElement.classList.toggle("dark");
    localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
  };
  if (localStorage.getItem("theme") === "dark") {
    document.documentElement.classList.add("dark");
  }

  window.addEventListener("resize", () => {
    if (window.innerWidth >= 768) {
      chatListEl.classList.remove("hidden");
      chatWindowEl.classList.add("md:flex");
    }
  });

  if (window.innerWidth < 768) {
    chatListEl.classList.remove("hidden");
    chatWindowEl.classList.add("hidden");
  }

  const audioCallBtn = document.getElementById("audioCallBtn");
  const videoCallBtn = document.getElementById("videoCallBtn");
  const callModal = document.getElementById("callModal");
  const callTitle = document.getElementById("callTitle");
  const endCallBtn = document.getElementById("endCallBtn");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const callModalContent = document.getElementById("callModalContent");

  let pc = null;
  let localStream = null;
  let remoteStream = null;
  let isCaller = false;
  let callHandled = false;
  let minimized = false;
  let callTimeoutTimer;

  const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  audioCallBtn.onclick = () => startCall(false);
  videoCallBtn.onclick = () => startCall(true);

  async function startCall(withVideo) {
    if (!selectedChat || selectedChat.isGroup) {
      alert("Calls are only supported in private chats.");
      return;
    }
    isCaller = true;
    callModal.classList.remove("hidden");
    callTitle.textContent = "Calling...";

    localStream = await navigator.mediaDevices.getUserMedia({
      video: withVideo, audio: true
    });
    localVideo.srcObject = localStream;

    setupPeer();
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const callRef = db.ref(`calls/${selectedChat.id}`);
    callRef.set({
      from: currentUser,
      offer: JSON.stringify(offer),
      video: withVideo
    });

    const callLog = {
      with: selectedChat.id,
      type: withVideo ? "video" : "audio",
      time: Date.now(),
      direction: "outgoing"
    };
    db.ref(`callsHistory/${currentUser}`).push(callLog);

    callRef.on("value", async snap => {
      const data = snap.val();
      if (!data || data.from === currentUser) return;
      try {
        if (data.answer && pc && pc.signalingState !== "closed") {
          await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.answer)));
        }
        if (data.candidate && pc && pc.signalingState !== "closed") {
          await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(data.candidate)));
        }
      } catch (err) {
        console.error("ICE error", err);
      }
    });
  }

  db.ref(`calls/${currentUser}`).on("child_removed", snap => {
    if (callHandled || minimized) {
      endCall("ended");
      alert("Call ended by the other user.");
    }
  });

  function setupPeer() {
    pc = new RTCPeerConnection(servers);
    remoteStream = new MediaStream();
    remoteVideo.srcObject = remoteStream;
    pc.ontrack = event => {
      event.streams[0].getTracks().forEach(track => {
        remoteStream.addTrack(track);
      });
    };
    pc.onicecandidate = event => {
      if (event.candidate) {
        const ref = db.ref(`calls/${isCaller ? selectedChat.id : currentUser}`);
        ref.update({ candidate: JSON.stringify(event.candidate) });
      }
    };
  }

  db.ref(`calls/${currentUser}`).on("value", async snap => {
    const data = snap.val();
    if (!data || data.from === currentUser || callHandled || minimized) return;
    showIncomingPopup(data.from, data.video);
    callTimeoutTimer = setTimeout(() => {
      if (!callHandled) {
        endCall("timeout");
        alert("Missed call from " + data.from);
      }
    }, 60000);
  });

  function showIncomingPopup(fromUser, isVideo) {
    callModal.classList.remove("hidden");
    callModalContent.innerHTML = `
      <h3 class="text-xl font-bold">${fromUser} is calling...</h3>
      <div class="flex justify-center gap-4">
        <button id="acceptCall" class="bg-green-500 text-white px-4 py-2 rounded">Accept</button>
        <button id="cancelCall" class="bg-yellow-500 text-white px-4 py-2 rounded">Cancel</button>
        <button id="rejectCall" class="bg-red-600 text-white px-4 py-2 rounded">Reject</button>
      </div>
    `;
    document.getElementById("acceptCall").onclick = async () => {
      clearTimeout(callTimeoutTimer);
      await acceptIncomingCall(fromUser, isVideo);
    };
    document.getElementById("rejectCall").onclick = () => {
      clearTimeout(callTimeoutTimer);
      endCall("rejected");
    };
    document.getElementById("cancelCall").onclick = () => {
      callModal.classList.add("hidden");
      minimized = true;
    };
  }

  async function acceptIncomingCall(fromUser, withVideo) {
    callModal.classList.remove("hidden");
    callModalContent.innerHTML = `
      <h3 id="callTitle" class="text-xl font-bold">In Call...</h3>
      <video id="remoteVideo" autoplay playsinline class="bg-black rounded"></video>
      <video id="localVideo" autoplay playsinline muted class="rounded-full absolute bottom-4 right-4 border-2 border-white"></video>
      <button id="endCallBtn" class="bg-red-600 text-white px-4 py-2 rounded">End Call</button>
    `;
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    localStream = await navigator.mediaDevices.getUserMedia({
      video: withVideo,
      audio: true
    });
    localVideo.srcObject = localStream;
    setupPeer();
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    const callRef = db.ref(`calls/${currentUser}`);
    const snap = await callRef.once("value");
    const data = snap.val();
    if (!data || !data.offer) return;
    await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.offer)));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    callHandled = true;
    await callRef.update({ answer: JSON.stringify(answer) });
    callRef.on("value", async snap => {
      const data = snap.val();
      if (!data || data.from === currentUser) return;
      if (data.candidate && pc && pc.signalingState !== "closed") {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(data.candidate)));
        } catch (err) {
          console.error("Error adding ICE candidate", err);
        }
      }
    });
    const callLog = {
      with: fromUser,
      type: withVideo ? "video" : "audio",
      time: Date.now(),
      direction: "incoming"
    };
    db.ref(`callsHistory/${currentUser}`).push(callLog);
    document.getElementById("endCallBtn").onclick = () => endCall();
  }

  function endCall(reason = "ended") {
    callModal.classList.add("hidden");
    callHandled = false;
    minimized = false;
    clearTimeout(callTimeoutTimer);
    if (pc) pc.close();
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    if (selectedChat) db.ref(`calls/${selectedChat.id}`).remove();
    db.ref(`calls/${currentUser}`).remove();
    if (reason === "rejected" || reason === "timeout") {
      console.log("Call " + reason);
    }
  }

  db.ref(`callsHistory/${currentUser}`).once("value", snap => {
    snap.forEach(child => {
      const log = child.val();
      console.log(`[${log.direction}] ${log.with} - ${log.type} at ${new Date(log.time).toLocaleTimeString()}`);
    });
  });

  const contextMenu = document.createElement("div");
  contextMenu.id = "contextMenu";
  contextMenu.className = "absolute bg-white border rounded shadow-md text-sm z-50 hidden";
  contextMenu.innerHTML = `
    <div class="p-2 hover:bg-gray-200 cursor-pointer" data-action="reply">‚Ü©Ô∏è Reply</div>
    <div class="p-2 hover:bg-gray-200 cursor-pointer" data-action="edit">‚úèÔ∏è Edit</div>
    <div class="p-2 hover:bg-gray-200 cursor-pointer" data-action="delete">‚ùå Delete</div>
    <div class="p-2 hover:bg-gray-200 cursor-pointer" data-action="react">üòä React</div>
  `;
  document.body.appendChild(contextMenu);

  let contextMsgId = null;
  let contextMsg = null;

  function showContextMenu(x, y) {
    contextMenu.style.top = `${y}px`;
    contextMenu.style.left = `${x}px`;
    contextMenu.classList.remove("hidden");
  }

  document.body.addEventListener("click", () => {
    contextMenu.classList.add("hidden");
  });
  window.addEventListener("scroll", () => contextMenu.classList.add("hidden"));
  window.addEventListener("resize", () => contextMenu.classList.add("hidden"));

  contextMenu.onclick = e => {
    const action = e.target.dataset.action;
    if (!action || !contextMsgId || !contextMsg) return;
    switch (action) {
      case "reply":
        quoteMessage(contextMsg.text);
        break;
      case "edit":
        editMessage(contextMsgId, contextMsg.text);
        break;
      case "delete":
        deleteMessage(contextMsgId);
        break;
      case "react":
        addReaction(contextMsgId);
        break;
    }
    contextMenu.classList.add("hidden");
  };

  createGroupBtn.onclick = () => {
    groupModal.classList.remove("hidden");
    groupNameInput.value = "";
    groupUsers.innerHTML = "";
    db.ref("users").once("value", snap => {
      const usersObj = snap.val();
      if (!usersObj) return;
      Object.keys(usersObj).forEach(username => {
        if (username === currentUser) return;
        const div = document.createElement("div");
        div.className = "flex items-center gap-2 p-1";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = username;
        div.appendChild(checkbox);
        div.appendChild(document.createTextNode(username));
        groupUsers.appendChild(div);
      });
    });
  };

  closeModal.onclick = () => groupModal.classList.add("hidden");

  createGroup.onclick = () => {
    const name = groupNameInput.value.trim();
    if (!name) return alert("Group name required!");
    const memberCheckboxes = groupUsers.querySelectorAll("input[type=checkbox]:checked");
    if (memberCheckboxes.length < 1) return alert("Select at least one member.");
    const members = { [currentUser]: true };
    memberCheckboxes.forEach(cb => members[cb.value] = true);
    const groupId = "group_" + Date.now();
    db.ref(`groups/${groupId}`).set({
      id: groupId,
      name,
      members
    });
    groupModal.classList.add("hidden");
    openChat(groupId, true, name);
  };
</script>
</body>
</html>
