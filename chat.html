<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bravo Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #ece5dd;
    }
    #chat-container {
      display: flex;
      height: 100%;
    }
    #sidebar {
      width: 30%;
      background: #ffffff;
      border-right: 1px solid #ccc;
      overflow-y: auto;
    }
    #chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f0f0f0;
    }
    #chat-header {
      background: #075e54;
      color: white;
      padding: 10px;
      font-weight: bold;
      position: relative;
    }
    #chat-title-options {
      position: absolute;
      right: 10px;
      top: 10px;
      display: flex;
      gap: 10px;
    }
    #message-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    #message-input-container {
      padding: 10px;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    #reply-tag {
      background: #f1f1f1;
      padding: 5px 10px;
      margin-bottom: 5px;
      border-left: 3px solid #34b7f1;
      display: none;
    }
    #msg-input-row {
      display: flex;
      gap: 10px;
    }
    #msg-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
    }
    #send-btn {
      background: #128c7e;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
    }
    .message {
      padding: 8px 10px;
      margin: 5px 0;
      border-radius: 8px;
      max-width: 70%;
      position: relative;
    }
    .sent {
      background: #dcf8c6;
      align-self: flex-end;
    }
    .received {
      background: white;
      align-self: flex-start;
    }
    .msg-time {
      font-size: 10px;
      color: gray;
      position: absolute;
      bottom: 4px;
      right: 10px;
    }
    .tick {
      font-size: 12px;
      margin-left: 4px;
    }
    .selected {
      outline: 2px solid #128c7e;
    }
    #multi-action-bar {
      display: none;
      background: #eee;
      padding: 5px 10px;
      justify-content: space-between;
      align-items: center;
    }
    #typing-indicator {
      font-size: 13px;
      color: #333;
      margin-left: 10px;
      display: none;
    }
  </style>
</head>
<body>
<div id="chat-container">
  <div id="sidebar">
    <div style="padding: 10px; font-weight: bold;">Chats & Groups</div>
    <div id="chat-list"></div>
  </div>

  <div id="chat-main">
    <div id="chat-header">
      <span id="chat-title">Bravo Chat</span>
      <span id="typing-indicator"></span>
      <div id="chat-title-options">
        <button onclick="deleteChat()">Delete Chat</button>
        <button onclick="blockUser()">Block User</button>
      </div>
    </div>

    <div id="multi-action-bar">
      <button onclick="copySelected()">Copy</button>
      <button onclick="editSelected()">Edit</button>
      <button onclick="deleteSelected()">Delete</button>
      <button onclick="cancelSelection()">Cancel</button>
    </div>

    <div id="message-list"></div>

    <div id="message-input-container">
      <div id="reply-tag">
        Replying to: <span id="reply-preview"></span>
      </div>
      <div id="msg-input-row">
        <input id="msg-input" type="text" placeholder="Type a message..." oninput="updateTyping()" />
        <button id="send-btn" onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase & App Logic -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUser = localStorage.getItem("user"); // stored username
  let currentChat = null;
  let selectedMessages = [];
  let replyToMsg = null;
  const chatListEl = document.getElementById("chat-list");
  const msgListEl = document.getElementById("message-list");
  const chatTitleEl = document.getElementById("chat-title");
  const typingIndicatorEl = document.getElementById("typing-indicator");
  const replyTagEl = document.getElementById("reply-tag");
  const replyPreviewEl = document.getElementById("reply-preview");

  function loadChatList() {
    db.ref("recentChats/" + currentUser).on("value", snap => {
      chatListEl.innerHTML = "";
      const data = snap.val();
      if (data) {
        Object.keys(data).forEach(key => {
          const btn = document.createElement("button");
          btn.innerText = key;
          btn.style.display = "block";
          btn.style.width = "100%";
          btn.style.padding = "10px";
          btn.style.border = "none";
          btn.style.background = "#f9f9f9";
          btn.onclick = () => openChat(key);
          chatListEl.appendChild(btn);
        });
      }
    });
  }

  function openChat(usernameOrGroup) {
    currentChat = usernameOrGroup;
    chatTitleEl.innerText = usernameOrGroup;
    msgListEl.innerHTML = "";

    const isGroup = usernameOrGroup.includes("group:");

    const path = isGroup ? `groupChats/${usernameOrGroup}` : `chats/${chatKey(currentUser, usernameOrGroup)}`;

    db.ref(path).on("value", snap => {
      msgListEl.innerHTML = "";
      const data = snap.val();
      if (data) {
        Object.keys(data).sort().forEach(key => {
          renderMsg(key, data[key]);
        });
      }
      scrollToBottom();
    });

    // Typing listener
    const typingPath = `typing/${chatKey(currentUser, usernameOrGroup)}`;
    db.ref(typingPath).on("value", snap => {
      const data = snap.val();
      if (data && data[usernameOrGroup]) {
        typingIndicatorEl.style.display = data[usernameOrGroup] ? "inline" : "none";
        typingIndicatorEl.innerText = data[usernameOrGroup] ? `${usernameOrGroup} is typing...` : "";
      }
    });
  }

  function chatKey(a, b) {
    return [a, b].sort().join("_");
  }

  function renderMsg(key, msg) {
    const div = document.createElement("div");
    div.className = "message " + (msg.from === currentUser ? "sent" : "received");
    div.innerText = msg.text;
    div.dataset.key = key;
    div.onclick = (e) => onMsgClick(e, key);
    div.oncontextmenu = (e) => onMsgRightClick(e, key);
    
    const time = document.createElement("div");
    time.className = "msg-time";
    const d = new Date(msg.ts);
    time.innerText = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    if (msg.from === currentUser) {
      const tick = document.createElement("span");
      tick.className = "tick";
      tick.innerText = msg.readBy ? "✓✓✓" : "✓";
      time.appendChild(tick);
    }

    div.appendChild(time);
    msgListEl.appendChild(div);
  }

  function scrollToBottom() {
    msgListEl.scrollTop = msgListEl.scrollHeight;
  }
  function sendMsg() {
    const input = document.getElementById("msg-input");
    const text = input.value.trim();
    if (!text || !currentChat) return;

    const isGroup = currentChat.includes("group:");
    const path = isGroup ? `groupChats/${currentChat}` : `chats/${chatKey(currentUser, currentChat)}`;
    const msgKey = db.ref().push().key;
    const now = Date.now();

    const msgObj = {
      from: currentUser,
      text: text,
      ts: now
    };

    if (replyToMsg) {
      msgObj.replyTo = replyToMsg.text;
      replyToMsg = null;
      replyTagEl.style.display = "none";
      replyPreviewEl.innerText = "";
    }

    db.ref(`${path}/${msgKey}`).set(msgObj);
    db.ref(`recentChats/${currentUser}/${currentChat}`).set(now);
    if (!isGroup) db.ref(`recentChats/${currentChat}/${currentUser}`).set(now);

    input.value = "";
    stopTyping();
  }

  function updateTyping() {
    const input = document.getElementById("msg-input").value.trim();
    const typingPath = `typing/${chatKey(currentUser, currentChat)}`;
    db.ref(`${typingPath}/${currentUser}`).set(!!input);
  }

  function stopTyping() {
    const typingPath = `typing/${chatKey(currentUser, currentChat)}`;
    db.ref(`${typingPath}/${currentUser}`).set(false);
  }

  function replyTo(messageText) {
    replyToMsg = { text: messageText };
    replyTagEl.style.display = "block";
    replyPreviewEl.innerText = messageText;
  }

  function cancelReply() {
    replyToMsg = null;
    replyTagEl.style.display = "none";
    replyPreviewEl.innerText = "";
  }

  document.getElementById("msg-input").addEventListener("keydown", e => {
    if (e.key === "Enter") sendMsg();
  });

  function onMsgClick(e, key) {
    if (selectedMessages.length > 0) {
      toggleSelectMessage(key, e.currentTarget);
    } else if (e.detail === 2) {
      replyTo(e.currentTarget.innerText);
    }
  }

  function onMsgRightClick(e, key) {
    e.preventDefault();
    toggleSelectMessage(key, e.currentTarget);
  }

  function toggleSelectMessage(key, el) {
    if (selectedMessages.includes(key)) {
      selectedMessages = selectedMessages.filter(k => k !== key);
      el.style.border = "none";
    } else {
      selectedMessages.push(key);
      el.style.border = "2px solid #007bff";
    }
    document.getElementById("multi-action-bar").style.display = selectedMessages.length ? "flex" : "none";
  }

  function cancelSelection() {
    selectedMessages = [];
    document.getElementById("multi-action-bar").style.display = "none";
    Array.from(document.getElementsByClassName("message")).forEach(el => el.style.border = "none");
      }
  function copySelectedMessages() {
    const path = currentChat.includes("group:")
      ? `groupChats/${currentChat}`
      : `chats/${chatKey(currentUser, currentChat)}`;

    db.ref(path).once("value", snap => {
      const msgs = snap.val() || {};
      const selected = selectedMessages.map(k => msgs[k]?.text).filter(Boolean).join("\n");
      navigator.clipboard.writeText(selected);
      cancelSelection();
    });
  }

  function editSelectedMessage() {
    if (selectedMessages.length !== 1) return;
    const key = selectedMessages[0];
    const path = currentChat.includes("group:")
      ? `groupChats/${currentChat}/${key}`
      : `chats/${chatKey(currentUser, currentChat)}/${key}`;

    db.ref(path).once("value", snap => {
      const msg = snap.val();
      if (msg && msg.from === currentUser && Date.now() - msg.ts < 60000) {
        document.getElementById("msg-input").value = msg.text;
        editingMessage = key;
        cancelSelection();
      }
    });
  }

  function deleteSelectedMessages(forEveryone = false) {
    const isGroup = currentChat.includes("group:");
    const basePath = isGroup ? `groupChats/${currentChat}` : `chats/${chatKey(currentUser, currentChat)}`;

    selectedMessages.forEach(k => {
      if (forEveryone) {
        db.ref(`${basePath}/${k}`).remove();
      } else {
        db.ref(`${basePath}/${k}/deletedFor`).update({ [currentUser]: true });
      }
    });
    cancelSelection();
  }

  function updateReadReceipts(path, key) {
    const ref = db.ref(`${path}/${key}/readBy`);
    ref.once("value", snap => {
      const val = snap.val() || {};
      if (!val[currentUser]) {
        val[currentUser] = Date.now();
        ref.set(val);
      }
    });
  }

  function chatKey(userA, userB) {
    return [userA, userB].sort().join("_");
  }

  function getUserName(uid) {
    return uid === currentUser ? "You" : uid;
  }

  function showTypingIndicator(partner) {
    const path = `typing/${chatKey(currentUser, partner)}`;
    db.ref(path).on("value", snap => {
      const typingData = snap.val();
      if (typingData && typingData[partner]) {
        typingEl.innerText = `${partner} is typing...`;
        typingEl.style.display = "block";
      } else {
        typingEl.style.display = "none";
      }
    });
  }

  function showReadStatus(msg) {
    if (msg.readBy) {
      const readers = Object.keys(msg.readBy);
      if (readers.includes(currentUser)) return "✓✓✓";
      return readers.length > 0 ? "✓✓" : "✓";
    }
    return "✓";
  }

  function formatTimestamp(ts) {
    const date = new Date(ts);
    return isNaN(date.getTime()) ? "" : `${date.getHours()}:${date.getMinutes().toString().padStart(2, "0")}`;
  }
  function showGroupMembers(groupId) {
    const modal = document.getElementById("modal");
    modal.innerHTML = "<h3>Group Members</h3>";
    db.ref(`groups/${groupId}`).once("value", snap => {
      const group = snap.val();
      if (!group) return;

      const members = group.members || {};
      Object.keys(members).forEach(user => {
        const div = document.createElement("div");
        div.innerText = user;
        if (currentUser === group.admin && user !== currentUser) {
          const makeAdminBtn = document.createElement("button");
          makeAdminBtn.innerText = "Make Admin";
          makeAdminBtn.onclick = () => db.ref(`groups/${groupId}/admin`).set(user);

          const removeBtn = document.createElement("button");
          removeBtn.innerText = "Remove";
          removeBtn.onclick = () => db.ref(`groups/${groupId}/members/${user}`).remove();

          div.append(makeAdminBtn, removeBtn);
        }
        modal.appendChild(div);
      });
    });
    modal.style.display = "block";
  }

  function leaveGroup(groupId) {
    db.ref(`groups/${groupId}/leaveRequests/${currentUser}`).set(true);
    alert("Leave request sent to admin.");
  }

  function handleLeaveRequests(groupId) {
    const modal = document.getElementById("modal");
    modal.innerHTML = "<h3>Leave Requests</h3>";
    db.ref(`groups/${groupId}/leaveRequests`).once("value", snap => {
      const reqs = snap.val() || {};
      Object.keys(reqs).forEach(user => {
        const div = document.createElement("div");
        div.innerText = user;

        const approve = document.createElement("button");
        approve.innerText = "Approve";
        approve.onclick = () => {
          db.ref(`groups/${groupId}/members/${user}`).remove();
          db.ref(`groups/${groupId}/leaveRequests/${user}`).remove();
        };

        const reject = document.createElement("button");
        reject.innerText = "Reject";
        reject.onclick = () => db.ref(`groups/${groupId}/leaveRequests/${user}`).remove();

        div.append(approve, reject);
        modal.appendChild(div);
      });
    });
    modal.style.display = "block";
  }

  function deleteGroup(groupId) {
    if (confirm("Are you sure you want to delete this group?")) {
      db.ref(`groups/${groupId}`).remove();
      db.ref(`groupChats/${groupId}`).remove();
    }
  }

  function blockUser(userId) {
    if (confirm(`Block ${userId}?`)) {
      db.ref(`blocks/${currentUser}/${userId}`).set(true);
      alert(`${userId} blocked.`);
    }
  }

  function isBlocked(userId, callback) {
    db.ref(`blocks/${userId}/${currentUser}`).once("value", snap => {
      callback(!!snap.val());
    });
  }

  function handleChatHeaderClick() {
    const modal = document.getElementById("modal");
    modal.innerHTML = "";

    if (currentChat.startsWith("group:")) {
      const groupId = currentChat.replace("group:", "");
      const viewMembers = document.createElement("button");
      viewMembers.innerText = "View Members";
      viewMembers.onclick = () => showGroupMembers(groupId);

      const leave = document.createElement("button");
      leave.innerText = "Leave Group";
      leave.onclick = () => leaveGroup(groupId);

      const handleReq = document.createElement("button");
      handleReq.innerText = "Handle Leave Requests";
      handleReq.onclick = () => handleLeaveRequests(groupId);

      const delGroup = document.createElement("button");
      delGroup.innerText = "Delete Group";
      delGroup.onclick = () => deleteGroup(groupId);

      modal.append(viewMembers, leave, handleReq, delGroup);
    } else {
      const block = document.createElement("button");
      block.innerText = "Block User";
      block.onclick = () => blockUser(currentChat);

      const delChat = document.createElement("button");
      delChat.innerText = "Delete Chat";
      delChat.onclick = () => {
        if (confirm("Delete all messages with this user?")) {
          db.ref(`chats/${chatKey(currentUser, currentChat)}`).remove();
        }
      };

      modal.append(block, delChat);
    }
    modal.style.display = "block";
  }

  document.getElementById("chat-title").addEventListener("click", handleChatHeaderClick);
  let selectedMsgs = [];

  function renderActionBar() {
    const actionBar = document.getElementById("action-bar");
    actionBar.innerHTML = "";

    const copyBtn = document.createElement("button");
    copyBtn.innerText = "Copy";
    copyBtn.onclick = () => {
      const texts = selectedMsgs.map(id => messages[id]?.text).join("\n");
      navigator.clipboard.writeText(texts);
      selectedMsgs = [];
      renderMsgs(Object.values(messages));
    };

    if (selectedMsgs.length === 1 && messages[selectedMsgs[0]]?.from === currentUser && Date.now() - messages[selectedMsgs[0]].ts < 60000) {
      const editBtn = document.createElement("button");
      editBtn.innerText = "Edit";
      editBtn.onclick = () => {
        const msg = messages[selectedMsgs[0]];
        input.value = msg.text;
        input.dataset.editing = selectedMsgs[0];
        selectedMsgs = [];
        renderMsgs(Object.values(messages));
      };
      actionBar.appendChild(editBtn);
    }

    const deleteBtn = document.createElement("button");
    deleteBtn.innerText = "Delete";
    deleteBtn.onclick = () => {
      const forEveryone = confirm("Delete for everyone?");
      selectedMsgs.forEach(msgId => {
        if (forEveryone && messages[msgId]?.from === currentUser && Date.now() - messages[msgId].ts < 60000) {
          db.ref(`${msgRefPath}/${msgId}`).update({ deleted: true });
        } else {
          db.ref(`deleted/${currentUser}/${msgRefPath.replace(/\//g, "_")}/${msgId}`).set(true);
        }
      });
      selectedMsgs = [];
      renderMsgs(Object.values(messages));
    };

    const cancelBtn = document.createElement("button");
    cancelBtn.innerText = "Cancel";
    cancelBtn.onclick = () => {
      selectedMsgs = [];
      renderMsgs(Object.values(messages));
    };

    actionBar.append(copyBtn, deleteBtn, cancelBtn);
  }

  function handleRightClick(msgId, e) {
    e.preventDefault();
    if (!selectedMsgs.includes(msgId)) {
      selectedMsgs.push(msgId);
    } else {
      selectedMsgs = selectedMsgs.filter(id => id !== msgId);
    }
    renderMsgs(Object.values(messages));
  }

  function renderModal() {
    const modal = document.createElement("div");
    modal.id = "modal";
    modal.style = `
      display: none;
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      max-height: 80%;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #aaa;
      padding: 1em;
      z-index: 1000;
    `;
    document.body.appendChild(modal);

    modal.addEventListener("click", (e) => {
      if (e.target.id === "modal") modal.style.display = "none";
    });
  }

  renderModal();
  function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }
  }

  function showNotification(title, body) {
    if (document.hidden && Notification.permission === "granted") {
      new Notification(title, { body });
    }
  }

  function renderMsgs(msgList) {
    const area = document.getElementById("chat-area");
    area.innerHTML = "";
    let lastDate = "";
    msgList.sort((a, b) => a.ts - b.ts).forEach(msg => {
      const msgDate = new Date(msg.ts).toDateString();
      if (msgDate !== lastDate) {
        const dateLabel = document.createElement("div");
        dateLabel.className = "date-label";
        dateLabel.innerText = msgDate;
        area.appendChild(dateLabel);
        lastDate = msgDate;
      }

      if (deleted[currentUser]?.[msg.code]) return;
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `
        ${msg.replyTo ? `<div class="reply-tag small">Replying to: ${messages[msg.replyTo]?.text || "(message deleted)"}</div>` : ""}
        <div class="msg-bubble ${msg.from === currentUser ? "me" : "other"}"
             oncontextmenu="handleRightClick('${msg.code}', event)">
          ${msg.deleted ? "<i>Message deleted</i>" : msg.text}
          <span class="meta">${msg.from}${formatTicks(msg)} ${formatTime(msg.ts)}</span>
        </div>`;
      if (selectedMsgs.includes(msg.code)) div.classList.add("selected");
      area.appendChild(div);
    });

    area.scrollTop = area.scrollHeight;
    if (selectedMsgs.length) renderActionBar();
  }

  function loadUsersAndGroups() {
    const list = document.getElementById("user-list");
    list.innerHTML = "";

    db.ref("users").once("value", snap => {
      const users = snap.val() || {};
      Object.keys(users).forEach(user => {
        if (user !== currentUser) {
          const div = document.createElement("div");
          div.innerText = user;
          div.onclick = () => openChat(user, false);
          list.appendChild(div);
        }
      });
    });

    db.ref("groups").once("value", snap => {
      const groups = snap.val() || {};
      Object.entries(groups).forEach(([id, group]) => {
        const div = document.createElement("div");
        div.innerText = group.name;
        div.onclick = () => {
          if (!group.members || !group.members[currentUser]) {
            if (!group.public) {
              const pass = prompt("This is a private group. Enter password:");
              if (pass !== group.password) return alert("Incorrect password.");
            }
            if (!group.members) group.members = {};
            group.members[currentUser] = true;
            db.ref(`groups/${id}/members/${currentUser}`).set(true);
          }
          openChat(group.name, true);
        };
        list.appendChild(div);
      });
    });
  }

  requestNotificationPermission();
  loadUsersAndGroups();
  function showGroupOptions(groupName) {
    const groupId = groupName;
    db.ref(`groups/${groupId}`).once("value", snap => {
      const group = snap.val();
      if (!group) return alert("Group not found");

      const isAdmin = group.admin === currentUser;
      const members = group.members ? Object.keys(group.members) : [];

      let html = `<h3>Members of ${group.name}</h3>`;
      members.forEach(member => {
        html += `<div>${member}`;
        if (isAdmin && member !== currentUser) {
          html += `
            <button onclick="makeAdmin('${groupId}', '${member}')">Make Admin</button>
            <button onclick="removeMember('${groupId}', '${member}')">Remove</button>`;
        }
        html += `</div>`;
      });

      if (isAdmin && group.leaveRequests) {
        html += `<h4>Leave Requests</h4>`;
        Object.keys(group.leaveRequests).forEach(user => {
          html += `<div>${user}
            <button onclick="confirmLeave('${groupId}', '${user}')">Confirm</button>
            <button onclick="cancelLeave('${groupId}', '${user}')">Cancel</button>
          </div>`;
        });
      }

      html += isAdmin
        ? `<button onclick="deleteGroup('${groupId}')">Delete Group</button>`
        : `<button onclick="requestLeave('${groupId}')">Leave Group</button>`;

      showPopup(html);
    });
  }

  function showPopup(content) {
    const popup = document.createElement("div");
    popup.className = "popup";
    popup.innerHTML = `<div class="popup-inner">${content}<br><button onclick="this.parentElement.parentElement.remove()">Close</button></div>`;
    document.body.appendChild(popup);
  }

  function makeAdmin(groupId, user) {
    db.ref(`groups/${groupId}/admin`).set(user);
    alert(`${user} is now admin.`);
  }

  function removeMember(groupId, user) {
    db.ref(`groups/${groupId}/members/${user}`).remove();
    alert(`${user} removed.`);
  }

  function requestLeave(groupId) {
    db.ref(`groups/${groupId}/leaveRequests/${currentUser}`).set(true);
    alert("Leave request sent to admin.");
  }

  function confirmLeave(groupId, user) {
    db.ref(`groups/${groupId}/members/${user}`).remove();
    db.ref(`groups/${groupId}/leaveRequests/${user}`).remove();
    alert(`${user} removed.`);
  }

  function cancelLeave(groupId, user) {
    db.ref(`groups/${groupId}/leaveRequests/${user}`).remove();
    alert("Leave request canceled.");
  }

  function deleteGroup(groupId) {
    if (confirm("Are you sure? This will delete the entire group.")) {
      db.ref(`groups/${groupId}`).remove();
      db.ref(`groupChats/${groupId}`).remove();
      alert("Group deleted.");
    }
  }
  function initApp() {
    const storedUser = localStorage.getItem("user");
    if (!storedUser) {
      location.href = "index.html"; // redirect to login
      return;
    }

    currentUser = storedUser;
    document.getElementById("user-header").innerText = currentUser;
    db.ref(`users/${currentUser}/lastSeen`).set(Date.now());

    db.ref(`users/${currentUser}`).once("value", snap => {
      if (!snap.exists()) {
        db.ref(`users/${currentUser}`).set({
          email: "",
          lastSeen: Date.now(),
          mobile: "",
          password: ""
        });
      }
    });

    window.addEventListener("beforeunload", () => {
      db.ref(`users/${currentUser}/lastSeen`).set(Date.now());
    });

    setupTypingListener();
    loadUsersAndGroups();
  }

  initApp();
</script>
</body>
</html>
