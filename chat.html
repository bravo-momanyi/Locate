<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bravo Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }
    header button {
      background: #25D366;
      border: none;
      padding: 6px 12px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    #userList {
      width: 30%;
      overflow-y: auto;
      padding: 10px;
      border-right: 1px solid #ccc;
    }
    #userList input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #userList button {
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0f7fa;
    }
    #userList button.group {
      background: #dcedc8;
      font-weight: bold;
    }
    .unread-badge {
      background: red;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      float: right;
      margin-top: -15px;
    }
    #chatWindow {
      display: none;
      flex-direction: column;
      flex: 1;
      height: 100%;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease;
      opacity: 0;
      transform: translateX(100%);
    }
    #chatWindow.active {
      opacity: 1;
      transform: translateX(0);
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
    }
    .msg {
      padding: 8px;
      margin: 6px;
      border-radius: 7px;
      max-width: 70%;
      position: relative;
      word-wrap: break-word;
      animation: slideIn 0.3s ease forwards;
    }
    .you {
      background: #dcf8c6;
      align-self: flex-end;
      text-align: right;
    }
    .them {
      background: white;
      align-self: flex-start;
    }
    .msg-time {
      font-size: 10px;
      color: #888;
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }
    .msg-status {
      margin-left: 6px;
      font-weight: bold;
      color: #999;
    }
    #sendBar {
      display: flex;
      padding: 10px;
      background: white;
    }
    #sendBar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    #sendBar button {
      margin-left: 5px;
      padding: 8px 14px;
      background: #25D366;
      border: none;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
    #typingIndicator {
      font-size: 16px;
      font-weight: bold;
      padding: 5px;
      color: #0a9c3c;
      display: none;
    }
    .date-label {
  text-align: center;
  margin: 10px 0;
  font-weight: bold;
  color: #999;
    }
    #msgMenu {
      display: none;
      position: absolute;
      background: white;
      border: 2px solid #888;
      border-radius: 10px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      min-width: 240px;
      font-size: 17px;
      padding: 10px;
    }
    #msgMenu button {
      width: 100%;
      border: none;
      padding: 16px 20px;
      background: white;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    #msgMenu button:last-child {
      border-bottom: none;
    }
    #msgMenu button:hover {
      background: #f2f2f2;
    }
    #backBtn {
      padding: 6px 12px;
      font-size: 24px;
    }
    @media (max-width: 600px) {
      #userList { width: 100%; }
      #chatWindow {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        background: white;
        z-index: 100;
      }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser">Welcome</div>
    <button onclick="goToDashboard()">Dashboard</button>
  </header>
  <div style="display: flex; height: calc(100% - 50px);">
    <div id="userList">
      <div style="position: relative;">
        <input id="searchBox" placeholder="Search users/groups..." style="padding-right: 30px;" />
        <span id="clearSearch" style="position: absolute; right: 10px; top: 8px; cursor: pointer; font-weight: bold; font-size: 16px; color: #999;">×</span>
      </div>
      <button onclick="createGroup()">Create Group</button>
      <div id="recentChats"><h4>Recent Chats</h4></div>
      <div id="userSection"><h4>All Users</h4></div>
      <div id="groupSection"><h4>All Groups</h4></div>
    </div>
    <div id="chatWindow">
      <div style="padding: 10px; background: #128C7E; color: white; display: flex; justify-content: space-between;">
        <span id="chatWith">---</span>
        <div>
          <div style="padding: 10px; background: #128C7E; color: white; display: flex; justify-content: space-between; align-items: center;">
            <button id="backBtn" onclick="closeChat()" style="font-size: 20px; background: none; border: none; color: white; cursor: pointer;">BACK</button>
            <span id="chatWith" style="flex: 1; text-align: center; font-weight: bold;"></span>
            <div style="width: 40px;"></div>
          </div>
        </div>
      </div>
      <div id="typingIndicator">Typing...</div>
      <div id="messages"></div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type message..."/>
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>
  <div id="chatTitleMenu" style="display:none; position:absolute; background:white; border:1px solid #ccc; padding:10px; border-radius:6px; z-index:99999;">
    <button onclick="leaveGroup()">Leave Group</button><br>
    <button onclick="blockUser()">Block User</button><br>
    <button onclick="alert('Coming soon: View members')">View Members</button>
  </div>
  <div id="msgMenu" class="msg-menu" style="display:none;"></div>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = sessionStorage.getItem('username');
    if (!currentUser) location.href = 'index.html';
    document.getElementById('currentUser').innerText = "Logged in as " + currentUser;

    function goToDashboard() {
      location.href = 'app.html';
    }

    const userListEl = document.getElementById('userSection');
    const groupListEl = document.getElementById('groupSection');
    const recentChatsEl = document.getElementById('recentChats');
    const chatWindow = document.getElementById('chatWindow');
    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const typingIndicator = document.getElementById('typingIndicator');
    const msgMenu = document.getElementById('msgMenu');

    let currentChat = null;
    let currentChatType = null; // 'user' or 'group'
    let selectedMsgs = new Set();
    let replyTo = null;
    let isBlocked = false;

    document.getElementById("clearSearch").onclick = () => {
      document.getElementById("searchBox").value = "";
      renderUsers();
      renderGroups();
    }

    document.getElementById("searchBox").addEventListener("input", () => {
      renderUsers();
      renderGroups();
    });

    function createGroup() {
      const groupName = prompt("Enter group name:");
      if (!groupName) return;
      const isPublic = confirm("Make group public?");
      let password = "";
      if (!isPublic) password = prompt("Enter password for private group:");
      db.ref("groups/" + groupName).set({
        admin: currentUser,
        name: groupName,
        public: isPublic,
        password: password,
        members: { [currentUser]: true }
      });
    }

    function renderUsers() {
      userListEl.innerHTML = "<h4>All Users</h4>";
      db.ref("users").once("value", snap => {
        const term = document.getElementById("searchBox").value.toLowerCase();
        Object.keys(snap.val() || {}).forEach(u => {
          if (u === currentUser) return;
          if (term && !u.toLowerCase().includes(term)) return;
          const btn = document.createElement("button");
          btn.textContent = u;
          btn.onclick = () => openChat(u, 'user');
          userListEl.appendChild(btn);
        });
      });
    }

    function renderGroups() {
      groupListEl.innerHTML = "<h4>All Groups</h4>";
      db.ref("groups").once("value", snap => {
        const term = document.getElementById("searchBox").value.toLowerCase();
        Object.entries(snap.val() || {}).forEach(([g, val]) => {
          if (term && !g.toLowerCase().includes(term)) return;
          const btn = document.createElement("button");
          btn.textContent = g;
          btn.classList.add("group");
          btn.onclick = () => openChat(g, 'group');
          groupListEl.appendChild(btn);
        });
      });
    }

    function renderRecentChats() {
      recentChatsEl.innerHTML = "<h4>Recent Chats</h4>";
      db.ref("recentChats/" + currentUser).once("value", snap => {
        Object.entries(snap.val() || {}).forEach(([key, _]) => {
          const btn = document.createElement("button");
          btn.textContent = key;
          btn.onclick = () => openChat(key, key.includes(currentUser + "_") ? 'user' : 'group');
          recentChatsEl.appendChild(btn);
        });
      });
    }

    renderUsers();
    renderGroups();
    renderRecentChats();
    function openChat(name, type) {
      currentChat = name;
      currentChatType = type;
      selectedMsgs.clear();
      replyTo = null;
      msgMenu.style.display = 'none';
      document.getElementById("chatWith").textContent = name;
      chatWindow.classList.add("active");
      chatWindow.style.display = "flex";

      if (type === "group") {
        db.ref("groups/" + name + "/members").once("value", s => {
          if (!s.hasChild(currentUser)) {
            const join = confirm("You're not a member. Join?");
            if (!join) return closeChat();
            const gref = db.ref("groups/" + name);
            gref.child("public").once("value", pubSnap => {
              if (pubSnap.val()) gref.child("members/" + currentUser).set(true);
              else {
                const pass = prompt("Enter password:");
                gref.child("password").once("value", pSnap => {
                  if (pSnap.val() === pass)
                    gref.child("members/" + currentUser).set(true);
                  else {
                    alert("Incorrect password");
                    return closeChat();
                  }
                });
              }
            });
          }
        });
      }

      const recentRef = db.ref("recentChats/" + currentUser + "/" + name);
      recentRef.set(true);

      loadMessages();
      setupTypingListener();
    }

    function closeChat() {
      currentChat = null;
      currentChatType = null;
      chatWindow.classList.remove("active");
      chatWindow.style.display = "none";
    }

    function loadMessages() {
      messagesEl.innerHTML = "";
      const path = currentChatType === "user"
        ? `chats/${[currentUser, currentChat].sort().join("_")}`
        : `groupChats/${currentChat}`;
      db.ref(path).on("value", snap => {
        messagesEl.innerHTML = "";
        const msgs = snap.val() || {};
        Object.entries(msgs).sort((a, b) => a[1].ts - b[1].ts).forEach(([id, msg]) => {
          renderMsg(id, msg);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    function renderMsg(id, msg) {
      const div = document.createElement("div");
      div.className = "msg " + (msg.from === currentUser ? "you" : "them");
      div.dataset.id = id;
      div.innerHTML = `
        <div>${msg.text}</div>
        <div class="msg-time">
          ${new Date(msg.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          <span class="msg-status">${msgStatusSymbol(msg)}</span>
        </div>
      `;
      div.oncontextmenu = (e) => {
        e.preventDefault();
        toggleMsgSelection(div);
      };
      div.addEventListener("touchstart", handleSwipeStart, { passive: true });
      div.addEventListener("touchend", handleSwipeEnd, { passive: true });
      messagesEl.appendChild(div);
    }

    function msgStatusSymbol(msg) {
      if (currentChatType === "group") {
        if ((msg.readBy || {})[currentUser]) return "✓✓✓";
        return "✓✓";
      } else {
        const both = [currentUser, currentChat].sort().join("_");
        return msg.readBy?.[currentChat] ? "✓✓✓" : "✓";
      }
    }
    let touchStartX = 0;
    function handleSwipeStart(e) {
      touchStartX = e.touches[0].clientX;
    }

    function handleSwipeEnd(e) {
      const dx = e.changedTouches[0].clientX - touchStartX;
      if (dx > 80) {
        const msgId = e.target.closest('.msg').dataset.id;
        db.ref(currentChatType === "group"
          ? `groupChats/${currentChat}/${msgId}`
          : `chats/${[currentUser, currentChat].sort().join("_")}/${msgId}`
        ).once("value", snap => {
          replyTo = { id: msgId, text: snap.val().text };
          document.getElementById("replyBox").innerText = "↪ " + snap.val().text;
          document.getElementById("replyBox").style.display = "block";
        });
      }
    }

    function sendMsg() {
      const text = msgInput.value.trim();
      if (!text) return;
      const path = currentChatType === "user"
        ? `chats/${[currentUser, currentChat].sort().join("_")}`
        : `groupChats/${currentChat}`;
      const id = db.ref(path).push().key;
      const msg = {
        from: currentUser,
        text,
        ts: Date.now(),
        ...(currentChatType === "group" ? { readBy: { [currentUser]: true } } : {})
      };
      db.ref(path + "/" + id).set(msg);
      db.ref("recentChats/" + currentUser + "/" + currentChat).set(true);
      db.ref("recentChats/" + currentChat + "/" + currentUser).set(true);
      msgInput.value = "";
      document.getElementById("replyBox").style.display = "none";
      replyTo = null;
    }

    msgInput.addEventListener("input", () => {
      const typingPath = `typing/${[currentUser, currentChat].sort().join("_")}`;
      db.ref(typingPath + "/" + currentUser).set(true);
      setTimeout(() => {
        db.ref(typingPath + "/" + currentUser).set(false);
      }, 1500);
    });

    function setupTypingListener() {
      const typingPath = `typing/${[currentUser, currentChat].sort().join("_")}`;
      db.ref(typingPath + "/" + currentChat).on("value", snap => {
        typingIndicator.style.display = snap.val() ? "block" : "none";
      });
    }

    function markRead(msgId) {
      if (currentChatType === "group") {
        db.ref(`groupChats/${currentChat}/${msgId}/readBy/${currentUser}`).set(Date.now());
      } else {
        db.ref(`chats/${[currentUser, currentChat].sort().join("_")}/${msgId}/readBy/${currentUser}`).set(Date.now());
      }
    }
    function toggleMsgSelection(div) {
      const id = div.dataset.id;
      if (selectedMsgs.has(id)) {
        selectedMsgs.delete(id);
        div.classList.remove("selected");
      } else {
        selectedMsgs.add(id);
        div.classList.add("selected");
      }
      updateMsgMenu();
    }

    function updateMsgMenu() {
      if (selectedMsgs.size === 0) {
        msgMenu.style.display = "none";
        return;
      }
      msgMenu.innerHTML = "";
      const copyBtn = document.createElement("button");
      copyBtn.innerText = "Copy";
      copyBtn.onclick = copySelected;
      msgMenu.appendChild(copyBtn);

      if (selectedMsgs.size === 1) {
        const [id] = selectedMsgs;
        const path = currentChatType === "group"
          ? `groupChats/${currentChat}/${id}`
          : `chats/${[currentUser, currentChat].sort().join("_")}/${id}`;
        db.ref(path).once("value", snap => {
          if (snap.val().from === currentUser && Date.now() - snap.val().ts < 60000) {
            const editBtn = document.createElement("button");
            editBtn.innerText = "Edit";
            editBtn.onclick = () => editMsg(id, snap.val().text);
            msgMenu.appendChild(editBtn);
          }
        });
      }

      const delBtn = document.createElement("button");
      delBtn.innerText = "Delete";
      delBtn.onclick = () => deleteSelected();
      msgMenu.appendChild(delBtn);

      const cancelBtn = document.createElement("button");
      cancelBtn.innerText = "Cancel";
      cancelBtn.onclick = () => {
        selectedMsgs.forEach(id => {
          const el = document.querySelector(`[data-id="${id}"]`);
          el?.classList.remove("selected");
        });
        selectedMsgs.clear();
        msgMenu.style.display = "none";
      };
      msgMenu.appendChild(cancelBtn);

      msgMenu.style.display = "flex";
    }

    function copySelected() {
      let text = "";
      selectedMsgs.forEach(id => {
        const el = document.querySelector(`[data-id="${id}"] div:first-child`);
        if (el) text += el.textContent + "\n";
      });
      navigator.clipboard.writeText(text);
      alert("Copied");
    }

    function editMsg(id, oldText) {
      const newText = prompt("Edit message:", oldText);
      if (!newText) return;
      const path = currentChatType === "group"
        ? `groupChats/${currentChat}/${id}`
        : `chats/${[currentUser, currentChat].sort().join("_")}/${id}`;
      db.ref(path + "/text").set(newText);
      selectedMsgs.clear();
      msgMenu.style.display = "none";
    }

    function deleteSelected() {
      const everyone = confirm("Delete for everyone?");
      selectedMsgs.forEach(id => {
        const path = currentChatType === "group"
          ? `groupChats/${currentChat}/${id}`
          : `chats/${[currentUser, currentChat].sort().join("_")}/${id}`;
        if (everyone) db.ref(path).remove();
        else db.ref(path + "/text").set("🗑️ Message deleted");
      });
      selectedMsgs.clear();
      msgMenu.style.display = "none";
    }
    function showChatOptions() {
      const isGroup = currentChatType === "group";
      chatTitle.innerHTML = currentChat + " ⏷";
      chatTitle.onclick = () => {
        const box = document.createElement("div");
        box.className = "popup";
        if (!isGroup) {
          const blockBtn = document.createElement("button");
          blockBtn.innerText = "Block User";
          blockBtn.onclick = () => {
            if (confirm("Block this user?")) {
              db.ref("users/" + currentUser + "/blocked/" + currentChat).set(true);
              alert("User blocked");
              box.remove();
            }
          };
          box.appendChild(blockBtn);

          const delBtn = document.createElement("button");
          delBtn.innerText = "Delete Chat";
          delBtn.onclick = () => {
            if (confirm("Delete all chat with this user?")) {
              const path = `chats/${[currentUser, currentChat].sort().join("_")}`;
              db.ref(path).remove();
              db.ref("recentChats/" + currentUser + "/" + currentChat).remove();
              alert("Chat deleted");
              box.remove();
            }
          };
          box.appendChild(delBtn);
        } else {
          const membersBtn = document.createElement("button");
          membersBtn.innerText = "View Members";
          membersBtn.onclick = () => viewGroupMembers(currentChat);
          box.appendChild(membersBtn);

          const leaveBtn = document.createElement("button");
          leaveBtn.innerText = "Leave Group";
          leaveBtn.onclick = () => {
            db.ref(`groups/${currentChat}/leaveRequests/${currentUser}`).set(true);
            alert("Leave request sent to admin");
            box.remove();
          };
          box.appendChild(leaveBtn);
        }

        document.body.appendChild(box);
      };
    }

    function viewGroupMembers(groupId) {
      db.ref("groups/" + groupId).once("value", snap => {
        const group = snap.val();
        const box = document.createElement("div");
        box.className = "popup";
        Object.keys(group.members || {}).forEach(member => {
          const div = document.createElement("div");
          div.innerText = member;
          if (group.admin === currentUser && member !== currentUser) {
            const makeAdminBtn = document.createElement("button");
            makeAdminBtn.innerText = "Make Admin";
            makeAdminBtn.onclick = () => {
              db.ref(`groups/${groupId}/admin`).set(member);
              alert(member + " is now admin");
              box.remove();
            };
            div.appendChild(makeAdminBtn);

            const removeBtn = document.createElement("button");
            removeBtn.innerText = "Remove";
            removeBtn.onclick = () => {
              db.ref(`groups/${groupId}/members/${member}`).remove();
              alert(member + " removed");
              box.remove();
            };
            div.appendChild(removeBtn);
          }
          box.appendChild(div);
        });

        if (group.admin === currentUser && group.leaveRequests) {
          Object.keys(group.leaveRequests).forEach(requester => {
            const reqDiv = document.createElement("div");
            reqDiv.innerText = requester + " wants to leave";
            const confirmBtn = document.createElement("button");
            confirmBtn.innerText = "Confirm";
            confirmBtn.onclick = () => {
              db.ref(`groups/${groupId}/members/${requester}`).remove();
              db.ref(`groups/${groupId}/leaveRequests/${requester}`).remove();
              alert("User removed");
              reqDiv.remove();
            };
            const cancelBtn = document.createElement("button");
            cancelBtn.innerText = "Cancel";
            cancelBtn.onclick = () => {
              db.ref(`groups/${groupId}/leaveRequests/${requester}`).remove();
              reqDiv.remove();
            };
            reqDiv.appendChild(confirmBtn);
            reqDiv.appendChild(cancelBtn);
            box.appendChild(reqDiv);
          });

          const deleteBtn = document.createElement("button");
          deleteBtn.innerText = "Delete Group";
          deleteBtn.onclick = () => {
            if (confirm("Are you sure you want to delete this group?")) {
              db.ref("groups/" + groupId).remove();
              db.ref("groupChats/" + groupId).remove();
              alert("Group deleted");
              box.remove();
            }
          };
          box.appendChild(deleteBtn);
        }

        document.body.appendChild(box);
      });
    }
    function checkBlocked() {
      db.ref("users/" + currentUser + "/blocked/" + currentChat).once("value", snap => {
        if (snap.exists()) {
          alert("You have blocked this user");
        } else {
          db.ref("users/" + currentChat + "/blocked/" + currentUser).once("value", otherSnap => {
            if (otherSnap.exists()) {
              alert("You are blocked by this user");
              msgInput.disabled = true;
              sendBtn.disabled = true;
            } else {
              msgInput.disabled = false;
              sendBtn.disabled = false;
            }
          });
        }
      });
    }
    function openGroupChat(groupId) {
      db.ref("groups/" + groupId).once("value", snap => {
        const group = snap.val();
        if (!group.members || !group.members[currentUser]) {
          if (!group.public) {
            const pass = prompt("This group is private. Enter password:");
            if (pass !== group.password) {
              alert("Incorrect password");
              return;
            }
          }
          db.ref(`groups/${groupId}/members/${currentUser}`).set(true);
        }
        currentChat = groupId;
        currentChatType = "group";
        loadMsgs(groupId, "group");
        showChatOptions();
      });
    }
    function sendNotification(toUser, msg) {
      if (Notification.permission === "granted") {
        new Notification("New message from " + currentUser, {
          body: msg,
          icon: "chat-icon.png"
        });
      }
    }

    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }
    function formatDate(ts) {
      const d = new Date(ts);
      if (isNaN(d.getTime())) return "Invalid date";
      return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
    }

    function renderDateHeader(ts) {
      const date = formatDate(ts);
      if (!lastRenderedDate || lastRenderedDate !== date) {
        const label = document.createElement("div");
        label.className = "date-label";
        label.innerText = date;
        messagesDiv.appendChild(label);
        lastRenderedDate = date;
      }
    }
</script>
</body>
</html>
