<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bravo Chat & Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #075E54;
      color: white;
      padding: 10px;
    }

    .tabs {
      display: flex;
      background: #128C7E;
    }

    .tabs button {
      flex: 1;
      padding: 12px;
      border: none;
      background: #128C7E;
      color: white;
      cursor: pointer;
    }

    .tabs button.active {
      background: #25D366;
    }

    .content {
      display: none;
      height: calc(100% - 92px);
      overflow: hidden;
    }

    .content.active {
      display: flex;
    }

    #mapContent {
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #chatContent {
      display: flex;
      width: 100%;
    }

    #userList {
      width: 30%;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      padding: 10px;
    }

    #userList input,
    #userList button {
      width: 100%;
      margin-bottom: 5px;
      padding: 8px;
      border: none;
    }

    #userList button {
      background: #f1f1f1;
      cursor: pointer;
    }

    #userList button.group {
      background: #e1f5fe;
      font-weight: bold;
    }

    #chatWindow {
      flex: 1;
      display: none;
      flex-direction: column;
      position: relative;
      background: white;
    }

    #chatHeader {
      padding: 10px;
      background: #128C7E;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }

    #chatHeader .chatTitleWrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      left: 0;
      right: 0;
      pointer-events: none;
    }

    #chatWith {
      pointer-events: auto;
      cursor: pointer;
      text-decoration: underline;
      font-weight: bold;
    }

    .callGroup {
      display: flex;
      align-items: center;
      z-index: 1;
    }

    .callGroup button {
      margin-left: 5px;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      color: white;
    }

    .voice {
      background: #075E54;
    }

    .video {
      background: #128C7E;
    }

    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5ddd5;
    }

    .msg {
      padding: 8px;
      margin: 5px;
      border-radius: 7px;
      max-width: 70%;
    }

    .you {
      background: #dcf8c6;
      align-self: flex-end;
    }

    .them {
      background: white;
      align-self: flex-start;
    }

    #sendBar {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
    }

    #sendBar input {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }

    #sendBar button {
      padding: 8px 12px;
      background: #25D366;
      border: none;
      color: white;
      margin-left: 5px;
      border-radius: 20px;
    }

    #backBtn {
      display: none;
      background: white;
      color: #128C7E;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      margin-right: 10px;
    }

    @media (max-width: 600px) {
      #userList {
        width: 100%;
      }

      #chatWindow {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        flex-direction: column;
      }

      #backBtn {
        display: inline-block;
      }
    }
  </style>
</head>
<body>

<header>
  <div id="currentUser"></div>
  <button onclick="logout()">Logout</button>
</header>

<div class="tabs">
  <button class="active" onclick="openTab('mapContent')">Map</button>
  <button onclick="openTab('chatContent')">Chats</button>
</div>

<div id="mapContent" class="content active">
  <div id="map"></div>
</div>

<div id="chatContent" class="content">
  <div id="userList">
    <input id="searchBox" placeholder="Search users/groups..." />
    <button onclick="createGroup()">Create Group</button>
    <div id="users"></div>
  </div>

  <div id="chatWindow">
    <div id="chatHeader">
      <button id="backBtn" onclick="closeChat()">â¬…</button>
      <div class="chatTitleWrapper">
        <span id="chatWith" onclick="openChatOptions()">---</span>
      </div>
      <div class="callGroup">
        <button class="voice" onclick="startCall('voice')">ðŸ“ž</button>
        <button class="video" onclick="startCall('video')">ðŸŽ¥</button>
      </div>
    </div>

    <div id="messages"></div>

    <div id="sendBar">
      <input id="msgInput" placeholder="Type message..." oninput="notifyTyping()" />
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  const config = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };
  firebase.initializeApp(config);
  const db = firebase.database();

  const user = localStorage.getItem('username') || prompt('Enter username');
  localStorage.setItem('username', user);
  document.getElementById('currentUser').textContent = user;
  db.ref('users/' + user).set(true);

  // Map setup
  const map = L.map('map').setView([1.29, 36.82], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  const markers = {};

  setInterval(() => {
    navigator.geolocation.getCurrentPosition(pos => {
      db.ref('locations/' + user).set({ lat: pos.coords.latitude, lng: pos.coords.longitude });
    });
  }, 5000);

  db.ref('locations').on('value', snap => {
    const locs = snap.val() || {};
    for (const [u, loc] of Object.entries(locs)) {
      if (markers[u]) markers[u].setLatLng([loc.lat, loc.lng]);
      else markers[u] = L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(u);
    }
  });

  // Chat system
  const userList = document.getElementById('users');
  const searchBox = document.getElementById('searchBox');
  let allUsers = {}, allGroups = {}, currentChat = '', convoRef = null;

  db.ref('users').on('value', snap => {
    allUsers = snap.val() || {};
    refreshUserList();
  });

  db.ref('groups').on('value', snap => {
    allGroups = snap.val() || {};
    refreshUserList();
  });

  searchBox.addEventListener('input', refreshUserList);

  function refreshUserList() {
    let html = `<h3 style="margin:10px 0 5px;">Users</h3>`;
    Object.keys(allUsers).forEach(u => {
      if (u !== user && u.toLowerCase().includes(searchBox.value.toLowerCase())) {
        html += `<button onclick="openChat('${u}')">${u}</button>`;
      }
    });

    html += `<h3 style="margin:15px 0 5px;">Groups</h3>`;
    Object.entries(allGroups).forEach(([id, data]) => {
      if (!data.name) return;
      const label = data.public ? `# ${data.name}` : `ðŸ”’ ${data.name}`;
      html += `<button class="group" onclick="attemptJoinGroup('${id}', '${data.name}')">${label}</button>`;
    });

    userList.innerHTML = html;
  }

  function createGroup() {
    let name = prompt("Enter group name (no special characters):");
    if (!name) return;
    name = name.trim().replace(/[^a-zA-Z0-9 _-]/g, '').replace(/\s+/g, '_');

    let type = prompt("Group Type: Type 'public' or 'private'").toLowerCase();
    if (type !== 'public' && type !== 'private') {
      alert("Invalid group type. Please type 'public' or 'private'.");
      return;
    }

    const isPublic = type === 'public';
    let password = null;

    if (!isPublic) {
      password = prompt("Enter a password for this private group:");
      if (!password) return alert("Private group must have a password.");
    }

    const groupData = {
      name,
      admin: user,
      public: isPublic,
      password: isPublic ? null : password,
      members: { [user]: true }
    };

    const newRef = db.ref('groups').push();
    newRef.set(groupData, err => {
      if (!err) {
        db.ref('groupChats/' + newRef.key).push({
          from: 'System',
          text: `${user} created this ${type} group.`,
          ts: Date.now()
        });
        alert(`${type.charAt(0).toUpperCase() + type.slice(1)} group created!`);
      }
    });
  }

  function attemptJoinGroup(groupId, groupName) {
    db.ref('groups/' + groupId).once('value').then(snap => {
      const group = snap.val();
      if (!group) return;

      if (group.members && group.members[user]) {
        openGroup(groupId, groupName);
      } else if (!group.public) {
        const pwd = prompt("This is a private group. Enter password:");
        if (pwd === group.password) {
          const confirmJoin = confirm("Correct password. Do you want to join this group?");
          if (confirmJoin) {
            db.ref('groups/' + groupId + '/members/' + user).set(true);
            openGroup(groupId, groupName);
          }
        } else {
          alert("Wrong password.");
        }
      } else {
        const confirmJoin = confirm("Do you want to join this public group?");
        if (confirmJoin) {
          db.ref('groups/' + groupId + '/members/' + user).set(true);
          openGroup(groupId, groupName);
        }
      }
    });
  }
</script>
<script>
function openChat(other) {
  currentChat = other;
  document.getElementById('chatWith').innerHTML = `<span onclick="openChatOptions()" style="cursor:pointer; text-decoration:underline;">${other}</span>`;
  document.getElementById('chatWindow').style.display = 'flex';
  document.getElementById('messages').innerHTML = '';

  if (convoRef) convoRef.off();
  const convo = [user, other].sort().join('_');
  convoRef = db.ref('privateChats/' + convo);

  convoRef.on('child_added', snap => {
    renderMessage(snap.key, snap.val());
  });

  convoRef.on('child_changed', snap => {
    updateMessage(snap.key, snap.val());
  });
}
  function openGroup(groupId, displayName) {
  currentChat = 'group__' + groupId;
  document.getElementById('chatWith').innerHTML = `<span onclick="openChatOptions()" style="cursor:pointer; text-decoration:underline;">#${displayName}</span>`;
  document.getElementById('chatWindow').style.display = 'flex';
  document.getElementById('messages').innerHTML = '';

  if (convoRef) convoRef.off();
  convoRef = db.ref('groupChats/' + groupId);

  convoRef.on('child_added', snap => {
    renderMessage(snap.key, snap.val());
  });

  convoRef.on('child_changed', snap => {
    updateMessage(snap.key, snap.val());
  });
  }
  function confirmDeleteMessage(msgKey, msgObj) {
  const now = Date.now();
  const ageInMs = now - msgObj.ts;
  const oneMinute = 60 * 1000;

  const isPrivate = !currentChat.startsWith('group__');
  const isSender = msgObj.from === user;

  // Option 1: Too late
  if (ageInMs > oneMinute && isSender) {
    const confirmSelf = confirm("Message is older than 1 minute. Delete for you only?");
    if (confirmSelf) {
      // Just remove locally
      event.target.remove();
    }
    return;
  }

  // Option prompt
  let options = "Delete this message:\n1. For Me";
  if (isSender && ageInMs <= oneMinute) options += "\n2. For Everyone";

  const choice = prompt(options);
  if (!choice) return;

  if (choice === '1') {
    // Just delete visually
    event.target.remove();
  } else if (choice === '2' && isSender && ageInMs <= oneMinute) {
    let ref;
    if (isPrivate) {
      const convo = [user, currentChat].sort().join('_');
      ref = db.ref('privateChats/' + convo + '/' + msgKey);
    } else {
      const groupId = currentChat.split('__')[1];
      ref = db.ref('groupChats/' + groupId + '/' + msgKey);
    }

    ref.set({
      deleted: true,
      from: msgObj.from,
      ts: msgObj.ts
    });
  }
  }
  function renderMessage(key, m) {
  const div = document.createElement('div');
  div.setAttribute('data-key', key);

  if (m.deleted) {
    div.className = 'msg';
    div.style.fontStyle = 'italic';
    div.textContent = "Message deleted";
  } else {
    div.className = 'msg ' + (m.from === user ? 'you' : 'them');
    div.textContent = m.from === user && !currentChat.startsWith('group__') ? m.text : m.from + ": " + m.text;

    div.oncontextmenu = function (e) {
      e.preventDefault();
      confirmDeleteMessage(key, m);
    };
  }

  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = 1e9;
}

function updateMessage(key, m) {
  const msgElement = document.querySelector(`[data-key="${key}"]`);
  if (!msgElement) return;

  if (m.deleted) {
    msgElement.className = 'msg';
    msgElement.style.fontStyle = 'italic';
    msgElement.textContent = "Message deleted";
  }
}
  function sendMsg() {
    const txt = document.getElementById('msgInput').value.trim();
    if (!txt || !currentChat) return;
    const msg = { from: user, text: txt, ts: Date.now() };
    if (currentChat.startsWith('group__')) {
      const g = currentChat.split('__')[1];
      db.ref('groupChats/' + g).push(msg);
    } else {
      const convo = [user, currentChat].sort().join('_');
      db.ref('privateChats/' + convo).push(msg);
    }
    document.getElementById('msgInput').value = '';
  }

  function startCall(type) {
    if (!currentChat || currentChat.startsWith('group__')) {
      return alert('Open a private chat.');
    }
    const room = `https://YOUR_DAILY_DOMAIN.daily.co/${[user, currentChat].sort().join('-')}`;
    db.ref('calls/' + currentChat + '/incoming').set({ from: user, type, room });
    window.open(room, '_blank');
  }

  db.ref('calls/' + user + '/incoming').on('value', snap => {
    const c = snap.val();
    if (c) {
      db.ref('calls/' + user + '/incoming').remove();
      const ok = confirm(`${c.from} (${c.type}) call. Accept?`);
      if (ok) window.open(c.room, '_blank');
    }
  });

  function closeChat() {
    document.getElementById('chatWindow').style.display = 'none';
  }

  function logout() {
    localStorage.removeItem('username');
    location.href = 'index.html';
  }

  function openTab(id) {
  // Highlight the correct tab button
  document.querySelectorAll('.tabs button').forEach(b => {
    const targetId = b.textContent.trim().toLowerCase() + 'Content';
    b.classList.toggle('active', targetId === id);
  });

  // Show only the selected content section
  document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  // Hide chat window when switching to Chats tab
  if (id === 'chatContent') {
    document.getElementById('chatWindow').style.display = 'none';
  }
  }
  function openChatOptions() {
  if (!currentChat) return;

  const isGroup = currentChat.startsWith('group__');
  const name = document.getElementById('chatWith').textContent;

  let html = '';

  if (isGroup) {
    html += `Group: ${name}\n\n`;
    html += `1. View Members\n2. Leave Group\n3. Delete Chat\n\nChoose option (1-3):`;
  } else {
    html += `User: ${name}\n\n`;
    html += `1. Block User\n2. Delete Chat\n\nChoose option (1-2):`;
  }

  const option = prompt(html);
  if (!option) return;

  if (!isGroup) {
    if (option === '1') {
      alert(`${name} has been blocked (locally).`);
      // Add to localStorage blocked list if needed
    } else if (option === '2') {
      const convo = [user, currentChat].sort().join('_');
      db.ref('privateChats/' + convo).remove();
      closeChat();
      alert("Chat deleted (for you only).");
    }
  } else {
    const groupId = currentChat.split('__')[1];
    if (option === '1') {
      db.ref('groups/' + groupId + '/members').once('value').then(snap => {
        const members = Object.keys(snap.val() || {}).join(', ');
        alert("Group Members:\n" + members);
      });
    } else if (option === '2') {
      db.ref('groups/' + groupId + '/members/' + user).remove();
      closeChat();
      alert("You have left the group.");
    } else if (option === '3') {
      db.ref('groupChats/' + groupId).once('value').then(snap => {
        // optional: delete from your screen only (or hide locally)
        closeChat();
        alert("Group chat deleted (for you only).");
      });
    }
  }
  }
</script>
</body>
</html>
