<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Realtime Location Sharing App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY_HERE"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
      padding: 20px;
      margin: 0;
    }
    h2 {
      margin-top: 0;
    }
    #map {
      height: 400px;
      width: 100%;
      margin-top: 10px;
      display: none;
      border: 2px solid #333;
    }
    #messages {
      background: #1e1e1e;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      margin: 20px 0;
      border: 1px solid #444;
    }
    input, button {
      padding: 10px;
      width: 100%;
      margin: 5px 0;
      box-sizing: border-box;
    }
    button {
      background-color: #2c7;
      border: none;
      color: white;
      cursor: pointer;
    }
    button#toggleMapBtn {
      background-color: #2196F3;
    }
  </style>
</head>
<body>

  <h2>Welcome, <span id="currentUser">...</span></h2>
  <button id="toggleMapBtn" onclick="toggleMap()">üìç Show Map</button>
  <div id="map"></div>

  <h3>üí¨ Chat</h3>
  <div id="messages"></div>
  <input type="text" id="messageInput" placeholder="Type a message..." />
  <button onclick="sendMessage()">Send</button>

  <script>
    // Firebase setup
    const firebaseConfig = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Username from session
    let username = sessionStorage.getItem("username") || prompt("Enter your username:");
    sessionStorage.setItem("username", username);
    document.getElementById("currentUser").textContent = username;

    // Message logic
    function sendMessage() {
      const msg = document.getElementById("messageInput").value.trim();
      if (msg) {
        db.ref("messages").push({
          username,
          message: msg,
          time: new Date().toLocaleTimeString()
        });
        document.getElementById("messageInput").value = "";
      }
    }

    db.ref("messages").on("child_added", snap => {
      const m = snap.val();
      const div = document.createElement("div");
      div.innerHTML = `<b>${m.username}</b>: ${m.message} <small>(${m.time})</small>`;
      document.getElementById("messages").appendChild(div);
    });

    // Auto location sharing every 10 seconds
    function updateLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          db.ref("locations/" + username).set({
            username,
            latitude,
            longitude,
            time: new Date().toLocaleTimeString()
          });
        });
      }
    }
    setInterval(updateLocation, 10000); // Every 10 seconds
    updateLocation(); // First call

    // Map toggle
    let mapVisible = false;
    function toggleMap() {
      mapVisible = !mapVisible;
      document.getElementById("map").style.display = mapVisible ? "block" : "none";
      document.getElementById("toggleMapBtn").textContent = mapVisible ? "üìç Hide Map" : "üìç Show Map";
    }

    // Show all users' locations on map
    let map, markers = {};
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 0, lng: 0 },
        zoom: 2,
        styles: [{ elementType: "geometry", stylers: [{ color: "#1d2c4d" }] }]
      });

      db.ref("locations").on("value", snap => {
        const all = snap.val();
        for (const user in all) {
          const loc = all[user];
          const position = { lat: loc.latitude, lng: loc.longitude };
          if (markers[user]) {
            markers[user].setPosition(position);
            markers[user].setTitle(`${loc.username} (${loc.time})`);
          } else {
            markers[user] = new google.maps.Marker({
              position,
              map,
              title: `${loc.username} (${loc.time})`,
              label: loc.username.charAt(0).toUpperCase()
            });
          }
        }
      });
    }

    window.initMap = initMap;
    window.onload = () => {
      if (mapVisible) initMap();
    };
  </script>

  <!-- Load Google Maps last -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY_HERE&callback=initMap">
  </script>
</body>
</html>
