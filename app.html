<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bravo Chat & Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; }
    header { display:flex; justify-content:space-between; align-items:center; background:#075E54; color:white; padding:10px;}
    .tabs { display:flex; background:#128C7E; }
    .tabs button { flex:1; padding:12px; border:none; background:#128C7E; color:white; cursor:pointer;}
    .tabs button.active { background:#25D366;}
    .content { display:none; height:calc(100% - 92px); overflow:hidden; }
    .content.active { display:flex; }
    #mapContent { position:relative; }
    #map { width:100%; height:100%; }

    /* Chat layout */
    #chatContent { display:flex; width:100%; }
    #userList { width:30%; border-right:1px solid #ddd; overflow-y:auto; padding:10px;}
    #userList button { width:100%; margin-bottom:5px; padding:8px; text-align:left; cursor:pointer; border:none; background:#f1f1f1;}
    #chatWindow { flex:1; display:none; flex-direction:column; }
    #chatHeader { padding:10px; background:#128C7E; color:white; display:flex; align-items:center; justify-content:space-between;}
    #messages { flex:1; padding:10px; overflow-y:auto; background:#e5ddd5;}
    .msg { padding:8px; margin:5px; border-radius:7px; max-width:70%; }
    .you { background:#dcf8c6; align-self:flex-end; }
    .them { background:white; align-self:flex-start; }
    #sendBar { display:flex; padding:10px; border-top:1px solid #ccc; }
    #sendBar input { flex:1; padding:8px; border-radius:20px; border:1px solid #ccc; }
    #sendBar button { padding:8px 12px; background:#25D366; border:none; color:white; margin-left:5px; border-radius:20px; }
    .callGroup button { margin-left:5px; padding:6px 10px; border:none; border-radius:5px; color:white; }
    .voice { background:#075E54; }
    .video { background:#128C7E; }

    @media(max-width:600px){
      #userList { width:40%; }
      #chatWindow { position:absolute; top:50px; left:0; width:100%; height:calc(100% - 50px); }
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser"></div>
    <button onclick="logout()">Logout</button>
  </header>

  <div class="tabs">
    <button class="active" onclick="openTab('mapContent')">Map</button>
    <button onclick="openTab('chatContent')">Chats</button>
  </div>

  <div id="mapContent" class="content active">
    <div id="map"></div>
  </div>

  <div id="chatContent" class="content">
    <div id="userList">
      <strong>Start Chat</strong>
      <div id="users"></div>
    </div>

    <div id="chatWindow">
      <div id="chatHeader">
        <span id="chatWith">---</span>
        <div class="callGroup">
          <button class="voice" onclick="startCall('voice')">Voice Call</button>
          <button class="video" onclick="startCall('video')">Video Call</button>
        </div>
      </div>

      <div id="messages"></div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type message..."/>
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Firebase Config
    const config = {
      apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "250348367998",
      appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    // Current user setup
    const user = localStorage.getItem('username') || prompt('Enter username');
    localStorage.setItem('username', user);
    document.getElementById('currentUser').textContent = user;
    db.ref('users/' + user).set(true);

    // OpenStreetMap map + location sharing
    const map = L.map('map').setView([1.29,36.82],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markers = {};

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos=>{
        db.ref('locations/' + user).set({ lat: pos.coords.latitude, lng: pos.coords.longitude });
      });
    }

    db.ref('locations').on('value', snap=>{
      const locs = snap.val() || {};
      for (const [u,loc] of Object.entries(locs)) {
        if (markers[u]) markers[u].setLatLng([loc.lat,loc.lng]);
        else markers[u] = L.marker([loc.lat,loc.lng]).addTo(map).bindPopup(u);
      }
    });

    // Chat & users
    const userList = document.getElementById('users');
    db.ref('users').on('value', snap=>{
      let html = '';
      snap.forEach(c=>{
        if (c.key !== user) {
          html += `<button onclick="openChat('${c.key}')">${c.key}</button>`;
        }
      });
      userList.innerHTML = html;
    });

    let currentChat = '';
    let convoRef = null;

    function openChat(other) {
      currentChat = other;
      document.getElementById('chatWith').textContent = other;
      document.getElementById('chatWindow').style.display = 'flex';
      document.getElementById('messages').innerHTML = '';

      const convoId = [user, other].sort().join('_');
      if (convoRef) convoRef.off();
      convoRef = db.ref('privateChats/' + convoId);

      convoRef.on('child_added', snap=>{
        const m = snap.val();
        const div = document.createElement('div');
        div.className = 'msg ' + (m.from === user ? 'you' : 'them');
        div.textContent = m.text;
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = 1e9;
      });
    }

    function sendMsg(){
      const txt = document.getElementById('msgInput').value.trim();
      if (!txt || !currentChat) return;

      const convoId = [user, currentChat].sort().join('_');
      db.ref('privateChats/' + convoId).push({from:user, text:txt, ts:Date.now()});
      document.getElementById('msgInput').value = '';
    }

    // Call simulation with Firebase notifications
    db.ref('calls/' + user + '/incoming').on('value', snap=>{
      const call = snap.val();
      if (call) {
        const accept = confirm(`${call.from} calls you (${call.type}). Accept?`);
        db.ref('calls/' + user + '/incoming').remove();
        alert(accept ? 'Call connected.' : 'Call declined.');
      }
    });

    function startCall(type){
      if (!currentChat) return alert('Open a chat first.');
      db.ref('calls/' + currentChat + '/incoming').set({ from: user, type });
      alert('Calling ' + currentChat + '...');
    }

    function logout(){
      localStorage.removeItem('username');
      window.location.href = 'index.html';
    }

    function openTab(id){
      document.querySelectorAll('.tabs button').forEach(btn=>{
        btn.classList.toggle('active', btn.textContent + 'Content' === id);
      });
      document.querySelectorAll('.content').forEach(el=>el.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'chatContent') document.getElementById('chatWindow').style.display = 'none';
    }
  </script>
</body>
</html>
