<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bravo Chat & Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    /* [Same styles as before] */
  </style>
</head>
<body>

<header>
  <div id="currentUser"></div>
  <button onclick="logout()">Logout</button>
</header>

<div class="tabs">
  <button class="active" onclick="openTab('mapContent')">Map</button>
  <button onclick="openTab('chatContent')">Chats</button>
</div>

<div id="mapContent" class="content active"><div id="map"></div></div>

<div id="chatContent" class="content">
  <div id="sidebar"> …[Same sidebar UI]… </div>

  <div id="chatWindow">
    <div id="chatHeader">
      <span id="chatWith" onclick="viewGroupMembers()" style="cursor:pointer;"></span>
      <div>
        <button onclick="initiateCall('voice')">Voice</button>
        <button onclick="initiateCall('video')">Video</button>
      </div>
    </div>
    <div id="messages"></div>
    <div id="sendBar"> …[Same send UI]… </div>
  </div>
</div>

<div id="groupDialog">…</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const config = { /* … */ };
firebase.initializeApp(config);
const db = firebase.database();

const user = localStorage.getItem('username');
document.getElementById('currentUser').textContent = user;
db.ref('users/' + user).set(true);

let allUsers = [], allGroups = [], activeChats = [];
let currentChat = null, currentIsGroup = false;

function refreshAll() {
  db.ref('users').once('value', us => {
    allUsers = Object.keys(us.val() || {}).filter(u => u !== user);
    db.ref('groups').once('value', gs => {
      allGroups = [];
      gs.forEach(c => allGroups.push({ id: c.key, ...c.val() }));
      renderAllList();
    });
  });
}

// call start chat, renderAllList, filters, etc. [unchanged]

// Subscription to activeChats
db.ref('activeChats/' + user).on('value', s => {
  activeChats = s.val() ? Object.keys(s.val()) : [];
  renderActive();
});

// Opening a chat
function openChat(id, isGroup) {
  currentChat = id;
  currentIsGroup = isGroup;
  document.getElementById('chatWindow').style.display = 'flex';
  const header = document.getElementById('chatWith');
  header.textContent = isGroup
    ? (allGroups.find(g => g.id === id)?.name || id)
    : id;
  header.style.cursor = isGroup ? 'pointer' : 'default';
  
  listenMessages();
  db.ref(`activeChats/${user}/${id}`).set(true);
}

function listenMessages() {
  const path = currentIsGroup
    ? `groupChats/${currentChat}`
    : `privateChats/${[user, currentChat].sort().join('_')}`;
  
  db.ref(path).off();
  db.ref(path).on('child_added', snap => {
    const msg = snap.val();
    // Only show messages sent by this chat or by you to ensure isolation
    appendMessage(msg, msg.from === user || (!currentIsGroup && [user, currentChat].includes(msg.from)));
  });
}

function appendMessage(m, toDisplay) {
  if (!toDisplay) return;
  const div = document.createElement('div');
  div.className = 'msg ' + (m.from === user ? 'you' : 'them');
  div.innerHTML = (currentIsGroup ? `<div class="senderSmall">${m.from}</div>` : '') + m.text;
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = 1e9;
}

// Sending message [unchanged]

// Simulated call feature
function initiateCall(type) {
  if (!currentChat) return alert('Open a chat to call.');
  const callRef = db.ref('calls').push();
  callRef.set({
    from: user,
    to: currentChat,
    isGroup: currentIsGroup,
    type: type,
    ts: Date.now()
  });
  alert(`Calling ${currentChat} (${type})…`);
}

// Listening incoming calls
db.ref('calls').on('child_added', snap => {
  const c = snap.val();
  if (c.to === user) {
    if (confirm(`${c.from} is calling you (${c.type}). Accept?`)) {
      alert('Starting call…');
    } else {
      alert('Call declined.');
    }
    snap.ref.remove();
  }
});

// Group creation and members list [unchanged]

// Tabs and logout [unchanged]

refreshAll();

// Map integration (unchanged)
</script>
</body>
</html>
