<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bravo App</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; }
    header { display:flex; justify-content:space-between; align-items:center; background:#222; color:white; padding:10px; }
    .tabs { display:flex; background:#333; }
    .tabs button { flex:1; padding:12px; border:none; background:#333; color:white; cursor:pointer; }
    .tabs button.active { background:#555'; }
    .tabContent { display:none; height:calc(100% - 92px); overflow:auto; }
    .tabContent.active { display:block; }
    #map { width:100%; height:100%; }
    @media (max-width:600px) { .tabs { flex-direction:column; } }
  </style>
</head>
<body>

<header>
  <div id="currentUser">User123</div>
  <button onclick="logout()">Logout</button>
</header>

<div class="tabs">
  <button class="active" onclick="openTab('mapTab')">Map</button>
  <button onclick="openTab('chatTab')">Chats</button>
</div>

<div id="mapTab" class="tabContent active">
  <div id="map"></div>
</div>

<div id="chatTab" class="tabContent">
  <!-- Chat UI, omitted for brevity -->
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // --- Firebase setup ---
  const firebaseConfig = {
    apiKey: "...", authDomain: "...",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "...", storageBucket: "...",
    messagingSenderId: "...", appId: "..."
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const username = localStorage.getItem('username') || prompt('Enter your username');
  document.getElementById('currentUser').textContent = username;

  // --- Initialize map ---
  const map = L.map('map').setView([1.29,36.82],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

  const markers = {};

  // --- Share own location ---
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      db.ref("locations/" + username).set({ lat: latitude, lng: longitude });
    });
  }

  // --- Listen for all user locations ---
  db.ref("locations").on("value", snapshot => {
    const locs = snapshot.val() || {};
    Object.keys(locs).forEach(userKey => {
      const { lat, lng } = locs[userKey];
      if (markers[userKey]) {
        markers[userKey].setLatLng([lat, lng]);
      } else {
        markers[userKey] = L.marker([lat, lng]).addTo(map).bindPopup(userKey);
      }
    });
  });

  // --- Load users list for chat (only usernames) ---
  db.ref("users").on("value", snap => {
    const users = snap.val() || {};
    console.log("Loaded users:", Object.keys(users)); // Debug
    // You can build a user list here...
  });

  function openTab(tabId) {
    document.querySelectorAll('.tabContent').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.classList.toggle('active', btn.textContent.replace(/s$/, '') === tabId.replace('Tab',''));
    });
  }

  function logout(){
    localStorage.removeItem('username');
    window.location.href = 'index.html';
  }
</script>
</body>
</html>
