<!DOCTYPE html>
<html>
<head>
  <title>Live Location, Chat & Calls</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; }
    #map { position:absolute; top:0; bottom:0; left:0; right:33%; }
    .sidebar {
      position:absolute; top:0; bottom:0; right:0; width:33%;
      display:flex; flex-direction:column; background:#111; color:white;
    }
    .header {
      background:#222; padding:10px; text-align:center; position:relative;
    }
    .header button {
      position:absolute; right:10px; top:10px;
      background:red; border:none; padding:6px 10px; color:white; cursor:pointer;
      border-radius:4px;
    }
    .tabs { display:flex; }
    .tabs button {
      flex:1; padding:10px; border:none; background:#333; color:white; cursor:pointer;
    }
    .tabs button.active { background:green; }
    .content {
      flex:1; overflow:auto; padding:10px;
    }
    .input-area {
      padding:10px; background:#222; display:flex; flex-direction:column;
    }
    .input-area input, .input-area textarea {
      border:none; border-radius:4px; padding:8px; margin-bottom:8px;
    }
    .input-area button {
      background:green; border:none; padding:10px; color:white; cursor:pointer;
      border-radius:4px;
    }
    .message { margin-bottom:6px; }
    .message span { color:#0f0; }
    #videoSection { display:none; padding:10px; background:#111; flex:1;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
    }
    video { width:48%; margin:1%; background:#000; }
    #videoControls { margin-top:10px; }
    #videoControls input {
      padding:6px; width:200px; margin-right:8px; border:none; border-radius:4px;
    }
    #videoControls button {
      padding:8px 12px; margin-right:8px; border:none; border-radius:4px; cursor:pointer;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="sidebar">
  <div class="header">
    üìç Chat & Calls
    <button onclick="logout()">Logout</button>
  </div>
  <div class="tabs">
    <button class="active" onclick="switchTab('public')">Public Chat</button>
    <button onclick="switchTab('private')">Private Msg</button>
    <button onclick="switchTab('video')">Audio/Video Call</button>
  </div>
  <div class="content" id="chatContent">
    <div id="chatMessages"></div>
  </div>
  <div class="input-area" id="chatInput">
    <div id="receiverArea" style="display:none;">
      <input type="text" id="receiver" placeholder="Receiver Username" />
    </div>
    <textarea id="messageInput" placeholder="Type a message..."></textarea>
    <button onclick="sendMessage()">Send</button>
  </div>
  <div id="videoSection">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <div id="videoControls">
      <input type="text" id="callIdInput" placeholder="Call ID (e.g., user_12345)" />
      <button onclick="startCall()">Start Call</button>
      <button onclick="answerCall()">Answer Call</button>
      <button onclick="hangUp()">Hang Up</button>
    </div>
  </div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Username
  const username = localStorage.getItem("username") || prompt("Enter username");
  localStorage.setItem("username", username);

  // Map setup
  const map = L.map('map').setView([0.02,37.91],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
  const markers = {};

  function shareLocation(){
    if(!navigator.geolocation){ alert("Geolocation not supported."); return; }
    navigator.geolocation.watchPosition(p=>{
      db.ref("locations/"+username).set({lat:p.coords.latitude, lng:p.coords.longitude});
    });
  }
  shareLocation();

  db.ref("locations").on("value", snap => {
    const data = snap.val();
    for(const user in data){
      const {lat, lng} = data[user];
      if(markers[user]){
        markers[user].setLatLng([lat,lng]);
      } else {
        markers[user] = L.marker([lat,lng]).addTo(map).bindPopup(user);
      }
    }
  });

  // Chat functionality
  let currentTab="public";
  switchTab('public');

  function switchTab(tab){
    currentTab=tab;
    document.querySelectorAll('.tabs button').forEach((b,i)=>b.classList.toggle('active', ['public','private','video'][i]===tab));
    document.getElementById('chatContent').style.display = (tab==='video'? 'none' : 'block');
    document.getElementById('chatInput').style.display = (tab==='video'? 'none' : 'flex');
    document.getElementById('videoSection').style.display = (tab==='video'? 'flex' : 'none');
    document.getElementById('receiverArea').style.display = (tab==='private'? 'block' : 'none');
    loadMessages();
  }

  function loadMessages(){
    document.getElementById('chatMessages').innerHTML='';
    const ref = currentTab==='public'? db.ref('chat') : db.ref('private');
    ref.off();
    ref.on('child_added', snap=>{
      const msg = snap.val();
      if(currentTab==='public' || msg.from===username || msg.to===username){
        const div=document.createElement('div'); div.classList.add('message');
        const sender = currentTab==='private'? `${msg.from}‚Üí${msg.to}` : msg.name;
        div.innerHTML=`<span>${sender}:</span> ${msg.text}`;
        document.getElementById('chatMessages').appendChild(div);
        document.getElementById('chatMessages').scrollTop = 1e9;
      }
    });
  }

  function sendMessage(){
    const txt=document.getElementById('messageInput').value.trim(); if(!txt) return;
    if(currentTab==='public'){
      db.ref('chat').push({name:username,text:txt});
    } else {
      const to=document.getElementById('receiver').value.trim();
      if(!to) return alert('Enter receiver');
      db.ref('private').push({from:username,to,text:txt});
    }
    document.getElementById('messageInput').value='';
  }

  // Audio/video calling: WebRTC with Firebase signaling
  let pc, localStream, remoteStream;
  const rtcConfig = { iceServers:[{urls:"stun:stun1.l.google.com:19302"}] };

  async function setupMedia(){
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    remoteStream = new MediaStream();
    document.getElementById('localVideo').srcObject=localStream;
    document.getElementById('remoteVideo').srcObject=remoteStream;
  }

  async function startCall(){
    await setupMedia();
    pc = new RTCPeerConnection(rtcConfig);
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    pc.ontrack = e=> e.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t));

    const callId = username + "_" + Date.now();
    document.getElementById('callIdInput').value=callId;
    const cRef = db.ref('calls/'+callId);
    const offerC = cRef.child('offerCandidates');
    const answerC = cRef.child('answerCandidates');

    pc.onicecandidate = e=> e.candidate && offerC.push(e.candidate.toJSON());
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await cRef.child('offer').set(offer);

    answerC.on('child_added', snap=> pc.addIceCandidate(new RTCIceCandidate(snap.val())));
    cRef.child('answer').on('value', async snap=>{
      const ans = snap.val();
      if(ans && !pc.currentRemoteDescription) await pc.setRemoteDescription(ans);
    });

    alert(`Share this Call ID: ${callId}`);
  }

  async function answerCall(){
    const callId = document.getElementById('callIdInput').value.trim();
    if(!callId) return alert('Enter Call ID');
    await setupMedia();

    const cRef = db.ref('calls/'+callId);
    const offer = (await cRef.child('offer').once('value')).val();
    pc = new RTCPeerConnection(rtcConfig);
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    pc.ontrack = e=> e.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t));

    const answerC = cRef.child('answerCandidates');
    const offerC = cRef.child('offerCandidates');

    pc.onicecandidate = e=> e.candidate && answerC.push(e.candidate.toJSON());
    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await cRef.child('answer').set(answer);

    offerC.on('child_added', snap=> pc.addIceCandidate(new RTCIceCandidate(snap.val())));
  }

  function hangUp(){
    if(pc){ pc.close(); pc=null; }
    location.reload();
  }

  function logout(){
    localStorage.removeItem('username');
    window.location.href='index.html';
  }

</script>
</body>
</html>
