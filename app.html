<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bravo Chat & Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    /* [Same layout and styling from your current version] */
  </style>
</head>
<body>

<header>
  <div id="currentUser"></div>
  <button onclick="logout()">Logout</button>
</header>

<div class="tabs">
  <button class="active" onclick="openTab('mapContent')">Map</button>
  <button onclick="openTab('chatContent')">Chats</button>
</div>

<div id="mapContent" class="content active"><div id="map"></div></div>

<div id="chatContent" class="content">
  <div id="sidebar">
    <div class="sidebar-header">
      <button onclick="refreshAll()">Start Chat</button>
      <button onclick="openGroupDialog()">Create Group</button>
    </div>
    <input id="searchInput" placeholder="Search users/groupsâ€¦" oninput="filterAll()"/>
    <div id="allList"></div>
    <hr>
    <div><strong>Active Chats</strong></div>
    <div id="activeList"></div>
  </div>

  <div id="chatWindow">
    <div id="chatHeader">
      <span id="chatWith"></span>
      <div>
        <button onclick="startCall('video')">ðŸ“¹ Call</button>
        <button onclick="startCall('voice')">ðŸŽ§ Call</button>
      </div>
    </div>
    <div id="messages"></div>
    <div id="sendBar">
      <input id="msgInput" placeholder="Type message...">
      <button onclick="sendMsg()">Send</button>
    </div>
    <div id="rtcContainer" style="display:none;">
      <video id="localVideo" autoplay muted playsinline style="width:45%;"></video>
      <video id="remoteVideo" autoplay playsinline style="width:45%;"></video>
      <button onclick="hangup()">Hang Up</button>
    </div>
  </div>
</div>

<div id="groupDialog" style="display:none;">â€¦</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const config = { /* your Firebase config */ };
firebase.initializeApp(config);
const db = firebase.database();

let pc, localStream, remoteStream, roomRef;
const servers = { iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }] };

function startWebRTC(isCaller) {
  pc = new RTCPeerConnection(servers);
  pc.onicecandidate = e => { e.candidate && roomRef.child(isCaller ? 'offerCandidates' : 'answerCandidates').push(e.candidate.toJSON()); };
  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  navigator.mediaDevices.getUserMedia({ video:true, audio:true }).then(stream => {
    localStream = stream;
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    if (isCaller) {
      pc.createOffer().then(offer => {
        pc.setLocalDescription(offer);
        roomRef = db.ref('rooms').push({ offer: offer.toJSON() });
        setupCallListeners();
      });
    }
  });
}

function setupCallListeners() {
  roomRef.on('value', snap => {
    const data = snap.val();
    if (data.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(data.answer));
  });

  roomRef.child('offerCandidates').on('child_added', snap => pc.addIceCandidate(snap.val()));
  roomRef.child('answerCandidates').on('child_added', snap => pc.addIceCandidate(snap.val()));
}

function startCall(type) {
  const isCaller = confirm("Start a " + type + " call?");
  document.getElementById('rtcContainer').style.display = 'flex';
  startWebRTC(isCaller);
}

function hangup() {
  pc.close();
  roomRef.remove();
  rtcContainer.style.display = 'none';
}

// [Keep previous chat, group, messaging, and map code hereâ€”unchanged]
</script>
</body>
</html>
