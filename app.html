<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bravo Chat & Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; }
    header { display:flex; justify-content:space-between; align-items:center; background:#075E54; color:white; padding:10px;}
    .tabs { display:flex; background:#128C7E; }
    .tabs button { flex:1; padding:12px; border:none; background:#128C7E; color:white; cursor:pointer;}
    .tabs button.active { background:#25D366;}
    .content { display:none; height:calc(100% - 92px); overflow:hidden; }
    .content.active { display:flex; }
    #mapContent { position:relative; }
    #map { width:100%; height:100%; }

    #chatContent { display:flex; width:100%; }
    #userList { width:30%; border-right:1px solid #ddd; overflow-y:auto; padding:10px;}
    #userList button { width:100%; margin-bottom:5px; padding:8px; text-align:left; cursor:pointer; border:none; background:#f1f1f1;}
    .action-btn { width:100%; padding:8px; margin-bottom:10px; background:#075E54; color:white; border:none; cursor:pointer;}
    #chatWindow { flex:1; display:none; flex-direction:column; }
    #chatHeader { padding:10px; background:#128C7E; color:white; display:flex; align-items:center; justify-content:space-between;}
    #messages { flex:1; padding:10px; overflow-y:auto; background:#e5ddd5;}
    .msg { padding:8px; margin:5px; border-radius:7px; max-width:70%; }
    .you { background:#dcf8c6; align-self:flex-end; }
    .them { background:white; align-self:flex-start; }
    #sendBar { display:flex; padding:10px; border-top:1px solid #ccc; }
    #sendBar input { flex:1; padding:8px; border-radius:20px; border:1px solid #ccc; }
    #sendBar button { padding:8px 12px; background:#25D366; border:none; color:white; margin-left:5px; border-radius:20px; }
    .callGroup button { margin-left:5px; padding:6px 10px; border:none; border-radius:5px; color:white; }
    .voice { background:#075E54; }
    .video { background:#128C7E; }
    @media(max-width:600px){
      #userList { width:40%; }
      #chatWindow { position:absolute; top:50px; left:0; width:100%; height:calc(100% - 50px); }
    }
  </style>
</head>
<body>
  <header>
    <div id="currentUser"></div>
    <button onclick="logout()">Logout</button>
  </header>

  <div class="tabs">
    <button class="active" onclick="openTab('mapContent')">Map</button>
    <button onclick="openTab('chatContent')">Chats</button>
  </div>

  <div id="mapContent" class="content active"><div id="map"></div></div>

  <div id="chatContent" class="content">
    <div id="userList">
      <button class="action-btn" onclick="showStart()">Start Chat</button>
      <button class="action-btn" onclick="createGroup()">Create Group</button>
      <div id="users"></div>
    </div>

    <div id="chatWindow">
      <div id="chatHeader">
        <span id="chatWith">---</span>
        <div class="callGroup">
          <button class="voice" onclick="startCall('voice')">Voice Call</button>
          <button class="video" onclick="startCall('video')">Video Call</button>
        </div>
      </div>

      <div id="messages"></div>
      <div id="sendBar">
        <input id="msgInput" placeholder="Type message..."/>
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const config = {
      apiKey: "...", // your key
      authDomain: "...",
      databaseURL: "...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    const user = localStorage.getItem('username') || prompt('Enter username');
    localStorage.setItem('username', user);
    document.getElementById('currentUser').textContent = user;
    db.ref('users/' + user).set({ joined: Date.now() });

    // Map setup and tracking...
    // (same as before)

    let currentChat = '';
    let convoRef = null;

    function showStart() {
      db.ref('users').once('value', snap => {
        let html = '';
        snap.forEach(c => {
          const u = c.key;
          if (u !== user) html += `<button onclick="openChat('${u}')">${u}</button>`;
        });
        document.getElementById('users').innerHTML = html;
      });
    }

    function createGroup() {
      const name = prompt('Enter group name:');
      if (!name) return;
      const groupRef = db.ref('groups/' + name);
      groupRef.once('value', snap => {
        if (snap.exists()) return alert('Group exists.');
        groupRef.set({ admin: user, members: { [user]: true } });
        db.ref('groupChats/' + name).push({ system: true, text: `${user} created the group.` });
        alert('Group created.');
        showStart(); // include in list
      });
    }

    db.ref('groups').on('value',snap=>{
      let html = '';
      snap.forEach(c => {
        const g = c.key;
        html += `<button onclick="openGroup('${g}')"># ${g}</button>`;
      });
      document.getElementById('users').innerHTML += html;
    });

    function openGroup(group) {
      currentChat = `group__${group}`;
      document.getElementById('chatWith').textContent = '#' + group;
      document.getElementById('chatWindow').style.display = 'flex';
      document.getElementById('messages').innerHTML = '';

      if (convoRef) convoRef.off();
      convoRef = db.ref('groupChats/' + group);
      convoRef.on('child_added', snap => {
        const m = snap.val(), div = document.createElement('div');
        div.textContent = (m.from || 'System') + ': ' + m.text;
        div.className = 'msg ' + (m.from === user ? 'you' : 'them');
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = 1e9;
      });
    }

    function openChat(other) {
      // same as before
    }

    function sendMsg() {
      const txt = document.getElementById('msgInput').value.trim();
      if (!txt || !currentChat) return;
      if (currentChat.startsWith('group__')) {
        const g = currentChat.split('__')[1];
        db.ref('groupChats/' + g).push({ from: user, text: txt, ts: Date.now() });
      } else {
        const convoId = [user, currentChat].sort().join('_');
        db.ref('privateChats/' + convoId).push({ from: user, text: txt, ts: Date.now() });
      }
      document.getElementById('msgInput').value = '';
    }

    db.ref('calls/' + user + '/incoming').on('value', snap => {
      const call = snap.val();
      if (call) {
        const accept = confirm(`${call.from} calls you (${call.type}). Accept?`);
        db.ref('calls/' + user + '/incoming').remove();
        if (accept) alert('Call connected.');
      }
    });

    function startCall(type) {
      if (!currentChat) return alert('Open a chat first.');
      const to = currentChat.startsWith('group__') 
        ? prompt('Cannot call group. Open private chat.') 
        : currentChat;
      if (!to) return;
      db.ref('calls/' + to + '/incoming').set({ from: user, type });
      alert('Calling ' + to + '...');
    }

    function logout(){
      localStorage.removeItem('username');
      window.location.href = 'index.html';
    }

    function openTab(id){
      document.querySelectorAll('.tabs button').forEach(btn=>{
        btn.classList.toggle('active', btn.textContent + 'Content'===id);
      });
      document.querySelectorAll('.content').forEach(el=>el.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'chatContent') document.getElementById('chatWindow').style.display='none';
    }
  </script>
</body>
</html>
