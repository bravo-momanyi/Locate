<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WebRTC Test App</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    video { width: 300px; margin: 10px 0; background: #000; }
    input, button { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h2>WebRTC Firebase Test Call</h2>

  <div>
    <label>Your Username:</label>
    <input id="yourUsername" placeholder="e.g. alice" />
    <button onclick="setUsername()">Set</button>
  </div>

  <div id="callArea" style="display:none;">
    <p>Logged in as <strong id="meLabel"></strong></p>

    <div>
      <label>Call Username:</label>
      <input id="targetUsername" placeholder="e.g. bob" />
      <button onclick="startCall()">Call</button>
    </div>

    <div id="incomingCall" style="display:none;">
      <p><strong id="callerName"></strong> is calling you...</p>
      <button onclick="acceptCall()">Accept</button>
      <button onclick="rejectCall()">Reject</button>
    </div>

    <div>
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <button onclick="hangUp()">Hang Up</button>
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Elements
  const yourUsername = document.getElementById('yourUsername');
  const targetUsername = document.getElementById('targetUsername');
  const meLabel = document.getElementById('meLabel');
  const callArea = document.getElementById('callArea');
  const incomingCall = document.getElementById('incomingCall');
  const callerName = document.getElementById('callerName');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  let currentUser = '';
  let peerConnection;
  let localStream;
  let remoteStream = new MediaStream();
  let isCaller = false;
  let caller = '';
  const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

  function setUsername() {
    currentUser = yourUsername.value.trim();
    if (!currentUser) return alert("Enter your username");
    meLabel.textContent = currentUser;
    callArea.style.display = 'block';
    listenForCalls();
  }

  async function startCall() {
    const target = targetUsername.value.trim();
    if (!target) return alert("Enter a username to call.");
    isCaller = true;

    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;

    peerConnection = new RTCPeerConnection(servers);
    setupPeer();

    localStream.getTracks().forEach(track => {
      peerConnection.addTrack(track, localStream);
    });

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);

    await db.ref(`calls/${target}`).set({
      from: currentUser,
      offer: JSON.stringify(offer)
    });
  }

  function listenForCalls() {
    db.ref(`calls/${currentUser}`).on('value', async snap => {
      const data = snap.val();
      if (!data || data.from === currentUser) return;

      caller = data.from;
      callerName.textContent = caller;
      incomingCall.style.display = 'block';

      if (data.candidate && peerConnection) {
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(data.candidate)));
        } catch (e) {
          console.warn('ICE add error:', e);
        }
      }
    });
  }

  async function acceptCall() {
    incomingCall.style.display = 'none';
    isCaller = false;

    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;

    peerConnection = new RTCPeerConnection(servers);
    setupPeer();

    localStream.getTracks().forEach(track => {
      peerConnection.addTrack(track, localStream);
    });

    const snap = await db.ref(`calls/${currentUser}`).once('value');
    const data = snap.val();

    if (!data || !data.offer) return;

    await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.offer)));

    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);

    await db.ref(`calls/${caller}`).update({
      answer: JSON.stringify(answer)
    });

    db.ref(`calls/${currentUser}`).on('value', async snap => {
      const d = snap.val();
      if (d && d.candidate && peerConnection) {
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(d.candidate)));
        } catch (e) {
          console.warn("Error adding ICE candidate:", e);
        }
      }
    });
  }

  function rejectCall() {
    incomingCall.style.display = 'none';
    db.ref(`calls/${currentUser}`).remove();
  }

  function setupPeer() {
    remoteStream = new MediaStream();
    remoteVideo.srcObject = remoteStream;

    peerConnection.ontrack = event => {
      remoteStream.addTrack(event.track);
    };

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        const path = isCaller ? `calls/${targetUsername.value.trim()}` : `calls/${caller}`;
        db.ref(path).update({
          candidate: JSON.stringify(event.candidate)
        });
      }
    };

    peerConnection.onconnectionstatechange = () => {
      if (peerConnection.connectionState === "disconnected" || peerConnection.connectionState === "closed") {
        hangUp();
      }
    };
  }

  function hangUp() {
    if (peerConnection) peerConnection.close();
    peerConnection = null;

    db.ref(`calls/${currentUser}`).remove();
    if (isCaller) db.ref(`calls/${targetUsername.value.trim()}`).remove();

    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
    localStream?.getTracks().forEach(track => track.stop());
  }
</script>
</body>
</html>

