<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Code-based Call</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f0f0f0; }
    video { width: 300px; height: 200px; background: black; margin: 10px; }
    #call-controls { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Code-Based WebRTC Call</h1>

  <div>
    <button onclick="startCall()">Start Call</button>
    <p>Your Call Code: <strong id="callCode">--</strong></p>
  </div>

  <div>
    <input type="text" id="codeInput" placeholder="Enter Call Code">
    <button onclick="joinCall()">Join Call</button>
  </div>

  <div id="call-controls">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // WebRTC global variables
  let pc = null;
  let localStream = null;
  let remoteStream = null;
  const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const callCodeEl = document.getElementById("callCode");
  const codeInput = document.getElementById("codeInput");

  async function startCall() {
    const callCode = Math.random().toString(36).substring(2, 8);
    callCodeEl.textContent = callCode;

    setupPeer();

    const callRef = db.ref("calls/" + callCode);

    // Add local stream
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    // Offer
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    callRef.set({ offer: JSON.stringify(offer) });

    // Wait for answer
    callRef.on("value", async (snap) => {
      const data = snap.val();
      if (!pc.currentRemoteDescription && data?.answer) {
        const remoteDesc = new RTCSessionDescription(JSON.parse(data.answer));
        await pc.setRemoteDescription(remoteDesc);
      }
      if (data?.candidate) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(data.candidate)));
        } catch (e) {
          console.error("Caller ICE error:", e);
        }
      }
    });

    // Send ICE candidates
    pc.onicecandidate = event => {
      if (event.candidate) {
        callRef.update({ candidate: JSON.stringify(event.candidate) });
      }
    };
  }

  async function joinCall() {
    const callCode = codeInput.value.trim();
    if (!callCode) return alert("Enter a valid code.");

    setupPeer();
    const callRef = db.ref("calls/" + callCode);

    const data = (await callRef.get()).val();
    if (!data?.offer) return alert("Invalid call code.");

    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.offer)));

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await callRef.update({ answer: JSON.stringify(answer) });

    // Listen for ICE
    callRef.on("value", async snap => {
      const d = snap.val();
      if (d?.candidate) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(d.candidate)));
        } catch (e) {
          console.error("Joiner ICE error:", e);
        }
      }
    });

    // Send ICE
    pc.onicecandidate = event => {
      if (event.candidate) {
        callRef.update({ candidate: JSON.stringify(event.candidate) });
      }
    };
  }

  function setupPeer() {
    pc = new RTCPeerConnection(servers);
    remoteStream = new MediaStream();
    remoteVideo.srcObject = remoteStream;

    pc.ontrack = event => {
      remoteStream.addTrack(event.track);
    };
  }
</script>
</body>
</html>
