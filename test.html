<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Test Call</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <h2>Logged in as: <span id="me"></span></h2>

  <label for="targetUser">Call user:</label>
  <select id="targetUser"></select>
  <button onclick="startCall()">Call</button>

  <h3>Local Video</h3>
  <video id="localVideo" autoplay muted playsinline></video>

  <h3>Remote Video</h3>
  <video id="remoteVideo" autoplay playsinline></video>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const me = prompt("Enter your username");
  document.getElementById("me").textContent = me;
  sessionStorage.setItem("username", me);

  const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
  let pc = new RTCPeerConnection(servers);
  let localStream;
  let remoteStream = new MediaStream();
  let callRef;

  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");

  remoteVideo.srcObject = remoteStream;

  async function setupMedia() {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }

  // ICE candidates
  pc.onicecandidate = e => {
    if (e.candidate && callRef) {
      callRef.child(`${me}_ice`).push(JSON.stringify(e.candidate));
    }
  };

  // Track handling
  pc.ontrack = e => {
    remoteStream.addTrack(e.track);
  };

  // Load users
  const targetSelect = document.getElementById("targetUser");
  db.ref("users").once("value", snap => {
    snap.forEach(child => {
      const user = child.key;
      if (user !== me) {
        const opt = document.createElement("option");
        opt.value = user;
        opt.textContent = user;
        targetSelect.appendChild(opt);
      }
    });
  });

  async function startCall() {
    const target = targetSelect.value;
    const callId = `${me}_${target}`;
    callRef = db.ref("calls/" + callId);
    await setupMedia();

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    callRef.set({ offer: JSON.stringify(offer), from: me });

    // Listen for answer
    callRef.child("answer").on("value", async snap => {
      const val = snap.val();
      if (val && !pc.remoteDescription) {
        await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(val)));
      }
    });

    // Listen for ICE from callee
    callRef.child(`${target}_ice`).on("child_added", async snap => {
      if (pc.signalingState !== "closed") {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(snap.val())));
        } catch (e) {
          console.warn("ICE add error", e);
        }
      }
    });
  }

  // Callee logic
  db.ref("calls").on("child_added", async snap => {
    const data = snap.val();
    const id = snap.key;
    if (!data || data.from === me || !data.offer) return;

    const caller = data.from;
    if (!confirm(`${caller} is calling you. Accept?`)) return;

    callRef = db.ref("calls/" + id);
    await setupMedia();
    await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.offer)));

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await callRef.child("answer").set(JSON.stringify(answer));

    // Receive ICE from caller
    callRef.child(`${caller}_ice`).on("child_added", async snap => {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(snap.val())));
      } catch (e) {
        console.warn("ICE Candidate Error", e);
      }
    });

    // Send your ICE
    callRef.child(`${me}_ice`).onDisconnect().remove();
  });
</script>
</body>
</html>
