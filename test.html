<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Firebase Call Test</title>
  <style>
    video { width: 45%; margin: 10px; background: black; }
    #users { margin-bottom: 10px; }
    #incomingCallPopup {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: white; border: 1px solid black; padding: 10px;
      display: none; z-index: 1000;
    }
  </style>
</head>
<body>
  <h2>WebRTC Firebase Call Test</h2>
  <div id="users">
    Your username: <select id="currentUser"></select><br>
    Call user: <select id="targetUser"></select>
    <button id="callBtn">Call</button>
  </div>

  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>

  <div id="incomingCallPopup">
    <p id="incomingText"></p>
    <button id="acceptBtn">Accept</button>
    <button id="rejectBtn">Reject</button>
    <button id="minimizeBtn">Cancel (Minimize)</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqU-vQJwV3DNLK9a3TiTx0MDxEBrvjoXk",
      authDomain: "locater-42fb4.firebaseapp.com",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "156329809222",
      appId: "1:156329809222:web:3a7e2575e9df9c5dc795ef"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    const currentUser = document.getElementById("currentUser");
    const targetUser = document.getElementById("targetUser");
    const callBtn = document.getElementById("callBtn");

    const popup = document.getElementById("incomingCallPopup");
    const incomingText = document.getElementById("incomingText");
    const acceptBtn = document.getElementById("acceptBtn");
    const rejectBtn = document.getElementById("rejectBtn");
    const minimizeBtn = document.getElementById("minimizeBtn");

    let peerConnection;
    let localStream;
    let currentUsername;
    let targetUsername;

    const servers = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    async function setupMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
    }

    async function initCall(isCaller, remoteUser) {
      peerConnection = new RTCPeerConnection(servers);

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      peerConnection.onicecandidate = e => {
        if (e.candidate) {
          db.ref(`calls/${remoteUser}/candidates`).push(JSON.stringify(e.candidate));
        }
      };

      peerConnection.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };

      if (isCaller) {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        db.ref(`calls/${remoteUser}`).set({
          from: currentUsername,
          offer: JSON.stringify(offer)
        });
      }
    }

    function listenForCalls() {
      db.ref(`calls/${currentUsername}`).on("value", async snapshot => {
        const data = snapshot.val();
        if (!data) return;

        if (data.offer && !peerConnection) {
          incomingText.innerText = `Incoming call from ${data.from}`;
          popup.style.display = "block";

          acceptBtn.onclick = async () => {
            popup.style.display = "none";
            await setupMedia();
            await initCall(false, data.from);

            const remoteDesc = new RTCSessionDescription(JSON.parse(data.offer));
            await peerConnection.setRemoteDescription(remoteDesc);

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            db.ref(`calls/${data.from}/answer`).set(JSON.stringify(answer));
          };

          rejectBtn.onclick = () => {
            popup.style.display = "none";
            db.ref(`calls/${currentUsername}`).remove();
          };

          minimizeBtn.onclick = () => {
            popup.style.display = "none";
          };
        }

        if (data.answer && peerConnection && !peerConnection.remoteDescription) {
          const remoteDesc = new RTCSessionDescription(JSON.parse(data.answer));
          await peerConnection.setRemoteDescription(remoteDesc);
        }

        db.ref(`calls/${currentUsername}/candidates`).on("child_added", async snapshot => {
          if (peerConnection) {
            const candidate = new RTCIceCandidate(JSON.parse(snapshot.val()));
            try {
              await peerConnection.addIceCandidate(candidate);
            } catch (err) {
              console.error("ICE add error", err);
            }
          }
        });
      });
    }

    callBtn.onclick = async () => {
      currentUsername = currentUser.value;
      targetUsername = targetUser.value;
      await setupMedia();
      await initCall(true, targetUsername);
      listenForCalls();
    };

    function populateUsers() {
      db.ref("users").once("value", snapshot => {
        const users = snapshot.val();
        for (let username in users) {
          const opt1 = new Option(username, username);
          const opt2 = new Option(username, username);
          currentUser.appendChild(opt1);
          targetUser.appendChild(opt2);
        }
      });
    }

    populateUsers();
    setTimeout(listenForCalls, 1000); // slight delay to allow dropdown selection
  </script>
</body>
</html>

