<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Call Test</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #videoContainer { display: flex; gap: 10px; margin-top: 20px; }
    video { width: 300px; height: 200px; background: black; }
    #callModal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); display: none;
      align-items: center; justify-content: center;
      z-index: 999;
    }
    #callPopup {
      background: white; padding: 20px; border-radius: 10px; text-align: center;
    }
    #callPopup button { margin: 5px; }
  </style>
</head>
<body>

<h2>WebRTC Call Test</h2>
<p>Logged in as: <strong id="currentUserLabel"></strong></p>

<label>Select user to call:</label>
<select id="userList"></select>
<br><br>
<button id="audioCallBtn">ðŸ“ž Audio Call</button>
<button id="videoCallBtn">ðŸŽ¥ Video Call</button>

<div id="callModal">
  <div id="callPopup">
    <p id="callStatus">Incoming call...</p>
    <button id="acceptBtn">Accept</button>
    <button id="rejectBtn">Reject</button>
    <button id="cancelBtn">Cancel</button>
  </div>
</div>

<div id="videoContainer">
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const currentUser = prompt("Enter your username");
  sessionStorage.setItem("username", currentUser);
  document.getElementById("currentUserLabel").textContent = currentUser;

  const userList = document.getElementById("userList");
  const audioBtn = document.getElementById("audioCallBtn");
  const videoBtn = document.getElementById("videoCallBtn");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const callModal = document.getElementById("callModal");
  const callStatus = document.getElementById("callStatus");
  const acceptBtn = document.getElementById("acceptBtn");
  const rejectBtn = document.getElementById("rejectBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
  let pc = null, stream = null, remoteStream = null;
  let target = null;
  let timeout = null;

  db.ref("users").once("value", snap => {
    snap.forEach(child => {
      const name = child.key;
      if (name !== currentUser) {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        userList.appendChild(opt);
      }
    });
  });

  audioBtn.onclick = () => startCall(false);
  videoBtn.onclick = () => startCall(true);

  async function startCall(withVideo) {
    target = userList.value;
    stream = await navigator.mediaDevices.getUserMedia({ video: withVideo, audio: true });
    localVideo.srcObject = stream;

    pc = createPeerConnection();
    stream.getTracks().forEach(t => pc.addTrack(t, stream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const callRef = db.ref(`calls/${target}`);
    await callRef.set({
      from: currentUser,
      offer: JSON.stringify(offer),
      video: withVideo,
      timestamp: Date.now()
    });

    // Timeout if unanswered
    timeout = setTimeout(() => endCall("No answer"), 60000);

    callModal.style.display = "flex";
    callStatus.textContent = "Calling...";
  }

  function createPeerConnection() {
    const peer = new RTCPeerConnection(servers);
    remoteStream = new MediaStream();
    remoteVideo.srcObject = remoteStream;

    peer.ontrack = e => remoteStream.addTrack(e.track);
    peer.onicecandidate = e => {
      if (e.candidate) {
        db.ref(`calls/${target}`).update({
          candidate: JSON.stringify(e.candidate)
        });
      }
    };
    return peer;
  }

  // Incoming call
  db.ref(`calls/${currentUser}`).on("value", async snap => {
    const data = snap.val();
    if (!data || data.from === currentUser) return;

    target = data.from;
    callModal.style.display = "flex";
    callStatus.textContent = `${target} is calling...`;

    acceptBtn.onclick = async () => {
      stream = await navigator.mediaDevices.getUserMedia({ video: data.video, audio: true });
      localVideo.srcObject = stream;

      pc = createPeerConnection();
      stream.getTracks().forEach(t => pc.addTrack(t, stream));

      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.offer)));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      db.ref(`calls/${currentUser}`).update({
        answer: JSON.stringify(answer)
      });

      callStatus.textContent = `In call with ${target}`;
    };

    rejectBtn.onclick = () => {
      db.ref(`calls/${currentUser}`).remove();
      callModal.style.display = "none";
    };

    cancelBtn.onclick = () => {
      callModal.style.display = "none"; // Hide, but don't remove
    };
  });

  // Handle answer + ICE from remote
  db.ref(`calls/${currentUser}`).on("value", async snap => {
    const data = snap.val();
    if (!data) return;

    if (data.answer && pc && !pc.remoteDescription) {
      await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.answer)));
      clearTimeout(timeout);
      callStatus.textContent = `In call with ${target}`;
    }

    if (data.candidate && pc) {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(data.candidate)));
      } catch (err) {
        console.error("ICE Error:", err);
      }
    }
  });

  function endCall(reason) {
    alert(`Call ended: ${reason}`);
    if (pc) pc.close();
    if (stream) stream.getTracks().forEach(t => t.stop());

    db.ref(`calls/${currentUser}`).remove();
    db.ref(`calls/${target}`).remove();

    callModal.style.display = "none";
    callStatus.textContent = "Call ended";
  }

  // Close peer on unload
  window.onbeforeunload = () => {
    db.ref(`calls/${currentUser}`).remove();
    if (pc) pc.close();
    if (stream) stream.getTracks().forEach(t => t.stop());
  };
</script>
</body>
</html>
