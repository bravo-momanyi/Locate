<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Firebase Calling</title>
  <meta charset="UTF-8">
  <link rel="icon" href="data:,">
  <style>
    video { width: 45%; margin: 10px; background: #000; }
    button { margin: 10px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h2>WebRTC Calling Test</h2>

  <label>My Username: <input type="text" id="me" /></label><br>
  <label>Call User: <input type="text" id="target" /></label><br>
  <button onclick="startCall()">Start Call</button>
  <div id="incomingCall" style="display:none;">
    <p>Incoming call from <span id="callerName"></span></p>
    <button onclick="acceptCall()">Accept</button>
    <button onclick="rejectCall()">Reject</button>
  </div>

  <br>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <!-- Firebase and WebRTC -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDWRJtYdL-iwP4QMrxBOtOfJ9TjH4niqXw",
      authDomain: "locater-42fb4.firebaseapp.com",
      projectId: "locater-42fb4",
      storageBucket: "locater-42fb4.appspot.com",
      messagingSenderId: "381751162509",
      appId: "1:381751162509:web:68028780a5dcfdce9f5053",
      databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let me, target, pc, localStream, remoteStream, callRef;

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    const servers = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    async function startCall() {
      me = document.getElementById("me").value;
      target = document.getElementById("target").value;
      if (!me || !target) return alert("Enter both usernames");

      resetConnection();

      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      localVideo.srcObject = localStream;

      callRef = db.ref("calls/" + target);
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await callRef.set({
        from: me,
        offer: JSON.stringify(offer)
      });

      // Listen for answer
      db.ref("calls/" + me + "/answer").on("value", async snap => {
        if (snap.exists()) {
          const answer = JSON.parse(snap.val());
          if (pc.signalingState !== "stable") {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
          }
        }
      });

      // Listen for ICE from remote
      db.ref("calls/" + me + "_ice").on("child_added", async snap => {
        if (pc.signalingState !== "closed") {
          try {
            const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
            await pc.addIceCandidate(candidate);
          } catch (e) {
            console.error("ICE add error", e);
          }
        }
      });
    }

    function resetConnection() {
      pc = new RTCPeerConnection(servers);
      remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;

      pc.onicecandidate = e => {
        if (e.candidate && callRef) {
          db.ref("calls/" + target + "_ice").push(JSON.stringify(e.candidate));
        }
      };

      pc.ontrack = e => {
        remoteStream.addTrack(e.track);
      };
    }

    // Incoming call listener
    firebase.database().ref("calls").on("child_added", async snap => {
      const callData = snap.val();
      const toUser = snap.key;

      me = document.getElementById("me").value;
      if (toUser === me && callData.offer && callData.from) {
        target = callData.from;
        document.getElementById("incomingCall").style.display = "block";
        document.getElementById("callerName").innerText = target;

        window.incomingOffer = callData.offer;
      }
    });

    async function acceptCall() {
      document.getElementById("incomingCall").style.display = "none";
      resetConnection();

      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      localVideo.srcObject = localStream;

      const offer = JSON.parse(window.incomingOffer);
      await pc.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      await db.ref("calls/" + target + "/answer").set(JSON.stringify(answer));

      db.ref("calls/" + target + "_ice").on("child_added", async snap => {
        try {
          const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
          await pc.addIceCandidate(candidate);
        } catch (e) {
          console.error("Caller ICE add error", e);
        }
      });

      pc.onicecandidate = e => {
        if (e.candidate) {
          db.ref("calls/" + me + "_ice").push(JSON.stringify(e.candidate));
        }
      };
    }

    function rejectCall() {
      document.getElementById("incomingCall").style.display = "none";
      if (me) db.ref("calls/" + me).remove();
    }
  </script>
</body>
</html>

