<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebRTC Firebase Call Test</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <h2>Logged in as: <span id="me"></span></h2>
  <select id="userList"></select>
  <button id="callBtn">Call</button>
  <button id="endBtn">End Call</button>
  <p id="status"></p>
  <video id="localVideo" autoplay muted playsinline width="160"></video>
  <video id="remoteVideo" autoplay playsinline width="320"></video>

  <script>
    // Firebase setup
    const config = {
      apiKey: "...",
      authDomain: "...",
      databaseURL: "...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    const me = prompt("Your username (must exist in users/):");
    document.getElementById("me").textContent = me;
    db.ref("users/" + me + "/online").set(true);

    // Populate user list
    const userList = document.getElementById("userList");
    db.ref("users").once("value", snap => {
      snap.forEach(c => {
        const u = c.key;
        if (u !== me) {
          const opt = document.createElement("option");
          opt.value = u;
          opt.text = u;
          userList.appendChild(opt);
        }
      });
    });

    // Variables
    let pc, localStream, candidateQueue = [], remoteDescSet = false, callRef;

    // General status logging
    const statusEl = document.getElementById("status");
    function log(msg){ statusEl.textContent = msg; console.log(msg); }

    async function startLocal() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("localVideo").srcObject = localStream;
    }

    function createPeer(toUser) {
      pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      pc.ontrack = e => document.getElementById("remoteVideo").srcObject = e.streams[0];

      pc.onicecandidate = e => {
        if (e.candidate && callRef) {
          callRef.child("candidate").push(JSON.stringify(e.candidate));
        }
      };

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    }

    async function startCall() {
      const other = userList.value;
      if (!other) return alert("Select a user to call");
      log("Calling " + other);

      await startLocal();
      createPeer(other);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      callRef = db.ref("calls/" + other);
      await callRef.set({ from: me, offer: JSON.stringify(offer), candidate: {} });

      // Listen for answer and ICE
      subscribeToSignaling(me);
    }

    async function subscribeToSignaling(username) {
      // Listen for answer
      callRef = db.ref("calls/" + username);
      callRef.on("value", async snap => {
        const data = snap.val();
        if (!data) return;

        if (data.answer && !remoteDescSet) {
          await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.answer)));
          remoteDescSet = true;
          log("Call connected");
          candidateQueue.forEach(async cand => await pc.addIceCandidate(cand));
          candidateQueue = [];
        }
      });

      // ICE candidates incoming
      callRef.child("candidate").on("child_added", async snap => {
        const cand = new RTCIceCandidate(JSON.parse(snap.val()));
        if (remoteDescSet) {
          try { await pc.addIceCandidate(cand); }
          catch(e){ log("ICE apply error: " + e.message); }
        } else candidateQueue.push(cand);
      });

      // Incoming call to current user
      db.ref("calls/" + me).on("value", async snap => {
        const d = snap.val();
        if (!d || d.from === me) return;
        log(d.from + " calling you.");

        const accept = confirm(`${d.from} is calling. Accept?`);
        if (!accept) {
          db.ref("calls/" + me).remove();
          return;
        }

        await startLocal();
        createPeer(d.from);

        await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(d.offer)));
        remoteDescSet = true;

        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        db.ref("calls/" + d.from + "/answer").set(JSON.stringify(ans));

        subscribeToSignaling(d.from);
      });
    }

    function endCall() {
      log("Call ended");
      if (pc) pc.close();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      db.ref("calls/" + me).remove();
      const other = userList.value;
      if (other) db.ref("calls/" + other).remove();
    }

    document.getElementById("callBtn").onclick = startCall;
    document.getElementById("endBtn").onclick = endCall;

    window.onbeforeunload = endCall;
    subscribeToSignaling(me);
  </script>
</body>
</html>
