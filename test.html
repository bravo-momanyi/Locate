<!DOCTYPE html>
<html>
<head>
  <title>Firebase WebRTC Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    video { width: 100%; max-width: 400px; margin: 10px 0; background: black; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<h2>Firebase WebRTC Call (Test)</h2>

<div>
  <button onclick="startCall()">Start Call</button>
  <p id="callCodeArea"></p>
</div>

<div>
  <input id="callCodeInput" placeholder="Enter Call Code" />
  <button onclick="joinCall()">Join Call</button>
</div>

<h3>Local Video</h3>
<video id="localVideo" autoplay muted playsinline></video>

<h3>Remote Video</h3>
<video id="remoteVideo" autoplay playsinline></video>

<script>
  // Firebase Config (your project)
  const firebaseConfig = {
    apiKey: "AIzaSyBfkUJS81minjxj0DFz4pzNnGzCtb5ZJss",
    authDomain: "locater-42fb4.firebaseapp.com",
    databaseURL: "https://locater-42fb4-default-rtdb.firebaseio.com",
    projectId: "locater-42fb4",
    storageBucket: "locater-42fb4.appspot.com",
    messagingSenderId: "250348367998",
    appId: "1:250348367998:web:d734b2b4c735b5684ae82f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Elements
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const callCodeArea = document.getElementById('callCodeArea');
  const callCodeInput = document.getElementById('callCodeInput');

  // WebRTC
  const pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  let localStream;
  let callId = "";

  // Handle incoming remote stream
  const remoteStream = new MediaStream();
  remoteVideo.srcObject = remoteStream;
  pc.ontrack = (event) => {
    remoteStream.addTrack(event.track);
  };

  // ICE Candidate Handling
  pc.onicecandidate = (event) => {
    if (event.candidate) {
      const candidate = event.candidate.toJSON();
      db.ref(`calls/${callId}/candidates/${isCaller ? 'caller' : 'callee'}`).push(candidate);
    }
  };

  let isCaller = false;

  // Get user media
  async function getMedia() {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    localVideo.srcObject = localStream;
  }

  // Start Call
  async function startCall() {
    isCaller = true;
    await getMedia();

    const callRef = db.ref("calls").push();
    callId = callRef.key;
    callCodeArea.textContent = "Call Code: " + callId;

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    await callRef.set({
      offer: JSON.stringify(offer)
    });

    // Listen for answer
    callRef.on("value", async snap => {
      const data = snap.val();
      if (!pc.currentRemoteDescription && data?.answer) {
        const answerDesc = new RTCSessionDescription(JSON.parse(data.answer));
        await pc.setRemoteDescription(answerDesc);
      }
    });

    // Listen for callee ICE
    db.ref(`calls/${callId}/candidates/callee`).on("child_added", async snap => {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(snap.val()));
      } catch (e) {
        console.error("ICE error (callee):", e);
      }
    });
  }

  // Join Call
  async function joinCall() {
    isCaller = false;
    callId = callCodeInput.value.trim();
    if (!callId) return alert("Enter a call code.");

    await getMedia();

    const callRef = db.ref(`calls/${callId}`);
    const callSnap = await callRef.once("value");
    const callData = callSnap.val();

    const offerDesc = new RTCSessionDescription(JSON.parse(callData.offer));
    await pc.setRemoteDescription(offerDesc);

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    await callRef.update({
      answer: JSON.stringify(answer)
    });

    // Listen for caller ICE
    db.ref(`calls/${callId}/candidates/caller`).on("child_added", async snap => {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(snap.val()));
      } catch (e) {
        console.error("ICE error (caller):", e);
      }
    });
  }
</script>
</body>
</html>

